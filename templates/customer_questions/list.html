{% extends 'base.html' %}

{% block title %}Müşteri Soruları{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1>Müşteri Soruları</h1>
            <p class="text-muted">Trendyol'dan gelen müşteri sorularını görüntüle ve yanıtla</p>
        </div>
        <div class="col-md-4 text-end">
            <form action="{{ url_for('customer_questions.fetch_questions_route') }}" method="POST">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-sync-alt"></i> Trendyol'dan Soruları Çek
                </button>
            </form>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs">
                <li class="nav-item">
                    <a class="nav-link {{ 'active' if current_status == 'all' else '' }}" 
                       href="{{ url_for('customer_questions.questions_list') }}">
                        Tümü
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {{ 'active' if current_status == 'WAITING_FOR_ANSWER' else '' }}" 
                       href="{{ url_for('customer_questions.questions_list', status='WAITING_FOR_ANSWER') }}">
                        Cevap Bekleyenler
                        {% set waiting_count = questions|selectattr('status', 'equalto', 'WAITING_FOR_ANSWER')|list|length %}
                        {% if waiting_count > 0 %}
                        <span class="badge bg-danger ms-1">{{ waiting_count }}</span>
                        {% endif %}
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {{ 'active' if current_status == 'WAITING_FOR_APPROVE' else '' }}" 
                       href="{{ url_for('customer_questions.questions_list', status='WAITING_FOR_APPROVE') }}">
                        Onay Bekleyenler
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {{ 'active' if current_status == 'ANSWERED' else '' }}" 
                       href="{{ url_for('customer_questions.questions_list', status='ANSWERED') }}">
                        Cevaplananlar
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {{ 'active' if current_status == 'REJECTED' else '' }}" 
                       href="{{ url_for('customer_questions.questions_list', status='REJECTED') }}">
                        Reddedilenler
                    </a>
                </li>
            </ul>
        </div>
        <div class="card-body">
            {% if questions %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Soru ID</th>
                            <th>Tarih</th>
                            <th>Ürün</th>
                            <th>Soru</th>
                            <th>Durum</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for question in questions %}
                        <tr class="{% if question.status == 'WAITING_FOR_ANSWER' %}table-danger{% elif question.status == 'WAITING_FOR_APPROVE' %}table-warning{% elif question.status == 'ANSWERED' %}table-success{% elif question.status == 'REJECTED' %}table-secondary{% endif %}">
                            <td>{{ question.question_id }}</td>
                            <td>{{ question.creation_date.strftime('%d.%m.%Y %H:%M') if question.creation_date else '' }}</td>
                            <td>
                                {% if question.image_url %}
                                <img src="{{ question.image_url }}" alt="{{ question.product_name }}" class="img-thumbnail" style="max-width: 50px;">
                                {% endif %}
                                <small>{{ question.product_name|truncate(30) }}</small>
                            </td>
                            <td>{{ question.text|truncate(50) }}</td>
                            <td>
                                {% if question.status == 'WAITING_FOR_ANSWER' %}
                                <span class="badge bg-danger">Cevap Bekliyor</span>
                                {% elif question.status == 'WAITING_FOR_APPROVE' %}
                                <span class="badge bg-warning text-dark">Onay Bekliyor</span>
                                {% elif question.status == 'ANSWERED' %}
                                <span class="badge bg-success">Cevaplandı</span>
                                {% elif question.status == 'REJECTED' %}
                                <span class="badge bg-secondary">Reddedildi</span>
                                {% elif question.status == 'REPORTED' %}
                                <span class="badge bg-info">Raporlandı</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ question.status }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if question.status == 'WAITING_FOR_ANSWER' %}
                                <a href="{{ url_for('customer_questions.answer_question', question_id=question.question_id) }}" class="btn btn-sm btn-primary">
                                    <i class="fas fa-reply"></i> Cevapla
                                </a>
                                {% else %}
                                <a href="{{ url_for('customer_questions.get_question_by_id', question_id=question.question_id) }}" class="btn btn-sm btn-info">
                                    <i class="fas fa-eye"></i> Detay
                                </a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info">
                Görüntülenecek soru bulunmuyor. Trendyol'dan soruları çekmek için yukarıdaki butonu kullanabilirsiniz.
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}