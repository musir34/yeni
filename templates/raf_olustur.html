<!doctype html>
<html lang="tr">
    <head>
        <meta charset="UTF-8" />
        <title>Raf Yönetimi – Güllü Ayakkabı</title>
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
        />

        <style>
            :root {
                --color-primary: #b76e79;
                --color-primary-dark: #a05f6a;
                --color-secondary: #212529;
                --color-text: #343a40;
                --color-bg: #f8f9fa;
                --color-bg-light: #ffffff;
                --color-white: #fff;
                --color-border: #dee2e6;
                --font-family-base: "Inter", sans-serif;
                --border-radius: 0.5rem;
                --shadow-md: 0 5px 15px rgba(0, 0, 0, 0.08);
                --transition: all 0.25s ease-in-out;
            }
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }
            body {
                font-family: var(--font-family-base);
                background-color: var(--color-bg);
                color: var(--color-text);
                padding: 2rem;
            }
            .container {
                max-width: 1200px;
                margin: auto;
            }
            h1 {
                text-align: center;
                color: var(--color-secondary);
                margin-bottom: 2rem;
                font-weight: 700;
            }
            .header-actions {
                display: flex;
                justify-content: center;
                gap: 1rem;
                margin-bottom: 2rem;
                flex-wrap: wrap;
            }
            .btn {
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.6rem 1.2rem;
                font-weight: 600;
                font-size: 0.9rem;
                border: none;
                border-radius: var(--border-radius);
                text-decoration: none;
                cursor: pointer;
                transition: var(--transition);
            }
            .btn-sm {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
            .btn-primary {
                background: linear-gradient(
                    45deg,
                    var(--color-primary),
                    var(--color-primary-dark)
                );
                color: white;
            }
            .btn-secondary {
                background-color: var(--color-secondary);
                color: white;
            }
            .btn-danger {
                background-color: #dc3545;
                color: white;
            }
            .btn:hover {
                opacity: 0.9;
                transform: translateY(-1px);
            }
            .main-card {
                background-color: var(--color-white);
                padding: 2rem;
                border-radius: var(--border-radius);
                box-shadow: var(--shadow-md);
                margin-bottom: 2rem;
            }
            input[type="text"],
            input[type="number"] {
                width: 100%;
                padding: 0.7rem 1rem;
                border: 1px solid var(--color-border);
                border-radius: var(--border-radius);
                font-size: 1rem;
            }
            .form-inline {
                display: flex;
                gap: 1rem;
                align-items: center;
            }
            .form-inline input {
                margin-bottom: 0;
            }
            .form-inline > div {
                flex-grow: 1;
            }
            .text-muted {
                color: #6c757d;
            }
            .mt-3 {
                margin-top: 1rem;
            }
            .mb-4 {
                margin-bottom: 1.5rem;
            }
            .text-center {
                text-align: center;
            }
            .collapsible-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 1rem;
                background-color: var(--color-bg);
                border: 1px solid var(--color-border);
                border-radius: var(--border-radius);
                cursor: pointer;
                transition: var(--transition);
            }
            .collapsible-header:hover {
                background-color: #e9ecef;
            }
            .collapsible-header h3,
            .collapsible-header h4 {
                margin: 0;
                font-weight: 600;
            }
            .collapsible-content {
                display: none;
                padding: 1rem;
                padding-left: 2.5rem;
                border: 1px solid var(--color-border);
                border-top: none;
                border-bottom-left-radius: var(--border-radius);
                border-bottom-right-radius: var(--border-radius);
            }
            .ana-raf-grup,
            .ikincil-raf-grup {
                margin-bottom: 1rem;
            }
            .kat-item {
                padding: 1rem;
                border: 1px solid var(--color-border);
                border-radius: var(--border-radius);
                margin-bottom: 1rem;
                background-color: #fff;
            }
            .kat-item-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .kat-item-header h5 {
                font-weight: 600;
                color: var(--color-primary-dark);
                margin: 0;
            }
            .stok-listesi-container {
                display: none;
                background-color: #fff;
                padding: 1rem;
                margin-top: 1rem;
                border-top: 2px solid var(--color-bg);
            }
            .stok-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 1rem;
            }
            .stok-table th,
            .stok-table td {
                border: 1px solid var(--color-border);
                padding: 0.75rem;
                text-align: left;
                vertical-align: middle;
                font-size: 0.9rem;
            }
            .stok-table thead {
                background-color: var(--color-bg);
            }
            .stok-table th {
                font-weight: 600;
            }
            .stok-table input[type="number"] {
                width: 70px;
                padding: 0.4rem;
                margin-bottom: 0;
                display: inline-block;
            }
            .stok-table .actions-form {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>📦 Raf Yönetimi</h1>
            <div class="header-actions">
                <a href="{{ url_for('home.home') }}" class="btn btn-secondary"
                    ><i class="bi bi-house-door"></i> Ana Sayfa</a
                >
                <a href="{{ url_for('raf.stok_form') }}" class="btn btn-primary"
                    ><i class="bi bi-plus-circle"></i> Stok Ekle</a
                >
            </div>
            <div class="main-card">
                <h4 class="mb-4">Yeni Raf Oluştur</h4>
                <form id="rafForm" class="form-inline">
                    <input
                        type="text"
                        name="ana"
                        placeholder="Ana Kod (Örn: A)"
                        required
                    />
                    <input
                        type="text"
                        name="ikincil"
                        placeholder="İkincil Kod (Örn: 01)"
                        required
                    />
                    <input
                        type="number"
                        name="kat"
                        placeholder="Kat (Örn: 1)"
                        required
                    />
                    <button
                        type="submit"
                        class="btn btn-primary"
                        style="padding-top: 0.7rem; padding-bottom: 0.7rem"
                    >
                        <i class="bi bi-plus-circle"></i> Oluştur
                    </button>
                </form>
                <div id="rafSonuc" class="mt-3"></div>
            </div>
            <div class="main-card">
                <h4 class="mb-4">🗂 Mevcut Raflar</h4>
                <div class="mb-3">
                    <input
                        type="text"
                        id="rafAramaInput"
                        class="form-control"
                        placeholder="🔍 Ana raf, ikincil raf veya kat ara..."
                    />
                </div>
                <div id="rafListesiYeri"></div>
                <p
                    id="rafYokMesaji"
                    class="text-muted text-center mt-3"
                    style="display: none"
                >
                    Kayıtlı raf bulunamadı.
                </p>
            </div>
        </div>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                async function raflariGetir() {
                    const container = document.getElementById("rafListesiYeri");
                    container.innerHTML =
                        '<p class="text-muted text-center">Yükleniyor...</p>';
                    try {
                        const res = await fetch("/raf/api/kademeli-liste");
                        const data = await res.json();
                        container.innerHTML = "";
                        const anaRaflar = Object.keys(data).sort();
                        if (anaRaflar.length === 0) {
                            document.getElementById(
                                "rafYokMesaji",
                            ).style.display = "block";
                            return;
                        }
                        document.getElementById("rafYokMesaji").style.display =
                            "none";
                        anaRaflar.forEach((anaKod) => {
                            const anaGrupDiv = document.createElement("div");
                            anaGrupDiv.className = "ana-raf-grup";
                            anaGrupDiv.setAttribute(
                                "data-search-text",
                                anaKod.toLowerCase(),
                            );
                            const anaHeader = document.createElement("div");
                            anaHeader.className = "collapsible-header";
                            anaHeader.innerHTML = `<h3><i class="bi bi-folder"></i> Ana Raf: ${anaKod}</h3><i class="bi bi-chevron-down collapse-icon"></i>`;
                            const anaContent = document.createElement("div");
                            anaContent.className = "collapsible-content";
                            const ikincilRaflar = Object.keys(
                                data[anaKod],
                            ).sort();
                            ikincilRaflar.forEach((ikincilKod) => {
                                const ikincilGrupDiv =
                                    document.createElement("div");
                                ikincilGrupDiv.className = "ikincil-raf-grup";
                                ikincilGrupDiv.setAttribute(
                                    "data-search-text",
                                    `${anaKod.toLowerCase()} ${ikincilKod.toLowerCase()}`,
                                );
                                const ikincilHeader =
                                    document.createElement("div");
                                ikincilHeader.className = "collapsible-header";
                                ikincilHeader.innerHTML = `<h4><i class="bi bi-collection"></i> ${ikincilKod}</h4><i class="bi bi-chevron-down collapse-icon"></i>`;
                                const ikincilContent =
                                    document.createElement("div");
                                ikincilContent.className =
                                    "collapsible-content";
                                const katlar = data[anaKod][ikincilKod].sort(
                                    (a, b) =>
                                        a.kat.localeCompare(b.kat, undefined, {
                                            numeric: true,
                                        }),
                                );
                                katlar.forEach((katObj) => {
                                    const tamRafKodu = `${ikincilKod}-${katObj.kat}`;
                                    const katDiv =
                                        document.createElement("div");
                                    katDiv.className = "kat-item";
                                    katDiv.setAttribute(
                                        "data-search-text",
                                        `${anaKod.toLowerCase()} ${ikincilKod.toLowerCase()} ${katObj.kat.toLowerCase()}`,
                                    );

                                    // Yazdır butonu artık en başından itibaren aktif ve basit
                                    katDiv.innerHTML = `
                            <div class="kat-item-header">
                                <h5><i class="bi bi-layers-fill"></i> Kat: ${katObj.kat} (Kod: ${tamRafKodu})</h5>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-secondary btn-sm" onclick="yazdirRafEtiketi('${tamRafKodu}')">
                                        <i class="bi bi-printer"></i> Yazdır
                                    </button>
                                    <button class="btn btn-primary btn-sm" onclick="stoklariGoster('${tamRafKodu}', this)">
                                        <i class="bi bi-box-seam"></i> Stokları Göster
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="rafiSil('${tamRafKodu}')">
                                        <i class="bi bi-trash"></i> Sil
                                    </button>
                                </div>
                            </div>
                            <div class="stok-listesi-container" id="stok-listesi-${tamRafKodu}"></div>
                        `;

                                    ikincilContent.appendChild(katDiv);
                                });
                                ikincilGrupDiv.appendChild(ikincilHeader);
                                ikincilGrupDiv.appendChild(ikincilContent);
                                anaContent.appendChild(ikincilGrupDiv);
                                ikincilHeader.addEventListener("click", () =>
                                    toggleCollapse(
                                        ikincilContent,
                                        ikincilHeader.querySelector(
                                            ".collapse-icon",
                                        ),
                                    ),
                                );
                            });
                            anaGrupDiv.appendChild(anaHeader);
                            anaGrupDiv.appendChild(anaContent);
                            container.appendChild(anaGrupDiv);
                            anaHeader.addEventListener("click", () =>
                                toggleCollapse(
                                    anaContent,
                                    anaHeader.querySelector(".collapse-icon"),
                                ),
                            );
                        });
                    } catch (err) {
                        console.error("Raflar çekilemedi:", err);
                        container.innerHTML =
                            '<p style="color:red" class="text-center">Raflar yüklenirken bir hata oluştu.</p>';
                    }
                }

                document
                    .getElementById("rafAramaInput")
                    .addEventListener("input", function () {
                        const arama = this.value.toLowerCase().trim();
                        document
                            .querySelectorAll(".kat-item")
                            .forEach((item) => {
                                item.style.display = item
                                    .getAttribute("data-search-text")
                                    .includes(arama)
                                    ? "block"
                                    : "none";
                            });
                        document
                            .querySelectorAll(".ikincil-raf-grup")
                            .forEach((grup) => {
                                const gorunurKatVar = grup.querySelector(
                                    '.kat-item[style*="display: block"]',
                                );
                                grup.style.display =
                                    grup
                                        .getAttribute("data-search-text")
                                        .includes(arama) || gorunurKatVar
                                        ? "block"
                                        : "none";
                            });
                        document
                            .querySelectorAll(".ana-raf-grup")
                            .forEach((grup) => {
                                const gorunurIkincilVar = grup.querySelector(
                                    '.ikincil-raf-grup[style*="display: block"]',
                                );
                                grup.style.display =
                                    grup
                                        .getAttribute("data-search-text")
                                        .includes(arama) || gorunurIkincilVar
                                        ? "block"
                                        : "none";
                            });
                    });

                document
                    .getElementById("rafForm")
                    .addEventListener("submit", async function (e) {
                        e.preventDefault();
                        const formData = new FormData(this);
                        const data = {
                            ana: formData.get("ana"),
                            ikincil: formData.get("ikincil"),
                            kat: formData.get("kat"),
                        };
                        const res = await fetch("/raf/olustur", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(data),
                        });
                        const result = await res.json();
                        const sonucDiv = document.getElementById("rafSonuc");
                        if (res.status === 201) {
                            sonucDiv.innerHTML = `<p style="color:green;">✅ ${result.message} – ${result.kod}</p>`;
                            document.getElementById("rafForm").reset();
                            raflariGetir();
                        } else {
                            sonucDiv.innerHTML = `<p style="color:red;">❌ ${result.error || "Bir hata oluştu."}</p>`;
                        }
                        setTimeout(() => {
                            sonucDiv.innerHTML = "";
                        }, 3000);
                    });

                raflariGetir();
            });

            function toggleCollapse(contentElement, iconElement) {
                const isVisible = contentElement.style.display === "block";
                contentElement.style.display = isVisible ? "none" : "block";
                if (iconElement) {
                    iconElement.classList.toggle("bi-chevron-down", isVisible);
                    iconElement.classList.toggle("bi-chevron-up", !isVisible);
                }
            }

            async function stoklariGoster(rafKodu, button) {
                const container = document.getElementById(
                    `stok-listesi-${rafKodu}`,
                );
                const isVisible = container.style.display === "block";
                document
                    .querySelectorAll(".stok-listesi-container")
                    .forEach((c) => {
                        if (c.id !== container.id) c.style.display = "none";
                    });
                document
                    .querySelectorAll(".kat-item-header .btn-primary")
                    .forEach((b) => {
                        if (b !== button)
                            b.innerHTML =
                                '<i class="bi bi-box-seam"></i> Stokları Göster';
                    });
                if (isVisible) {
                    container.style.display = "none";
                    button.innerHTML =
                        '<i class="bi bi-box-seam"></i> Stokları Göster';
                } else {
                    button.innerHTML =
                        '<i class="bi bi-arrow-clockwise"></i> Yükleniyor...';
                    button.disabled = true;
                    try {
                        const res = await fetch(`/raf/api/stoklar/${rafKodu}`);
                        const stoklar = await res.json();
                        let content = `
                <input type="text" placeholder="Bu raftaki ürünleri filtrele..." onkeyup="stokAra(this, '${rafKodu}')" style="margin-bottom: 1rem; padding: 0.5rem; font-size: 0.9rem; width:100%;">
                <div style="overflow-x:auto;">
                    <table class="stok-table" id="table-${rafKodu}">
                        <thead><tr><th>Model</th><th>Renk</th><th>Beden</th><th>Adet</th><th>İşlem</th></tr></thead>
                        <tbody>`;
                        if (stoklar.length > 0) {
                            stoklar.forEach((urun) => {
                                content += `
                        <tr data-search="${(urun.model + " " + urun.color + " " + urun.barkod).toLowerCase()}">
                            <td>${urun.model}</td><td>${urun.color}</td><td>${urun.size}</td><td>${urun.adet}</td>
                            <td>
                                <div class="actions-form">
                                    <form method="post" action="/raf/stok-guncelle" style="display:inline-flex; gap: 0.5rem; align-items: center;">
                                        <input type="hidden" name="raf_kodu" value="${rafKodu}"><input type="hidden" name="barkod" value="${urun.barkod}">
                                        <input type="number" name="adet" value="${urun.adet}" min="0">
                                        <button type="submit" class="btn btn-primary btn-sm">Güncelle</button>
                                    </form>
                                    <form method="post" action="/raf/stok-sil" style="display:inline-block;">
                                        <input type="hidden" name="raf_kodu" value="${rafKodu}"><input type="hidden" name="barkod" value="${urun.barkod}">
                                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Bu ürünü raftan silmek istediğine emin misin?')"><i class="bi bi-trash"></i></button>
                                    </form>
                                </div>
                            </td>
                        </tr>`;
                            });
                        } else {
                            content +=
                                '<tr><td colspan="5" class="text-center text-muted">Bu rafta hiç ürün bulunmuyor.</td></tr>';
                        }
                        content += "</tbody></table></div>";
                        container.innerHTML = content;
                        container.style.display = "block";
                        button.innerHTML =
                            '<i class="bi bi-eye-slash"></i> Stokları Gizle';
                    } catch (err) {
                        console.error("Stoklar çekilemedi:", err);
                        container.innerHTML = `<p style="color:red">Stoklar yüklenemedi.</p>`;
                    } finally {
                        button.disabled = false;
                    }
                }
            }

            function stokAra(input, rafKodu) {
                const filter = input.value.toLowerCase();
                const table = document.getElementById(`table-${rafKodu}`);
                const rows = table.getElementsByTagName("tr");
                for (let i = 1; i < rows.length; i++) {
                    const searchData = rows[i].getAttribute("data-search");
                    if (searchData) {
                        rows[i].style.display = searchData.includes(filter)
                            ? ""
                            : "none";
                    }
                }
            }

            async function rafiSil(rafKodu) {
                if (
                    !confirm(
                        `'${rafKodu}' kodlu rafı ve içindeki TÜM ürünleri kalıcı olarak silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!`,
                    )
                ) {
                    return;
                }
                try {
                    const res = await fetch(`/raf/sil/${rafKodu}`, {
                        method: "POST",
                    });
                    const result = await res.json();
                    const sonucDiv = document.getElementById("rafSonuc");
                    if (res.ok) {
                        sonucDiv.innerHTML = `<p style="color:green;">✅ ${result.message}</p>`;
                        raflariGetir();
                    } else {
                        sonucDiv.innerHTML = `<p style="color:red;">❌ Hata: ${result.error || "Raf silinirken bir sorun oluştu."}</p>`;
                    }
                    setTimeout(() => {
                        sonucDiv.innerHTML = "";
                    }, 4000);
                } catch (error) {
                    console.error("Raf silme hatası:", error);
                    document.getElementById("rafSonuc").innerHTML =
                        `<p style="color:red;">❌ Bir ağ hatası oluştu.</p>`;
                }
            }

            // YAZDIRMA FONKSİYONU (BACKEND DESTEKLİ, BASİT VE GÜVENİLİR YÖNTEM)
            function yazdirRafEtiketi(rafKodu) {
                const printWindow = window.open("", "_blank");
                printWindow.document.write(`
        <html>
            <head>
                <title>Raf Etiketi Yazdır - ${rafKodu}</title>
                <style>
                    @page { size: 100mm 100mm; margin: 0; }
                    body { 
                        width: 70mm;
                        height: 40mm;
                        margin: 0;
                        padding: 0;
                        font-family: Arial, sans-serif;
                        display: flex;
                        flex-direction: column; 
                        align-items: center;    
                        justify-content: center;
                        box-sizing: border-box; 
                        padding: 5mm;
                        gap: 4mm;
                    }
                    .raf-kodu {
                        font-size: 28pt;
                        font-weight: bold;
                        margin: 0;
                        text-align: center;
                        flex-shrink: 0;
                    }
                    .gorsel-alani {
                        width: 100%;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        gap: 2mm;
                    }
                    img {
                        max-width: 100mm; /* Taşmaları engellemek için */
                    }
                    #qr-image {
                        max-width: 45mm;
                        max-height: 45mm;
                    }
                    
                </style>
            </head>
            <body>
                <div class="raf-kodu">${rafKodu}</div>
                <div class="gorsel-alani">
                    <img id="qr-image" src="/raf/etiket/qr/${rafKodu}">
                </div>
                <script>
                    window.onload = function() {
                        // Backend'den resimlerin yüklenmesini beklemek için küçük bir gecikme
                        setTimeout(function() {
                            window.print();
                        }, 250); // Gecikmeyi biraz artırarak garantiye alalım

                        window.onafterprint = function() {
                           window.close();
                        }
                    }
                <\/script>
            </body>
        </html>
    `);
                printWindow.document.close();
            }
        </script>
    </body>
</html>
