<!doctype html>
<html lang="tr">
	<head>
		<meta charset="UTF-8" />
		<title>Raf YÃ¶netimi â€“ GÃ¼llÃ¼ AyakkabÄ±</title>
		<link
			href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
			rel="stylesheet"
		/>
		<link
			rel="stylesheet"
			href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
		/>

		<style>
			:root {
				--color-primary: #b76e79;
				--color-primary-dark: #a05f6a;
				--color-secondary: #212529;
				--color-text: #343a40;
				--color-bg: #f8f9fa;
				--color-bg-light: #ffffff;
				--color-white: #fff;
				--color-border: #dee2e6;
				--font-family-base: "Inter", sans-serif;
				--border-radius: 0.5rem;
				--shadow-md: 0 5px 15px rgba(0, 0, 0, 0.08);
				--transition: all 0.25s ease-in-out;
			}
			* {
				box-sizing: border-box;
				margin: 0;
				padding: 0;
			}
			body {
				font-family: var(--font-family-base);
				background-color: var(--color-bg);
				color: var(--color-text);
				padding: 2rem;
			}
			.container {
				max-width: 1200px;
				margin: auto;
			}
			h1 {
				text-align: center;
				color: var(--color-secondary);
				margin-bottom: 2rem;
				font-weight: 700;
			}
			.header-actions {
				display: flex;
				justify-content: center;
				gap: 1rem;
				margin-bottom: 2rem;
				flex-wrap: wrap;
			}
			.btn {
				display: inline-flex;
				align-items: center;
				gap: 0.5rem;
				padding: 0.6rem 1.2rem;
				font-weight: 600;
				font-size: 0.9rem;
				border: none;
				border-radius: var(--border-radius);
				text-decoration: none;
				cursor: pointer;
				transition: var(--transition);
			}
			.btn-sm {
				padding: 0.4rem 0.8rem;
				font-size: 0.8rem;
			}
			.btn-primary {
				background: linear-gradient(
					45deg,
					var(--color-primary),
					var(--color-primary-dark)
				);
				color: white;
			}
			.btn-secondary {
				background-color: var(--color-secondary);
				color: white;
			}
			.btn-danger {
				background-color: #dc3545;
				color: white;
			}
			.btn:hover {
				opacity: 0.9;
				transform: translateY(-1px);
			}
			.main-card {
				background-color: var(--color-white);
				padding: 2rem;
				border-radius: var(--border-radius);
				box-shadow: var(--shadow-md);
				margin-bottom: 2rem;
			}
			input[type="text"],
			input[type="number"] {
				width: 100%;
				padding: 0.7rem 1rem;
				border: 1px solid var(--color-border);
				border-radius: var(--border-radius);
				font-size: 1rem;
			}
			.form-inline {
				display: flex;
				gap: 1rem;
				align-items: center;
			}
			.form-inline input {
				margin-bottom: 0;
			}
			.form-inline > div {
				flex-grow: 1;
			}
			.text-muted {
				color: #6c757d;
			}
			.mt-3 {
				margin-top: 1rem;
			}
			.mb-4 {
				margin-bottom: 1.5rem;
			}
			.text-center {
				text-align: center;
			}
			.collapsible-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				padding: 1rem;
				background-color: var(--color-bg);
				border: 1px solid var(--color-border);
				border-radius: var(--border-radius);
				cursor: pointer;
				transition: var(--transition);
			}
			.collapsible-header:hover {
				background-color: #e9ecef;
			}
			.collapsible-header h3,
			.collapsible-header h4 {
				margin: 0;
				font-weight: 600;
			}
			.collapsible-content {
				display: none;
				padding: 1rem;
				padding-left: 2.5rem;
				border: 1px solid var(--color-border);
				border-top: none;
				border-bottom-left-radius: var(--border-radius);
				border-bottom-right-radius: var(--border-radius);
			}
			.ana-raf-grup,
			.ikincil-raf-grup {
				margin-bottom: 1rem;
			}
			.kat-item {
				padding: 1rem;
				border: 1px solid var(--color-border);
				border-radius: var(--border-radius);
				margin-bottom: 1rem;
				background-color: #fff;
			}
			.kat-item-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
			}
			.kat-item-header h5 {
				font-weight: 600;
				color: var(--color-primary-dark);
				margin: 0;
			}
			.stok-listesi-container {
				display: none;
				background-color: #fff;
				padding: 1rem;
				margin-top: 1rem;
				border-top: 2px solid var(--color-bg);
			}
			.stok-table {
				width: 100%;
				border-collapse: collapse;
				margin-top: 1rem;
			}
			.stok-table th,
			.stok-table td {
				border: 1px solid var(--color-border);
				padding: 0.75rem;
				text-align: left;
				vertical-align: middle;
				font-size: 0.9rem;
			}
			.stok-table thead {
				background-color: var(--color-bg);
			}
			.stok-table th {
				font-weight: 600;
			}
			.stok-table input[type="number"] {
				width: 70px;
				padding: 0.4rem;
				margin-bottom: 0;
				display: inline-block;
			}
			.stok-table .actions-form {
				display: flex;
				align-items: center;
				gap: 0.5rem;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<h1>ğŸ“¦ Raf YÃ¶netimi</h1>
			<div class="header-actions">
				<a href="{{ url_for('home.home') }}" class="btn btn-secondary"
					><i class="bi bi-house-door"></i> Ana Sayfa</a
				>
				<a href="{{ url_for('raf.stok_form') }}" class="btn btn-primary"
					><i class="bi bi-plus-circle"></i> Stok Ekle</a
				>
			</div>

			<div
				class="main-card"
				style="border-left: 5px solid #b76e79; background: #fff8f9"
			>
				<h4>ğŸ“Œ Sistem MantÄ±ÄŸÄ± â€“ Notlar</h4>
				<ul style="margin-top: 1rem; line-height: 1.6">
					<li>
						<b>ğŸ“¦ Raf â†’ ÃœrÃ¼n:</b> Her Ã¼rÃ¼n belirli bir rafta tutulur. <br />
						Raf kodlarÄ± <code>ANA-Ä°KÄ°NCÄ°L-KAT</code> formatÄ±ndadÄ±r (Ã¶r:
						<code>A-01-02</code>).
					</li>
					<li>
						<b>ğŸ” Barkod Arama:</b> Barkod okutulduÄŸunda sistem hangi raflarda
						Ã¼rÃ¼n olduÄŸunu listeler.
					</li>
					<li>
						<b>âœï¸ GÃ¼ncelleme:</b> Raf iÃ§indeki adet gÃ¼ncellendiÄŸinde sadece o
						rafÄ±n stoÄŸu deÄŸiÅŸir. EÄŸer
						<b>Ã¼rÃ¼n raftan tamamen silinirse</b>, <u>CentralStock</u> (merkezi
						stok) da aynÄ± miktarda azalÄ±r.
					</li>
					<li>
						<b>ğŸ“Š CentralStock:</b> TÃ¼m raflarÄ±n toplamÄ±dÄ±r. Her iÅŸlemde paralel
						gÃ¼ncellenir.
					</li>
					<li>
						<b>ğŸš« Eksik/yanlÄ±ÅŸ barkod:</b> DoÄŸrulama geÃ§mezse stok dÃ¼ÅŸmez. Yani
						<u>barkod okutulmadan stok dÃ¼ÅŸmez</u>.
					</li>
					<li>
						<b>ğŸ—‘ Raf Sil:</b> Bir raf silinirse, iÃ§indeki tÃ¼m Ã¼rÃ¼nler de
						silinir. CentralStockâ€™tan dÃ¼ÅŸÃ¼lÃ¼r.
					</li>
					<li>
						<b>ğŸ–¨ Etiket:</b> Her raf iÃ§in anlÄ±k QR ve barkod etiketi
						yazdÄ±rÄ±labilir.
					</li>
				</ul>
				<p
					style="
						margin-top: 1rem;
						font-size: 0.9rem;
						color: #6c757d;
					"
				>
					<i class="bi bi-info-circle"></i> <b>HatÄ±rlatma:</b>
					- SipariÅŸ onayÄ±nda stok <u>sipariÅŸ adedi</u> kadar dÃ¼ÅŸer, barkodlar
					sadece doÄŸrulama iÃ§indir. <br />
					- Raflarda gÃ¶rÃ¼nen stok = fiili durum; CentralStock = tÃ¼m raflarÄ±n
					toplamÄ±.
				</p>
			</div>

			<div class="main-card">
				<h4 class="mb-4">Yeni Raf OluÅŸtur</h4>
				<form id="rafForm" class="form-inline">
					<input
						type="text"
						name="ana"
						placeholder="Ana Kod (Ã–rn: A)"
						required
					/>
					<input
						type="text"
						name="ikincil"
						placeholder="Ä°kincil Kod (Ã–rn: 01)"
						required
					/>
					<input
						type="number"
						name="kat"
						placeholder="Kat (Ã–rn: 1)"
						required
					/>
					<button
						type="submit"
						class="btn btn-primary"
						style="padding-top: 0.7rem; padding-bottom: 0.7rem"
					>
						<i class="bi bi-plus-circle"></i> OluÅŸtur
					</button>
				</form>
				<div id="rafSonuc" class="mt-3"></div>
			</div>

			<div class="main-card">
				<h4>ğŸ” Barkod ile ÃœrÃ¼n Ara</h4>
				<form onsubmit="barkodAra(event)">
					<input
						type="text"
						id="barkodInput"
						placeholder="Barkod giriniz..."
						style="width: 100%; padding: 0.6rem"
						required
					/>
					<button
						type="submit"
						class="btn btn-primary"
						style="margin-top: 0.8rem"
					>
						<i class="bi bi-search"></i> Ara
					</button>
				</form>
				<div id="barkodSonuc" style="margin-top: 1rem"></div>
			</div>

			<div class="main-card">
				<h4 class="mb-4">ğŸ—‚ Mevcut Raflar</h4>
				<div class="mb-3">
					<input
						type="text"
						id="rafAramaInput"
						class="form-control"
						placeholder="ğŸ” Ana raf, ikincil raf veya kat ara..."
					/>
				</div>
				<div id="rafListesiYeri"></div>
				<p
					id="rafYokMesaji"
					class="text-muted text-center mt-3"
					style="display: none"
				>
					KayÄ±tlÄ± raf bulunamadÄ±.
				</p>
			</div>
		</div>

		<script>
			document.addEventListener("DOMContentLoaded", function () {
				async function raflariGetir() {
					const container = document.getElementById("rafListesiYeri");
					container.innerHTML =
						'<p class="text-muted text-center">YÃ¼kleniyor...</p>';
					try {
						const res = await fetch("/raf/api/kademeli-liste");
						const data = await res.json();
						container.innerHTML = "";
						const anaRaflar = Object.keys(data).sort();
						if (anaRaflar.length === 0) {
							document.getElementById(
								"rafYokMesaji",
							).style.display = "block";
							return;
						}
						document.getElementById("rafYokMesaji").style.display =
							"none";
						anaRaflar.forEach((anaKod) => {
							const anaGrupDiv = document.createElement("div");
							anaGrupDiv.className = "ana-raf-grup";
							anaGrupDiv.setAttribute(
								"data-search-text",
								anaKod.toLowerCase(),
							);
							const anaHeader = document.createElement("div");
							anaHeader.className = "collapsible-header";
							anaHeader.innerHTML = `<h3><i class="bi bi-folder"></i> Ana Raf: ${anaKod}</h3><i class="bi bi-chevron-down collapse-icon"></i>`;
							const anaContent = document.createElement("div");
							anaContent.className = "collapsible-content";
							const ikincilRaflar = Object.keys(
								data[anaKod],
							).sort();
							ikincilRaflar.forEach((ikincilKod) => {
								const ikincilGrupDiv =
									document.createElement("div");
								ikincilGrupDiv.className = "ikincil-raf-grup";
								ikincilGrupDiv.setAttribute(
									"data-search-text",
									`${anaKod.toLowerCase()} ${ikincilKod.toLowerCase()}`,
								);
								const ikincilHeader =
									document.createElement("div");
								ikincilHeader.className = "collapsible-header";
								ikincilHeader.innerHTML = `<h4><i class="bi bi-collection"></i> ${ikincilKod}</h4><i class="bi bi-chevron-down collapse-icon"></i>`;
								const ikincilContent =
									document.createElement("div");
								ikincilContent.className =
									"collapsible-content";
								const katlar = data[anaKod][ikincilKod].sort(
									(a, b) =>
										a.kat.localeCompare(b.kat, undefined, {
											numeric: true,
										}),
								);
								katlar.forEach((katObj) => {
									const tamRafKodu = `${ikincilKod}-${katObj.kat}`;
									const katDiv =
										document.createElement("div");
									katDiv.className = "kat-item";
									katDiv.setAttribute(
										"data-search-text",
										`${anaKod.toLowerCase()} ${ikincilKod.toLowerCase()} ${katObj.kat.toLowerCase()}`,
									);

									// YazdÄ±r butonu artÄ±k en baÅŸÄ±ndan itibaren aktif ve basit
									katDiv.innerHTML = `
                                <div class="kat-item-header">
                                    <h5><i class="bi bi-layers-fill"></i> Kat: ${katObj.kat} (Kod: ${tamRafKodu})</h5>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button class="btn btn-secondary btn-sm" onclick="yazdirRafEtiketi('${tamRafKodu}')">
                                            <i class="bi bi-printer"></i> YazdÄ±r
                                        </button>
                                        <button class="btn btn-primary btn-sm" onclick="stoklariGoster('${tamRafKodu}', this)">
                                            <i class="bi bi-box-seam"></i> StoklarÄ± GÃ¶ster
                                        </button>
                                        <button class="btn btn-danger btn-sm" onclick="rafiSil('${tamRafKodu}')">
                                            <i class="bi bi-trash"></i> Sil
                                        </button>
                                    </div>
                                </div>
                                <div class="stok-listesi-container" id="stok-listesi-${tamRafKodu}"></div>
                            `;

									ikincilContent.appendChild(katDiv);
								});
								ikincilGrupDiv.appendChild(ikincilHeader);
								ikincilGrupDiv.appendChild(ikincilContent);
								anaContent.appendChild(ikincilGrupDiv);
								ikincilHeader.addEventListener("click", () =>
									toggleCollapse(
										ikincilContent,
										ikincilHeader.querySelector(
											".collapse-icon",
										),
									),
								);
							});
							anaGrupDiv.appendChild(anaHeader);
							anaGrupDiv.appendChild(anaContent);
							container.appendChild(anaGrupDiv);
							anaHeader.addEventListener("click", () =>
								toggleCollapse(
									anaContent,
									anaHeader.querySelector(".collapse-icon"),
								),
							);
						});
					} catch (err) {
						console.error("Raflar Ã§ekilemedi:", err);
						container.innerHTML =
							'<p style="color:red" class="text-center">Raflar yÃ¼klenirken bir hata oluÅŸtu.</p>';
					}
				}

				document
					.getElementById("rafAramaInput")
					.addEventListener("input", function () {
						const arama = this.value.toLowerCase().trim();
						document
							.querySelectorAll(".kat-item")
							.forEach((item) => {
								item.style.display = item
									.getAttribute("data-search-text")
									.includes(arama)
									? "block"
									: "none";
							});
						document
							.querySelectorAll(".ikincil-raf-grup")
							.forEach((grup) => {
								const gorunurKatVar = grup.querySelector(
									'.kat-item[style*="display: block"]',
								);
								grup.style.display =
									grup
										.getAttribute("data-search-text")
										.includes(arama) || gorunurKatVar
										? "block"
										: "none";
							});
						document
							.querySelectorAll(".ana-raf-grup")
							.forEach((grup) => {
								const gorunurIkincilVar = grup.querySelector(
									'.ikincil-raf-grup[style*="display: block"]',
								);
								grup.style.display =
									grup
										.getAttribute("data-search-text")
										.includes(arama) || gorunurIkincilVar
										? "block"
										: "none";
							});
					});

				document
					.getElementById("rafForm")
					.addEventListener("submit", async function (e) {
						e.preventDefault();
						const formData = new FormData(this);
						const data = {
							ana: formData.get("ana"),
							ikincil: formData.get("ikincil"),
							kat: formData.get("kat"),
						};
						const res = await fetch("/raf/olustur", {
							method: "POST",
							headers: { "Content-Type": "application/json" },
							body: JSON.stringify(data),
						});
						const result = await res.json();
						const sonucDiv = document.getElementById("rafSonuc");
						if (res.status === 201) {
							sonucDiv.innerHTML = `<p style="color:green;">âœ… ${result.message} â€“ ${result.kod}</p>`;
							document.getElementById("rafForm").reset();
							raflariGetir();
						} else {
							sonucDiv.innerHTML = `<p style="color:red;">âŒ ${result.error || "Bir hata oluÅŸtu."}</p>`;
						}
						setTimeout(() => {
							sonucDiv.innerHTML = "";
						}, 3000);
					});

				raflariGetir();
			});

			function toggleCollapse(contentElement, iconElement) {
				const isVisible = contentElement.style.display === "block";
				contentElement.style.display = isVisible ? "none" : "block";
				if (iconElement) {
					iconElement.classList.toggle("bi-chevron-down", isVisible);
					iconElement.classList.toggle("bi-chevron-up", !isVisible);
				}
			}

			async function stoklariGoster(rafKodu, button) {
				const container = document.getElementById(
					`stok-listesi-${rafKodu}`,
				);
				const isVisible = container.style.display === "block";
				document
					.querySelectorAll(".stok-listesi-container")
					.forEach((c) => {
						if (c.id !== container.id) c.style.display = "none";
					});
				document
					.querySelectorAll(".kat-item-header .btn-primary")
					.forEach((b) => {
						if (b !== button)
							b.innerHTML =
								'<i class="bi bi-box-seam"></i> StoklarÄ± GÃ¶ster';
					});
				if (isVisible) {
					container.style.display = "none";
					button.innerHTML =
						'<i class="bi bi-box-seam"></i> StoklarÄ± GÃ¶ster';
				} else {
					button.innerHTML =
						'<i class="bi bi-arrow-clockwise"></i> YÃ¼kleniyor...';
					button.disabled = true;
					try {
						const res = await fetch(`/raf/api/stoklar/${rafKodu}`);
						const stoklar = await res.json();
						let content = `
                        <input type="text" placeholder="Bu raftaki Ã¼rÃ¼nleri filtrele..." onkeyup="stokAra(this, '${rafKodu}')" style="margin-bottom: 1rem; padding: 0.5rem; font-size: 0.9rem; width:100%;">
                        <div style="overflow-x:auto;">
                            <table class="stok-table" id="table-${rafKodu}">
                                <thead><tr><th>Model</th><th>Renk</th><th>Beden</th><th>Adet</th><th>Ä°ÅŸlem</th></tr></thead>
                                <tbody>`;
						if (stoklar.length > 0) {
							stoklar.forEach((urun) => {
								content += `
                            <tr data-search="${(urun.model + " " + urun.color + " " + urun.barkod).toLowerCase()}">
                                <td>${urun.model}</td><td>${urun.color}</td><td>${urun.size}</td><td>${urun.adet}</td>
                                <td>
                                    <div class="actions-form">
                                        <form method="post" action="/raf/stok-guncelle" style="display:inline-flex; gap: 0.5rem; align-items: center;">
                                            <input type="hidden" name="raf_kodu" value="${rafKodu}"><input type="hidden" name="barkod" value="${urun.barkod}">
                                            <input type="number" name="adet" value="${urun.adet}" min="0">
                                            <button type="submit" class="btn btn-primary btn-sm">GÃ¼ncelle</button>
                                        </form>
                                        <form method="post" action="/raf/stok-sil" style="display:inline-block;">
                                            <input type="hidden" name="raf_kodu" value="${rafKodu}"><input type="hidden" name="barkod" value="${urun.barkod}">
                                            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Bu Ã¼rÃ¼nÃ¼ raftan silmek istediÄŸine emin misin?')"><i class="bi bi-trash"></i></button>
                                        </form>
                                    </div>
                                </td>
                            </tr>`;
							});
						} else {
							content +=
								'<tr><td colspan="5" class="text-center text-muted">Bu rafta hiÃ§ Ã¼rÃ¼n bulunmuyor.</td></tr>';
						}
						content += "</tbody></table></div>";
						container.innerHTML = content;
						container.style.display = "block";
						button.innerHTML =
							'<i class="bi bi-eye-slash"></i> StoklarÄ± Gizle';
					} catch (err) {
						console.error("Stoklar Ã§ekilemedi:", err);
						container.innerHTML = `<p style="color:red">Stoklar yÃ¼klenemedi.</p>`;
					} finally {
						button.disabled = false;
					}
				}
			}

			function stokAra(input, rafKodu) {
				const filter = input.value.toLowerCase();
				const table = document.getElementById(`table-${rafKodu}`);
				const rows = table.getElementsByTagName("tr");
				for (let i = 1; i < rows.length; i++) {
					const searchData = rows[i].getAttribute("data-search");
					if (searchData) {
						rows[i].style.display = searchData.includes(filter)
							? ""
							: "none";
					}
				}
			}

			async function rafiSil(rafKodu) {
				if (
					!confirm(
						`'${rafKodu}' kodlu rafÄ± ve iÃ§indeki TÃœM Ã¼rÃ¼nleri kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz!`,
					)
				) {
					return;
				}
				try {
					const res = await fetch(`/raf/sil/${rafKodu}`, {
						method: "POST",
					});
					const result = await res.json();
					const sonucDiv = document.getElementById("rafSonuc");
					if (res.ok) {
						sonucDiv.innerHTML = `<p style="color:green;">âœ… ${result.message}</p>`;
						raflariGetir();
					} else {
						sonucDiv.innerHTML = `<p style="color:red;">âŒ Hata: ${result.error || "Raf silinirken bir sorun oluÅŸtu."}</p>`;
					}
					setTimeout(() => {
						sonucDiv.innerHTML = "";
					}, 4000);
				} catch (error) {
					console.error("Raf silme hatasÄ±:", error);
					document.getElementById("rafSonuc").innerHTML =
						`<p style="color:red;">âŒ Bir aÄŸ hatasÄ± oluÅŸtu.</p>`;
				}
			}

			// YAZDIRMA FONKSÄ°YONU (BACKEND DESTEKLÄ°, BASÄ°T VE GÃœVENÄ°LÄ°R YÃ–NTEM)
			function yazdirRafEtiketi(rafKodu) {
				const printWindow = window.open("", "_blank");
				printWindow.document.write(`
        <html>
            <head>
                <title>Raf Etiketi YazdÄ±r - ${rafKodu}</title>
                <style>
                    @page { size: 100mm 100mm; margin: 0; }
                    body { 
                        width: 100mm;
                        height: 100mm;
                        margin: 0;
                        padding: 0;
                        font-family: Arial, sans-serif;
                        display: flex;
                        flex-direction: column; 
                        align-items: center;    
                        justify-content: center;
                        box-sizing: border-box; 
                        padding: 5mm;
                        gap: 4mm;
                    }
                    .raf-kodu {
                        font-size: 28pt;
                        font-weight: bold;
                        margin: 0;
                        text-align: center;
                        flex-shrink: 0;
                    }
                    .gorsel-alani {
                        width: 100%;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        gap: 2mm;
                    }
                    img {
                        max-width: 85mm; /* TaÅŸmalarÄ± engellemek iÃ§in */
                    }
                    #qr-image {
                        max-width: 45mm;
                        max-height: 45mm;
                    }
                    #barcode-image {
                        max-width: 80mm;
                        max-height: 18mm;
                    }
                </style>
            </head>
            <body>
                <div class="raf-kodu">${rafKodu}</div>
                <div class="gorsel-alani">
                    <img id="qr-image" src="/raf/etiket/qr/${rafKodu}">
                    <img id="barcode-image" src="/raf/etiket/barkod/${rafKodu}">
                </div>
                <script>
                    window.onload = function() {
                        // Backend'den resimlerin yÃ¼klenmesini beklemek iÃ§in kÃ¼Ã§Ã¼k bir gecikme
                        setTimeout(function() {
                            window.print();
                        }, 250); // Gecikmeyi biraz artÄ±rarak garantiye alalÄ±m

                        window.onafterprint = function() {
                           window.close();
                        }
                    }
                <\/script>
            </body>
        </html>
    `);
				printWindow.document.close();
			}

			async function barkodAra(e) {
				e.preventDefault();
				const barkod = document.getElementById("barkodInput").value.trim();
				if (!barkod) return;

				const sonucDiv = document.getElementById("barkodSonuc");
				sonucDiv.innerHTML = "â³ AranÄ±yor...";

				try {
					const res = await fetch(`/raf/api/ara/${barkod}`);
					if (!res.ok) {
						sonucDiv.innerHTML =
							"<p style='color:red;'>ÃœrÃ¼n bulunamadÄ±.</p>";
						return;
					}
					const data = await res.json();
					let html = `<h5>ğŸ“¦ Barkod: ${data.barkod}</h5><ul>`;
					data.raflar.forEach((r) => {
						html += `<li>Raf: <b>${r.raf_kodu}</b> â€“ Adet: ${r.adet}</li>`;
					});
					html += "</ul>";
					sonucDiv.innerHTML = html;
				} catch (err) {
					sonucDiv.innerHTML = `<p style='color:red;'>Hata: ${err}</p>`;
				}
			}
		</script>
	</body>
</html>