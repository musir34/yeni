{% extends "base.html" %}

{% block content %}
<style>
  :root{
    --color-primary:#B76E79; --color-primary-dark:#A05F6A;
    --color-secondary:#212529; --color-text:#343a40;
    --color-bg:#f8f9fa; --color-white:#fff; --color-border:#dee2e6;
    --color-success:#28a745; --color-warning:#ffc107; --color-danger:#dc3545; --color-info:#0dcaf0;
    --font-family-base:'Inter',sans-serif; --border-radius:.5rem;
    --shadow-sm:0 1px 3px rgba(0,0,0,.04); --shadow-md:0 5px 15px rgba(0,0,0,.08);
    --transition:all .25s ease-in-out;
  }
  body{font-family:var(--font-family-base);background:var(--color-bg);color:var(--color-text)}
  .container-xl{max-width:1600px}
  h2{color:var(--color-secondary);font-weight:600}
  .btn{border-radius:var(--border-radius);font-weight:600;transition:var(--transition);border:none;padding:.6rem 1.2rem}
  .btn:hover{transform:translateY(-2px);box-shadow:var(--shadow-sm)}
  .btn-primary{background:var(--color-primary);color:#fff}.btn-primary:hover{background:var(--color-primary-dark)}
  .btn-secondary{background:var(--color-secondary);color:#fff}.btn-secondary:hover{background:#343a40}
  .btn-success{background:var(--color-success)}
  .btn-danger{background:var(--color-danger)}
  .btn-info{background:var(--color-info)}
  .btn-warning{background:var(--color-warning);color:var(--color-secondary)}
  
  .bg-orange{background:#fd7e14!important}
  .bg-cyan{background:#0dcaf0!important}
  .bg-purple{background:#6f42c1!important}
  
  .card{border:none;border-radius:var(--border-radius);box-shadow:var(--shadow-sm);transition:var(--transition);animation:fadeIn .5s}
  .card:hover{transform:translateY(-5px);box-shadow:var(--shadow-md)}
  .card-header{background:var(--color-white);border-bottom:1px solid var(--color-border);font-weight:600}
  
  .filter-area{background:var(--color-white);padding:1.5rem;border-radius:var(--border-radius);box-shadow:var(--shadow-sm);margin-bottom:2rem}
  .form-control:focus,.form-select:focus{border-color:var(--color-primary);box-shadow:0 0 0 .25rem rgba(183,110,121,.25)}
  
  .status-select{font-weight:600;padding:.4rem .8rem;border-radius:var(--border-radius)}
  .status-yeni-sipariÅŸ{background:#007bff!important;color:white!important}
  .status-hazÄ±rlanÄ±yor{background:#fd7e14!important;color:white!important}
  .status-kargoya-hazÄ±r{background:#0dcaf0!important;color:white!important}
  .status-kargoda{background:#6f42c1!important;color:white!important}
  .status-teslim-edildi{background:#28a745!important;color:white!important}
  .status-iptal-edildi{background:#dc3545!important;color:white!important}
  
  @keyframes fadeIn{from{opacity:0;transform:translateY(15px)}to{opacity:1;transform:translateY(0)}}
</style>

<div class="container-xl mt-4 mb-5">
  <div class="text-center mb-4">
    <h2>
      <i class="bi bi-cart-check"></i> SipariÅŸler 
      <i class="bi bi-info-circle text-primary" style="cursor:pointer;font-size:0.8em" 
         onclick="document.getElementById('usageInfoModal').style.display='block'"
         data-bs-toggle="tooltip" title="NasÄ±l KullanÄ±lÄ±r?"></i>
    </h2>
    <p class="text-muted">Manuel olarak oluÅŸturulan sipariÅŸler</p>
  </div>
  
  <div class="text-center mb-4">
    <button class="btn btn-success me-2" onclick="showOrderForm()">
      <i class="bi bi-plus-circle"></i> Yeni SipariÅŸ OluÅŸtur
    </button>
    <a href="{{ url_for('home.home') }}" class="btn btn-primary">
      <i class="bi bi-house"></i> Anasayfa
    </a>
  </div>

  <div id="ordersList" class="mb-4">
    <!-- Toplu Ä°ÅŸlemler Toolbar -->
    <div class="filter-area">
      <div class="d-flex gap-2 align-items-center flex-wrap">
        <button class="btn btn-danger" onclick="deleteSelectedOrders()" id="deleteSelectedBtn" style="display:none;">
          <i class="bi bi-trash"></i> SeÃ§ili SipariÅŸleri Sil (<span id="selectedCount">0</span>)
        </button>
        <button class="btn btn-secondary" onclick="selectAllOrders()" id="selectAllBtn">
          <i class="bi bi-check-square"></i> TÃ¼mÃ¼nÃ¼ SeÃ§
        </button>
        <button class="btn btn-secondary" onclick="deselectAllOrders()" id="deselectAllBtn" style="display:none;">
          <i class="bi bi-square"></i> SeÃ§imi KaldÄ±r
        </button>
      </div>
    </div>

    <div class="row">
      {% for siparis in siparisler %}
      <div class="col-md-6 col-lg-4 mb-4">
        <div class="card h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>
              <input type="checkbox" class="order-checkbox me-2" value="{{ siparis.siparis_no }}" onchange="updateSelectedCount()">
              <strong class="text-primary">{{ siparis.siparis_no }}</strong><br>
              <small class="text-muted">{{ siparis.siparis_tarihi.strftime('%d.%m.%Y %H:%M') if siparis.siparis_tarihi else 'N/A' }}</small>
            </div>
            <select class="form-select form-select-sm status-select status-{{ siparis.durum|replace(' ', '-')|lower }}" 
                    style="width:auto;max-width:150px" 
                    data-siparis-no="{{ siparis.siparis_no }}" 
                    onchange="updateOrderStatus('{{ siparis.siparis_no }}', this.value)">
              <option value="Yeni SipariÅŸ" {% if siparis.durum == 'Yeni SipariÅŸ' %}selected{% endif %}>ğŸ†• Yeni</option>
              <option value="HazÄ±rlanÄ±yor" {% if siparis.durum == 'HazÄ±rlanÄ±yor' %}selected{% endif %}>ğŸ“¦ HazÄ±rlanÄ±yor</option>
              <option value="Kargoya HazÄ±r" {% if siparis.durum == 'Kargoya HazÄ±r' %}selected{% endif %}>âœ… HazÄ±r</option>
              <option value="Kargoda" {% if siparis.durum == 'Kargoda' %}selected{% endif %}>ğŸšš Kargoda</option>
              <option value="Teslim Edildi" {% if siparis.durum == 'Teslim Edildi' %}selected{% endif %}>âœ”ï¸ Teslim</option>
              <option value="Ä°ptal Edildi" {% if siparis.durum == 'Ä°ptal Edildi' %}selected{% endif %}>âŒ Ä°ptal</option>
            </select>
          </div>
          
          <div class="card-body">
            <h6 class="card-title">{{ siparis.musteri_adi }} {{ siparis.musteri_soyadi }}</h6>
            <p class="card-text text-muted small mb-2">
              <i class="bi bi-telephone"></i> {{ siparis.musteri_telefon }}
            </p>
            <p class="card-text text-muted small mb-2">
              <i class="bi bi-geo-alt"></i> {{ siparis.musteri_adres[:50] }}{% if siparis.musteri_adres|length > 50 %}...{% endif %}
            </p>
            <hr class="my-2">
            <div class="d-flex justify-content-between align-items-center">
              <span class="fs-5 fw-bold text-primary">{{ siparis.toplam_tutar|default(0)|float|round(2) }} TL</span>
              {% if siparis.kapida_odeme %}
              <span class="badge bg-danger fs-6">ğŸ’° KapÄ±da Ã–deme</span>
              {% endif %}
            </div>
            {% if siparis.notlar %}
            <hr class="my-2">
            <p class="card-text text-muted small fst-italic">
              <i class="bi bi-sticky"></i> {{ siparis.notlar[:60] }}{% if siparis.notlar|length > 60 %}...{% endif %}
            </p>
            {% endif %}
          </div>
          
          <div class="card-footer bg-white">
            <div class="btn-group w-100" role="group">
              <button class="btn btn-sm btn-info" onclick="showOrderDetails('{{ siparis.siparis_no }}')" type="button" 
                      data-bs-toggle="tooltip" data-bs-placement="top" title="SipariÅŸ DetaylarÄ±nÄ± GÃ¶rÃ¼ntÃ¼le">
                <i class="bi bi-eye"></i> Detay
              </button>
              <button class="btn btn-sm btn-success" onclick="printCustomerInfo('{{ siparis.siparis_no }}')" type="button"
                      data-bs-toggle="tooltip" data-bs-placement="top" title="MÃ¼ÅŸteri Bilgilerini YazdÄ±r">
                <i class="bi bi-printer"></i> MÃ¼ÅŸteri
              </button>
              <button class="btn btn-sm btn-danger" onclick="deleteSingleOrder('{{ siparis.siparis_no }}')" type="button"
                      data-bs-toggle="tooltip" data-bs-placement="top" title="SipariÅŸi Sil">
                <i class="bi bi-trash"></i> Sil
              </button>
            </div>
          </div>
        </div>
      </div>
      {% else %}
      <div class="col-12">
        <div class="alert alert-warning text-center">Listelenecek sipariÅŸ bulunamadÄ±.</div>
      </div>
      {% endfor %}
    </div>
  </div>

  <div id="orderForm" class="d-none">
    <form method="POST" class="needs-validation" novalidate>
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">MÃ¼ÅŸteri Bilgileri</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="customer_name" class="form-label">Ad:</label>
              <input type="text" class="form-control" id="customer_name" name="musteri_adi" required>
              <div class="invalid-feedback">LÃ¼tfen mÃ¼ÅŸteri adÄ±nÄ± giriniz.</div>
            </div>
            <div class="col-md-6 mb-3">
              <label for="customer_surname" class="form-label">Soyad:</label>
              <input type="text" class="form-control" id="customer_surname" name="musteri_soyadi" required>
               <div class="invalid-feedback">LÃ¼tfen mÃ¼ÅŸteri soyadÄ±nÄ± giriniz.</div>
            </div>
          </div>
          <div class="mb-3">
            <label for="customer_phone" class="form-label">Telefon:</label>
            <input type="tel" class="form-control" id="customer_phone" name="musteri_telefon" required>
            <div class="invalid-feedback">LÃ¼tfen geÃ§erli bir telefon numarasÄ± giriniz.</div>
          </div>
          <div class="mb-3">
            <label for="customer_address" class="form-label">Adres:</label>
            <textarea class="form-control" id="customer_address" name="musteri_adres" rows="3" required></textarea>
            <div class="invalid-feedback">LÃ¼tfen adresi giriniz.</div>
          </div>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">ÃœrÃ¼n Bilgileri</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label for="barcode" class="form-label">Barkod:</label>
            <div class="input-group">
              <input type="text" class="form-control" id="barcode" name="barcode_search">
              <button type="button" class="btn btn-primary" onclick="searchProduct()">
                <i class="bi bi-search"></i> Ara
              </button>
            </div>
          </div>

          <div id="product-details" class="d-none border p-3 mb-3 rounded">
            <div class="row">
              <div class="col-md-3 text-center">
                <img id="product-image" src="/static/logo/default.png" class="img-fluid rounded mb-2" alt="ÃœrÃ¼n GÃ¶rseli" style="max-height: 150px;">
              </div>
              <div class="col-md-9">
                <h5 id="product-title" class="mb-1">ÃœrÃ¼n AdÄ±</h5>
                <p class="mb-1"><strong>Model:</strong> <span id="product-model"></span></p>
                <p class="mb-1"><strong>Renk:</strong> <span id="product-color"></span></p>
                <p class="mb-1"><strong>Beden:</strong> <span id="product-size"></span></p>
                <p class="mb-2"><strong>Fiyat:</strong> <span id="product-price" data-original-price="0">0.00</span> TL</p>
                <div class="row gx-2">
                  <div class="col-sm-4 mb-2">
                    <label for="quantity" class="form-label">Adet:</label>
                    <input type="number" class="form-control form-control-sm" id="quantity" value="1" min="1">
                  </div>
                  <div class="col-sm-4 mb-2">
                    <label for="custom-price" class="form-label">Ã–zel Fiyat:</label>
                    <input type="number" step="0.01" class="form-control form-control-sm" id="custom-price" placeholder="VarsayÄ±lan">
                  </div>
                   <div class="col-sm-4 mb-2 align-self-end">
                     <button type="button" class="btn btn-success btn-sm w-100" onclick="addToOrder()">
                       <i class="bi bi-cart-plus"></i> Ekle
                     </button>
                   </div>
                </div>
              </div>
            </div>
          </div>

          <div class="d-flex justify-content-end mb-3">
             <button type="button" class="btn btn-info btn-sm" onclick="addMultipleProducts()">
                <i class="bi bi-plus-square-dotted"></i> Toplu ÃœrÃ¼n Ekle (Barkod)
            </button>
          </div>


          <h5>SipariÅŸteki ÃœrÃ¼nler</h5>
          <div class="table-responsive">
            <table class="table table-sm table-striped">
              <thead>
                <tr>
                  <th>Barkod</th>
                  <th>ÃœrÃ¼n</th>
                  <th>Renk/Beden</th>
                  <th>Adet</th>
                  <th>Birim Fiyat</th>
                  <th>Toplam</th>
                  <th>Ä°ÅŸlem</th>
                </tr>
              </thead>
              <tbody id="order-items">
                </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="row">
          <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white"><h5 class="mb-0">Notlar</h5></div>
                <div class="card-body">
                    <textarea class="form-control" id="order_notes" name="notlar" rows="3" placeholder="SipariÅŸ ile ilgili notlarÄ±nÄ±z..."></textarea>
                </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-info text-white"><h5 class="mb-0">SipariÅŸ Ã–zeti</h5></div>
                <div class="card-body">
                    <p><strong>Toplam ÃœrÃ¼n Adedi:</strong> <span id="total-items-summary">0</span></p>
                    <p class="h5"><strong>Genel Toplam:</strong> <span id="total-amount-summary" class="fw-bold">0.00 TL</span></p>
                    <input type="hidden" id="toplam_tutar_hidden" name="toplam_tutar" value="0">
                    
                    <!-- KapÄ±da Ã–deme AlanÄ± -->
                    <hr class="my-3">
                    <div class="form-check mb-2">
                      <input class="form-check-input" type="checkbox" id="kapida_odeme" name="kapida_odeme" onchange="toggleKapidaOdemeTutar()">
                      <label class="form-check-label fw-bold text-danger" for="kapida_odeme">
                        ğŸ’° KapÄ±da Ã–deme Var
                      </label>
                    </div>
                    <div id="kapida_odeme_tutar_container" class="d-none">
                      <label for="kapida_odeme_tutari" class="form-label">KapÄ±da Ã–denecek Tutar:</label>
                      <div class="input-group">
                        <input type="number" step="0.01" class="form-control" id="kapida_odeme_tutari" name="kapida_odeme_tutari" placeholder="0.00">
                        <span class="input-group-text">TL</span>
                      </div>
                    </div>
                </div>
            </div>
          </div>
      </div>


      <div class="mb-3">
        <label for="status" class="form-label">SipariÅŸ Durumu:</label>
        <select class="form-select" id="status" name="durum" required>
          <option value="Yeni SipariÅŸ" selected>Yeni SipariÅŸ</option>
          <option value="OnaylandÄ±">OnaylandÄ±</option>
          <option value="HazÄ±rlanÄ±yor">HazÄ±rlanÄ±yor</option>
          <option value="Kargoya Verildi">Kargoya Verildi</option>
          <option value="Teslim Edildi">Teslim Edildi</option>
          <option value="Ä°ptal Edildi">Ä°ptal Edildi</option>
        </select>
      </div>

      <input type="hidden" id="urunler_hidden" name="urunler">

      <div class="d-flex justify-content-between">
        <button type="button" class="btn btn-secondary" onclick="hideOrderForm()">
            <i class="bi bi-x-lg"></i> Ä°ptal Et & Listeye DÃ¶n
        </button>
        <button type="submit" class="btn btn-primary btn-lg">
            <i class="bi bi-check-circle"></i> SipariÅŸi Kaydet
        </button>
      </div>
    </form>
  </div>
</div>

<div class="modal fade" id="orderDetailModal" tabindex="-1" aria-labelledby="orderDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="orderDetailModalLabel">SipariÅŸ DetayÄ±</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="orderDetailContent">
        </div>
    </div>
  </div>
</div>

<div class="modal fade" id="multipleProductsModal" tabindex="-1" aria-labelledby="multipleProductsModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="multipleProductsModalLabel">Toplu ÃœrÃ¼n Ekle</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="multiple-barcodes" class="form-label">Barkodlar (Her satÄ±ra bir barkod):</label>
          <textarea class="form-control" id="multiple-barcodes" rows="5"></textarea>
        </div>
        <div class="mb-3">
          <label for="default-quantity" class="form-label">VarsayÄ±lan Adet (Her Ã¼rÃ¼n iÃ§in):</label>
          <input type="number" class="form-control" id="default-quantity" value="1" min="1">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ä°ptal</button>
        <button type="button" class="btn btn-primary" onclick="processMultipleProducts()">
            <i class="bi bi-check-all"></i> ÃœrÃ¼nleri Ekle
        </button>
      </div>
    </div>
  </div>
</div>

<style>
/* Arama ve Animasyon Stilleri (EÄŸer base.html'de yoksa veya Ã¶zelleÅŸtirmek isterseniz) */
  .search-container {
    transition: box-shadow 0.3s ease;
  }
  .search-container:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  #ordersList tr.highlight {
    background-color: #fff3cd !important; /* Bootstrap warning rengine yakÄ±n */
    animation: highlight-row 1.5s ease-out;
  }
  @keyframes highlight-row {
    0%, 100% { background-color: #fff3cd; }
    50% { background-color: #ffeeba; } /* Biraz daha aÃ§Ä±k ton */
  }

  /* Durum Dropdown Renkleri */
  .status-select {
    font-weight: 600;
    border: 2px solid;
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .status-select:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  /* Yeni SipariÅŸ - Mavi */
  .status-yeni-sipariÅŸ,
  .status-select option[value="Yeni SipariÅŸ"]:checked {
    background-color: #cfe2ff !important;
    border-color: #0d6efd !important;
    color: #084298 !important;
  }

  /* HazÄ±rlanÄ±yor - Turuncu */
  .status-hazÄ±rlanÄ±yor,
  .status-select option[value="HazÄ±rlanÄ±yor"]:checked {
    background-color: #ffe69c !important;
    border-color: #ffc107 !important;
    color: #664d03 !important;
  }

  /* Kargoya HazÄ±r - Cyan */
  .status-kargoya-hazÄ±r,
  .status-select option[value="Kargoya HazÄ±r"]:checked {
    background-color: #9eeaf9 !important;
    border-color: #0dcaf0 !important;
    color: #055160 !important;
  }

  /* Kargoda - Mor */
  .status-kargoda,
  .status-select option[value="Kargoda"]:checked {
    background-color: #e0cffc !important;
    border-color: #6f42c1 !important;
    color: #3d2465 !important;
  }

  /* Teslim Edildi - YeÅŸil */
  .status-teslim-edildi,
  .status-select option[value="Teslim Edildi"]:checked {
    background-color: #a3cfbb !important;
    border-color: #198754 !important;
    color: #0f5132 !important;
  }

  /* Ä°ptal Edildi - KÄ±rmÄ±zÄ± */
  .status-iptal-edildi,
  .status-select option[value="Ä°ptal Edildi"]:checked {
    background-color: #f1aeb5 !important;
    border-color: #dc3545 !important;
    color: #58151c !important;
  }

  /* Dropdown aÃ§Ä±kken seÃ§eneklere hover efekti */
  .status-select option {
    padding: 8px;
    font-weight: 600;
  }

  .status-select option:hover {
    background-color: #f0f0f0 !important;
  }

  /* Buton grubu dÃ¼zenlemeleri */
  .btn-group .btn {
    white-space: nowrap;
  }

  /* Tooltip stilleri (Bootstrap'in varsayÄ±lan tooltip'lerini gÃ¼Ã§lendir) */
  .tooltip {
    font-size: 0.875rem;
  }

  /* KÃ¼Ã§Ã¼k ekranlarda buton metinlerini gizle */
  @media (max-width: 992px) {
    .btn-group .btn span {
      display: none !important;
    }
  }

</style>

<script>
// Global deÄŸiÅŸkenler
let orderItems = []; // SipariÅŸe eklenen Ã¼rÃ¼nleri tutar
let currentOrderSiparisNo = null; // DÃ¼zenlenen sipariÅŸin numarasÄ±nÄ± tutar

// ==================== TOPLU Ä°ÅLEMLER ====================

// TÃ¼m checkboxlarÄ± seÃ§/kaldÄ±r
function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const checkboxes = document.querySelectorAll('.order-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    updateSelectedCount();
}

// TÃ¼m sipariÅŸleri seÃ§
function selectAllOrders() {
    const checkboxes = document.querySelectorAll('.order-checkbox');
    checkboxes.forEach(checkbox => checkbox.checked = true);
    document.getElementById('selectAllCheckbox').checked = true;
    updateSelectedCount();
}

// TÃ¼m seÃ§imleri kaldÄ±r
function deselectAllOrders() {
    const checkboxes = document.querySelectorAll('.order-checkbox');
    checkboxes.forEach(checkbox => checkbox.checked = false);
    document.getElementById('selectAllCheckbox').checked = false;
    updateSelectedCount();
}

// SeÃ§ili sipariÅŸ sayÄ±sÄ±nÄ± gÃ¼ncelle
function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.order-checkbox:checked');
    const count = checkboxes.length;
    document.getElementById('selectedCount').textContent = count;
    
    // ButonlarÄ±n gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼nÃ¼ ayarla
    const deleteBtn = document.getElementById('deleteSelectedBtn');
    const deselectBtn = document.getElementById('deselectAllBtn');
    
    if (count > 0) {
        deleteBtn.style.display = 'inline-block';
        deselectBtn.style.display = 'inline-block';
    } else {
        deleteBtn.style.display = 'none';
        deselectBtn.style.display = 'none';
    }
}

// SeÃ§ili sipariÅŸleri sil
async function deleteSelectedOrders() {
    const checkboxes = document.querySelectorAll('.order-checkbox:checked');
    const siparisNolar = Array.from(checkboxes).map(cb => cb.value);
    
    if (siparisNolar.length === 0) {
        alert('LÃ¼tfen silmek iÃ§in en az bir sipariÅŸ seÃ§in.');
        return;
    }
    
    if (!confirm(`${siparisNolar.length} adet sipariÅŸi silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz.`)) {
        return;
    }
    
    try {
        const response = await fetch('/siparis-toplu-sil', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ siparis_nolar: siparisNolar })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`${result.deleted_count} sipariÅŸ baÅŸarÄ±yla silindi.`);
            window.location.reload();
        } else {
            alert(`SipariÅŸler silinirken hata: ${result.message || 'Bilinmeyen hata'}`);
        }
    } catch (error) {
        console.error('Toplu silme hatasÄ±:', error);
        alert('SipariÅŸler silinirken bir aÄŸ hatasÄ± oluÅŸtu.');
    }
}

// Tekil sipariÅŸ sil
async function deleteSingleOrder(siparisNo) {
    if (!confirm(`"${siparisNo}" numaralÄ± sipariÅŸi silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz.`)) {
        return;
    }
    
    try {
        const response = await fetch(`/siparis-sil/${siparisNo}`, { method: 'DELETE' });
        const result = await response.json();
        
        if (result.success) {
            alert('SipariÅŸ baÅŸarÄ±yla silindi.');
            // SatÄ±rÄ± tablodan kaldÄ±r
            const row = document.querySelector(`tr[data-siparis-no="${siparisNo}"]`);
            if (row) {
                row.remove();
            }
            updateSelectedCount();
        } else {
            alert(`SipariÅŸ silinirken hata: ${result.message || 'Bilinmeyen hata'}`);
        }
    } catch (error) {
        console.error('SipariÅŸ silme hatasÄ±:', error);
        alert('SipariÅŸ silinirken bir aÄŸ hatasÄ± oluÅŸtu.');
    }
}

// ==================== DURUM GÃœNCELLEME ====================

async function updateOrderStatus(siparisNo, yeniDurum) {
    try {
        const response = await fetch(`/siparis-durum-guncelle/${siparisNo}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ durum: yeniDurum })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // BaÅŸarÄ±lÄ± gÃ¼ncelleme bildirimi
            showToast(`SipariÅŸ ${siparisNo} durumu "${yeniDurum}" olarak gÃ¼ncellendi`, 'success');
            
            // Select elementinin rengini gÃ¼ncelle
            const selectElement = document.querySelector(`select[data-siparis-no="${siparisNo}"]`);
            if (selectElement) {
                // Eski renk sÄ±nÄ±flarÄ±nÄ± kaldÄ±r
                selectElement.classList.remove('status-yeni-sipariÅŸ', 'status-hazÄ±rlanÄ±yor', 
                    'status-kargoya-hazÄ±r', 'status-kargoda', 'status-teslim-edildi', 'status-iptal-edildi');
                
                // Yeni renk sÄ±nÄ±fÄ±nÄ± ekle
                const statusClass = 'status-' + yeniDurum.toLowerCase().replace(/ /g, '-');
                selectElement.classList.add(statusClass);
            }
        } else {
            alert(`Durum gÃ¼ncellenirken hata: ${result.message || 'Bilinmeyen hata'}`);
            // Dropdown'u eski haline dÃ¶ndÃ¼r
            const selectElement = document.querySelector(`select[data-siparis-no="${siparisNo}"]`);
            if (selectElement) {
                selectElement.selectedIndex = 0;
            }
        }
    } catch (error) {
        console.error('Durum gÃ¼ncelleme hatasÄ±:', error);
        alert('Durum gÃ¼ncellenirken bir aÄŸ hatasÄ± oluÅŸtu.');
        // Dropdown'u eski haline dÃ¶ndÃ¼r
        const selectElement = document.querySelector(`select[data-siparis-no="${siparisNo}"]`);
        if (selectElement) {
            selectElement.selectedIndex = 0;
        }
    }
}

// ==================== KARGO ETÄ°KETÄ° ====================

function printShippingLabel(siparisNo) {
    // Yeni pencerede kargo etiketini aÃ§
    const url = `/siparis-kargo-etiketi/${siparisNo}`;
    window.open(url, '_blank', 'width=400,height=600');
}

// ==================== TOAST BÄ°LDÄ°RÄ°M SÄ°STEMÄ° ====================

function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        const container = document.createElement('div');
        container.id = 'toastContainer';
        container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
        document.body.appendChild(container);
    }
    
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show`;
    toast.style.cssText = 'min-width: 250px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.getElementById('toastContainer').appendChild(toast);
    
    // 3 saniye sonra otomatik kapat
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 150);
    }, 3000);
}

// ==================== MEVCUT FONKSÄ°YONLAR ====================

// KapÄ±da Ã¶deme checkbox deÄŸiÅŸtiÄŸinde
function toggleKapidaOdemeTutar() {
    const checkbox = document.getElementById('kapida_odeme');
    const tutarContainer = document.getElementById('kapida_odeme_tutar_container');
    const tutarInput = document.getElementById('kapida_odeme_tutari');
    
    if (checkbox.checked) {
        tutarContainer.classList.remove('d-none');
        tutarInput.required = true;
        tutarInput.focus();
    } else {
        tutarContainer.classList.add('d-none');
        tutarInput.required = false;
        tutarInput.value = '';
    }
}


// Sayfa yÃ¼klendiÄŸinde
document.addEventListener('DOMContentLoaded', function() {
    // Form doÄŸrulama (Bootstrap 5 iÃ§in)
    const forms = document.querySelectorAll('.needs-validation');
    Array.prototype.slice.call(forms).forEach(function (form) {
        form.addEventListener('submit', function (event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
    });

    // Bootstrap Tooltip'lerini baÅŸlat
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});


function showOrderForm(isEdit = false, siparisData = null, urunlerData = null) {
    document.getElementById('ordersList').classList.add('d-none');
    document.getElementById('orderForm').classList.remove('d-none');
    const form = document.querySelector('#orderForm form');
    form.reset(); // Formu temizle
    form.classList.remove('was-validated'); // DoÄŸrulama stillerini sÄ±fÄ±rla
    orderItems = []; // ÃœrÃ¼n listesini sÄ±fÄ±rla

    if (isEdit && siparisData) {
        currentOrderSiparisNo = siparisData.siparis_no;
        form.dataset.mode = 'edit';
        form.dataset.siparisNo = siparisData.siparis_no;
        document.querySelector('#customer_name').value = siparisData.musteri_adi || '';
        document.querySelector('#customer_surname').value = siparisData.musteri_soyadi || '';
        document.querySelector('#customer_address').value = siparisData.musteri_adres || '';
        document.querySelector('#customer_phone').value = siparisData.musteri_telefon || '';
        document.querySelector('#status').value = siparisData.durum || 'Yeni SipariÅŸ';
        document.querySelector('#order_notes').value = siparisData.notlar || '';

        if (urunlerData && Array.isArray(urunlerData)) {
            orderItems = urunlerData.map(u => ({
                barcode: u.urun_barkod,
                title: u.urun_adi,
                color: u.renk,
                size: u.beden,
                quantity: parseInt(u.adet || 0),
                price: parseFloat(u.birim_fiyat || 0),
                total: parseFloat(u.toplam_fiyat || 0), // Backend'den gelen toplam fiyatÄ± kullanabiliriz.
                // discount: 0, // Ä°ndirim varsa buraya eklenebilir. Åimdilik 0.
                notes: u.notlar || '' // ÃœrÃ¼n notu varsa
            }));
        }
    } else {
        currentOrderSiparisNo = null;
        form.dataset.mode = 'new';
        form.dataset.siparisNo = '';
         document.querySelector('#status').value = 'Yeni SipariÅŸ'; // Yeni sipariÅŸ iÃ§in varsayÄ±lan durum
    }
    updateOrderTable();
    updateTotals();
}

function hideOrderForm() {
    document.getElementById('ordersList').classList.remove('d-none');
    document.getElementById('orderForm').classList.add('d-none');
    const form = document.querySelector('#orderForm form');
    form.reset();
    form.classList.remove('was-validated');
    orderItems = [];
    updateOrderTable();
    updateTotals();
    currentOrderSiparisNo = null;
}

async function searchProduct() {
    const barcode = document.getElementById('barcode').value.trim();
    if (!barcode) {
        alert('LÃ¼tfen bir barkod giriniz.');
        return;
    }
    try {
        const response = await fetch(`/api/product/${barcode}`);
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ message: 'Sunucu hatasÄ± veya JSON parse edilemedi.' }));
            alert(`ÃœrÃ¼n bulunamadÄ± veya bir hata oluÅŸtu: ${errorData.message || response.statusText}`);
            return;
        }
        const data = await response.json();
        if (data.success && data.product) {
            const product = data.product;
            document.getElementById('product-details').classList.remove('d-none');
            // ÃœrÃ¼n gÃ¶rselini ayarla - Ã¶ncelik sÄ±rasÄ±: barkod.jpg > database images > default
            let imageSrc = `/static/images/${product.barcode}.jpg`;
            
            const productImageEl = document.getElementById('product-image');
            productImageEl.src = imageSrc;
            // GÃ¶rsel yÃ¼klenemezse varsayÄ±lan gÃ¶rseli gÃ¶ster
            productImageEl.onerror = function() {
                this.src = '/static/images/default-product.png';
                this.onerror = null;
            };
            document.getElementById('product-title').textContent = product.title || 'N/A';
            document.getElementById('product-model').textContent = product.product_main_id || 'N/A';
            document.getElementById('product-color').textContent = product.color || 'N/A';
            document.getElementById('product-size').textContent = product.size || 'N/A';
            const salePrice = parseFloat(product.sale_price || 0).toFixed(2);
            document.getElementById('product-price').textContent = salePrice;
            document.getElementById('product-price').dataset.originalPrice = salePrice; // Orijinal fiyatÄ± sakla
            document.getElementById('custom-price').value = ''; // Ã–zel fiyatÄ± temizle
            document.getElementById('quantity').value = 1; // Adeti 1 yap
        } else {
            alert(data.message || 'ÃœrÃ¼n bulunamadÄ±.');
            document.getElementById('product-details').classList.add('d-none');
        }
    } catch (error) {
        console.error('ÃœrÃ¼n arama hatasÄ±:', error);
        alert('ÃœrÃ¼n aranÄ±rken bir aÄŸ hatasÄ± oluÅŸtu.');
        document.getElementById('product-details').classList.add('d-none');
    }
}

function addToOrder() {
    if (document.getElementById('product-details').classList.contains('d-none')) {
        alert('LÃ¼tfen Ã¶nce bir Ã¼rÃ¼n arayÄ±n ve seÃ§in.');
        return;
    }
    const barcode = document.getElementById('barcode').value.trim();
    const quantity = parseInt(document.getElementById('quantity').value) || 1;

    // ÃœrÃ¼nÃ¼n zaten listede olup olmadÄ±ÄŸÄ±nÄ± kontrol et
    const existingItemIndex = orderItems.findIndex(item => item.barcode === barcode);

    if (existingItemIndex > -1) { // ÃœrÃ¼n zaten listede varsa
        if (confirm(`'${orderItems[existingItemIndex].title}' Ã¼rÃ¼nÃ¼ zaten sipariÅŸte. Adetini artÄ±rmak ister misiniz?`)) {
            orderItems[existingItemIndex].quantity += quantity;
        } else {
            return; // Ä°ÅŸlemi iptal et
        }
    } else { // ÃœrÃ¼n listede yoksa yeni ekle
        const title = document.getElementById('product-title').textContent;
        const color = document.getElementById('product-color').textContent;
        const size = document.getElementById('product-size').textContent;
        const customPriceInput = document.getElementById('custom-price');
        const originalPrice = parseFloat(document.getElementById('product-price').dataset.originalPrice);

        let price;
        if (customPriceInput.value.trim() !== '') {
            price = parseFloat(customPriceInput.value);
            if (isNaN(price) || price < 0) {
                alert('LÃ¼tfen geÃ§erli bir Ã¶zel fiyat giriniz.');
                return;
            }
        } else {
            price = originalPrice;
        }

        if (isNaN(price)) { // Her ihtimale karÅŸÄ±
            alert('ÃœrÃ¼n fiyatÄ± alÄ±namadÄ±.');
            return;
        }

        orderItems.push({
            barcode,
            title,
            color,
            size,
            quantity,
            price: parseFloat(price.toFixed(2)),
            total: parseFloat((quantity * price).toFixed(2)),
            // discount: 0, // Ä°ndirim eklenecekse
            notes: '' // ÃœrÃ¼n bazlÄ± notlar eklenebilir
        });
    }

    updateOrderTable();
    updateTotals();
    // ÃœrÃ¼n eklendikten sonra arama alanlarÄ±nÄ± temizle
    document.getElementById('barcode').value = '';
    document.getElementById('product-details').classList.add('d-none');
    document.getElementById('quantity').value = 1;
    document.getElementById('custom-price').value = '';
}

function updateOrderTable() {
    const tbody = document.getElementById('order-items');
    tbody.innerHTML = ''; // Tabloyu temizle
    orderItems.forEach((item, index) => {
        const row = tbody.insertRow();
        row.insertCell().textContent = item.barcode;
        row.insertCell().textContent = item.title;
        row.insertCell().textContent = `${item.color || 'N/A'} / ${item.size || 'N/A'}`;

        const qtyCell = row.insertCell();
        const qtyInput = document.createElement('input');
        qtyInput.type = 'number';
        qtyInput.className = 'form-control form-control-sm';
        qtyInput.value = item.quantity;
        qtyInput.min = 1;
        qtyInput.onchange = () => updateItem(index, 'quantity', parseInt(qtyInput.value));
        qtyCell.appendChild(qtyInput);

        const priceCell = row.insertCell();
        const priceInput = document.createElement('input');
        priceInput.type = 'number';
        priceInput.step = '0.01';
        priceInput.className = 'form-control form-control-sm';
        priceInput.value = item.price.toFixed(2);
        priceInput.onchange = () => updateItem(index, 'price', parseFloat(priceInput.value));
        priceCell.appendChild(priceInput);

        row.insertCell().textContent = item.total.toFixed(2) + ' TL';

        const actionCell = row.insertCell();
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn btn-danger btn-sm';
        removeBtn.innerHTML = '<i class="bi bi-trash"></i>';
        removeBtn.onclick = () => removeItem(index);
        actionCell.appendChild(removeBtn);
    });
}

function updateItem(index, field, value) {
    if (orderItems[index]) {
        if (field === 'quantity') {
            orderItems[index].quantity = Math.max(1, parseInt(value) || 1); // En az 1 adet
        } else if (field === 'price') {
            orderItems[index].price = Math.max(0, parseFloat(value) || 0); // Fiyat negatif olamaz
        }
        orderItems[index].total = parseFloat((orderItems[index].quantity * orderItems[index].price).toFixed(2));
        updateOrderTable(); // Sadece ilgili satÄ±rÄ± gÃ¼ncellemek yerine tÃ¼m tabloyu yenilemek daha basit
        updateTotals();
    }
}

function removeItem(index) {
    orderItems.splice(index, 1);
    updateOrderTable();
    updateTotals();
}

function updateTotals() {
    const totalItems = orderItems.reduce((sum, item) => sum + item.quantity, 0);
    const finalTotal = orderItems.reduce((sum, item) => sum + item.total, 0);

    document.getElementById('total-items-summary').textContent = totalItems;
    document.getElementById('total-amount-summary').textContent = finalTotal.toFixed(2) + ' TL';
    document.getElementById('toplam_tutar_hidden').value = finalTotal.toFixed(2); // Gizli inputu gÃ¼ncelle
}


async function showOrderDetails(siparisNo) {
    try {
        const response = await fetch(`/siparis-detay/${siparisNo}`);
        if (!response.ok) throw new Error('SipariÅŸ detaylarÄ± alÄ±namadÄ±.');
        const detayHtml = await response.text();
        const contentElement = document.getElementById('orderDetailContent');
        contentElement.innerHTML = detayHtml;

        // Modal footer'Ä±nÄ± temizle ve butonlarÄ± ekle
        let modalFooter = contentElement.querySelector('.modal-footer');
        if (modalFooter) modalFooter.remove(); // Varsa eski footer'Ä± kaldÄ±r

        modalFooter = document.createElement('div');
        modalFooter.className = 'modal-footer';
        modalFooter.innerHTML = `
            <button type="button" class="btn btn-warning" onclick="loadOrderForEdit('${siparisNo}')">
                <i class="bi bi-pencil"></i> DÃ¼zenle
            </button>
            <button type="button" class="btn btn-danger" onclick="siparisiSil('${siparisNo}')">
                <i class="bi bi-trash"></i> Sil
            </button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
        `;
        contentElement.appendChild(modalFooter);

        const modalEl = document.getElementById('orderDetailModal');
        const modal = $(modalEl).data('bs.modal') || new bootstrap.Modal(modalEl);
        modal.show();
    } catch (error) {
        console.error('SipariÅŸ detayÄ± yÃ¼kleme hatasÄ±:', error);
        alert('SipariÅŸ detaylarÄ± yÃ¼klenirken bir hata oluÅŸtu.');
    }
}

async function loadOrderForEdit(siparisNo) {
    try {
        // SipariÅŸ ve Ã¼rÃ¼n detaylarÄ±nÄ± backend'den JSON olarak alalÄ±m
        // Bu endpoint'in /siparisler-json/<siparis_no> gibi bir ÅŸey olmasÄ± ve JSON dÃ¶nmesi gerekebilir.
        // Åimdilik /siparis-detay HTML'ini parse etmeye devam edeceÄŸiz, ama ideal olan JSON API'dÄ±r.

        const response = await fetch(`/siparis-detay/${siparisNo}`); // Bu HTML dÃ¶ner
        if (!response.ok) throw new Error('DÃ¼zenlenecek sipariÅŸ verisi alÄ±namadÄ±.');
        const htmlText = await response.text();

        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlText, 'text/html');

        const siparisData = {
            siparis_no: doc.querySelector('p:contains("SipariÅŸ No:")')?.textContent.split(':')[1]?.trim(),
            musteri_adi: doc.querySelector('[data-musteri-adi]')?.textContent.trim(),
            musteri_soyadi: doc.querySelector('[data-musteri-soyadi]')?.textContent.trim(),
            musteri_adres: doc.querySelector('[data-musteri-adres]')?.textContent.trim(),
            musteri_telefon: doc.querySelector('[data-musteri-telefon]')?.textContent.trim(),
            durum: doc.querySelector('[data-durum]')?.textContent.trim(),
            notlar: "" // Notlar iÃ§in partial'da bir alan yok, gerekirse eklenebilir
        };

        const urunlerData = [];
        const urunRows = doc.querySelectorAll('.table-products tbody tr');
        urunRows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length >= 6) {
                urunlerData.push({
                    urun_barkod: cells[0].textContent.trim(),
                    urun_adi: cells[1].textContent.trim(),
                    renk: cells[2].textContent.trim().split('/')[0]?.trim(),
                    beden: cells[2].textContent.trim().split('/')[1]?.trim(),
                    adet: parseInt(cells[3].textContent.trim()),
                    birim_fiyat: parseFloat(cells[4].textContent.replace('TL', '').trim()),
                    toplam_fiyat: parseFloat(cells[5].textContent.replace('TL', '').trim())
                });
            }
        });

        const modalEl = document.getElementById('orderDetailModal');
        $(modalEl).modal('hide');

        showOrderForm(true, siparisData, urunlerData);

    } catch (error) {
        console.error('SipariÅŸ dÃ¼zenlemeye yÃ¼klenirken hata:', error);
        alert('SipariÅŸ dÃ¼zenleme iÃ§in yÃ¼klenirken bir hata oluÅŸtu.');
    }
}


async function siparisiSil(siparisNo) {
    if (!confirm(`"${siparisNo}" numaralÄ± sipariÅŸi silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz.`)) {
        return;
    }
    try {
        const response = await fetch(`/siparis-sil/${siparisNo}`, { method: 'DELETE' });
        const data = await response.json();
        if (data.success) {
            alert('SipariÅŸ baÅŸarÄ±yla silindi.');
            const modalEl = document.getElementById('orderDetailModal');
            $(modalEl).modal('hide');
            // SayfayÄ± yenilemek yerine satÄ±rÄ± tablodan silmek daha kullanÄ±cÄ± dostu olabilir.
            // Åimdilik basitÃ§e sayfayÄ± yeniliyoruz.
            window.location.reload();
        } else {
            alert(`SipariÅŸ silinirken hata: ${data.message || 'Bilinmeyen hata'}`);
        }
    } catch (error) {
        console.error('SipariÅŸ silme hatasÄ±:', error);
        alert('SipariÅŸ silinirken bir aÄŸ hatasÄ± oluÅŸtu.');
    }
}

// Form gÃ¶nderimini ele al
document.querySelector('#orderForm form').addEventListener('submit', async function(event) {
    event.preventDefault();
    event.stopPropagation();

    if (!this.checkValidity()) {
        this.classList.add('was-validated');
        alert('LÃ¼tfen tÃ¼m zorunlu alanlarÄ± doldurunuz.');
        return;
    }
    if (orderItems.length === 0) {
        alert('LÃ¼tfen sipariÅŸe en az bir Ã¼rÃ¼n ekleyiniz.');
        return;
    }

    // Gizli Ã¼rÃ¼nler alanÄ±nÄ± JSON string ile doldur
    document.getElementById('urunler_hidden').value = JSON.stringify(
        orderItems.map(item => ({
            barkod: item.barcode,
            urun_adi: item.title,
            adet: item.quantity,
            birim_fiyat: item.price,
            renk: item.color,
            beden: item.size,
            // toplam_fiyat backend'de hesaplanabilir veya buradan gÃ¶nderilebilir.
            // Åimdilik backend'e bÄ±rakalÄ±m.
        }))
    );
    // Gizli toplam_tutar alanÄ±nÄ±n zaten updateTotals ile gÃ¼ncellendiÄŸinden emin olalÄ±m
    updateTotals();


    const isEditMode = this.dataset.mode === 'edit';
    const currentSiparisNo = this.dataset.siparisNo;
    const url = isEditMode ? `/siparis-guncelle/${currentSiparisNo}` : '/yeni-siparis';

    // FormData yerine JSON gÃ¶nderiyoruz backend'deki yapÄ±ya uygun olmasÄ± iÃ§in
    const payload = {
        musteri_adi: document.getElementById('customer_name').value,
        musteri_soyadi: document.getElementById('customer_surname').value,
        musteri_adres: document.getElementById('customer_address').value,
        musteri_telefon: document.getElementById('customer_phone').value,
        toplam_tutar: parseFloat(document.getElementById('toplam_tutar_hidden').value),
        notlar: document.getElementById('order_notes').value,
        durum: document.getElementById('status').value,
        kapida_odeme: document.getElementById('kapida_odeme').checked,
        kapida_odeme_tutari: parseFloat(document.getElementById('kapida_odeme_tutari').value) || 0,
        urunler: JSON.parse(document.getElementById('urunler_hidden').value) // JSON string'i parse et
    };

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const result = await response.json();
        if (result.success) {
            alert(isEditMode ? 'SipariÅŸ baÅŸarÄ±yla gÃ¼ncellendi!' : `SipariÅŸ baÅŸarÄ±yla oluÅŸturuldu! SipariÅŸ No: ${result.siparis_no || ''}`);
            hideOrderForm();
            // Listeyi yenilemek iÃ§in sayfayÄ± yeniden yÃ¼kle
            // Daha iyi bir UX iÃ§in AJAX ile listeyi gÃ¼ncelleyebilirsiniz.
            window.location.reload();
        } else {
            alert(`Ä°ÅŸlem sÄ±rasÄ±nda hata: ${result.message || 'Bilinmeyen bir sunucu hatasÄ± oluÅŸtu.'}`);
        }
    } catch (error) {
        console.error('SipariÅŸ kaydetme/gÃ¼ncelleme hatasÄ±:', error);
        alert('SipariÅŸ gÃ¶nderilirken bir aÄŸ hatasÄ± oluÅŸtu.');
    }
});


// ÃœrÃ¼n GÃ¶rseli BÃ¼yÃ¼tme Ä°ÅŸlevi
function showImageModal(imageSrc, productTitle) {
    // EÄŸer modal yoksa oluÅŸtur
    let imageModal = document.getElementById('imageModal');
    if (!imageModal) {
        const modalHtml = `
        <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">ÃœrÃ¼n GÃ¶rseli</h5>
                <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close">&times;</button>
              </div>
              <div class="modal-body text-center">
                <img id="modalImage" src="" alt="ÃœrÃ¼n GÃ¶rseli" class="img-fluid" style="max-height: 500px;">
              </div>
            </div>
          </div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        imageModal = document.getElementById('imageModal');
    }
    
    const modalImage = document.getElementById('modalImage');
    const modalTitle = document.getElementById('imageModalLabel');
    
    modalImage.src = imageSrc;
    modalTitle.textContent = 'ÃœrÃ¼n GÃ¶rseli - ' + productTitle;
    
    $(imageModal).modal('show');
}

// Toplu ÃœrÃ¼n Ekleme Modal Ä°ÅŸlevleri
function addMultipleProducts() {
    const modalEl = document.getElementById('multipleProductsModal');
    $(modalEl).modal('show');
}

async function processMultipleProducts() {
    const barcodesText = document.getElementById('multiple-barcodes').value;
    const defaultQuantity = parseInt(document.getElementById('default-quantity').value) || 1;
    const barcodes = barcodesText.split('\n').map(b => b.trim()).filter(b => b !== '');

    if (barcodes.length === 0) {
        alert('LÃ¼tfen en az bir barkod giriniz.');
        return;
    }

    let productsAddedCount = 0;
    let productsNotFound = [];

    for (const barcode of barcodes) {
        try {
            const response = await fetch(`/api/product/${barcode}`);
            const data = await response.json();
            if (data.success && data.product) {
                const product = data.product;
                const existingItemIndex = orderItems.findIndex(item => item.barcode === barcode);
                if (existingItemIndex > -1) {
                    orderItems[existingItemIndex].quantity += defaultQuantity;
                } else {
                    orderItems.push({
                        barcode: product.barcode,
                        title: product.title,
                        color: product.color,
                        size: product.size,
                        quantity: defaultQuantity,
                        price: parseFloat(product.sale_price || 0),
                        total: parseFloat(defaultQuantity * (product.sale_price || 0))
                    });
                }
                productsAddedCount++;
            } else {
                productsNotFound.push(barcode);
            }
        } catch (error) {
            console.error(`Barkod ${barcode} iÅŸlenirken hata:`, error);
            productsNotFound.push(`${barcode} (AÄŸ HatasÄ±)`);
        }
    }

    updateOrderTable();
    updateTotals();

    const modalEl = document.getElementById('multipleProductsModal');
    const modal = bootstrap.Modal.getInstance(modalEl);
    if (modal) modal.hide();

    document.getElementById('multiple-barcodes').value = ''; // Textarea'yÄ± temizle

    let summaryMessage = `${productsAddedCount} Ã¼rÃ¼n sipariÅŸe eklendi/gÃ¼ncellendi.`;
    if (productsNotFound.length > 0) {
        summaryMessage += `\n\nBulunamayan veya hata alÄ±nan barkodlar:\n${productsNotFound.join('\n')}`;
    }
    alert(summaryMessage);
}

// MÃ¼ÅŸteri Bilgilerini YazdÄ±rma (JSON endpoint kullanarak)
async function printCustomerInfo(siparisNo) {
    try {
        const response = await fetch(`/siparis-musteri-bilgisi/${siparisNo}`);
        if (!response.ok) throw new Error('MÃ¼ÅŸteri bilgileri alÄ±namadÄ±.');
        const data = await response.json();
        
        if (!data.success) {
            alert('MÃ¼ÅŸteri bilgileri alÄ±namadÄ±: ' + (data.message || 'Bilinmeyen hata'));
            return;
        }
        
        console.log('ğŸ“¦ SipariÅŸ Verileri:', data);
        
        const musteriAdi = data.musteri_adi || 'N/A';
        const musteriSoyadi = data.musteri_soyadi || '';
        const musteriTelefon = data.musteri_telefon || 'N/A';
        const musteriAdres = data.musteri_adres || 'N/A';
        const kapidaOdeme = data.kapida_odeme || false;
        const kapidaOdemeTutari = parseFloat(data.kapida_odeme_tutari) || 0;
        
        console.log('ğŸ’° KapÄ±da Ã–deme:', kapidaOdeme);
        console.log('ğŸ’µ Tutar:', kapidaOdemeTutari);

        // KapÄ±da Ã¶deme iÃ§in Ã¶zel vurgu HTML'i
        let kapidaOdemeHTML = '';
        if (kapidaOdeme && kapidaOdemeTutari > 0) {
            console.log('âœ… KAPIDA Ã–DEME KUTUSU OLUÅTURULUYOR!');
            kapidaOdemeHTML = `
                <div class="kapida-odeme-box">
                    <div style="background: #ff0000; color: white; text-align: center; padding: 8px; border: 4px solid #000; margin: 8px 0;">
                        <div style="font-size: 18pt; font-weight: bold; letter-spacing: 1px; border-bottom: 3px solid white; padding-bottom: 5px;">
                            âš ï¸ KAPIDA Ã–DEME âš ï¸
                        </div>
                        <div style="font-size: 32pt; font-weight: bold; margin: 8px 0; line-height: 1.2;">
                            ${kapidaOdemeTutari.toFixed(2)} TL
                        </div>
                        <div style="font-size: 14pt; font-weight: bold; background: white; color: #ff0000; padding: 4px; margin-top: 5px;">
                            TAHSÄ°L EDÄ°LECEK
                        </div>
                    </div>
                </div>`;
        } else {
            console.log('âŒ KapÄ±da Ã¶deme yok veya tutar 0');
        }

        const printContent = `
            <html><head><title>MÃ¼ÅŸteri Bilgileri - ${siparisNo}</title>
            <style>
                @page { 
                    size: 100mm 100mm; 
                    margin: 3mm; 
                }
                * {
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                }
                body { 
                    font-family: 'Arial Black', Arial, sans-serif; 
                    font-size: 9pt;
                    width: 94mm;
                    height: 94mm;
                    padding: 3mm;
                }
                .header {
                    font-size: 11pt;
                    font-weight: bold;
                    margin-bottom: 3mm;
                    padding-bottom: 2mm;
                    border-bottom: 2px solid #000;
                }
                .info-row { 
                    margin: 1mm 0;
                    font-size: 8pt;
                    line-height: 1.3;
                }
                .label { 
                    font-weight: bold;
                    display: inline-block;
                    width: 20mm;
                }
                .adres { 
                    white-space: pre-line;
                    margin: 2mm 0;
                    font-size: 8pt;
                    line-height: 1.3;
                    max-height: 15mm;
                    overflow: hidden;
                }
                .kapida-odeme-box { 
                    break-inside: avoid;
                    page-break-inside: avoid;
                    margin: 3mm 0;
                }
                .footer {
                    position: absolute;
                    bottom: 3mm;
                    left: 3mm;
                    right: 3mm;
                    text-align: center;
                    font-size: 7pt;
                    border-top: 1px solid #ccc;
                    padding-top: 1mm;
                }
            </style></head><body>
                <div class="header">KARGO BÄ°LGÄ°LERÄ°</div>
                <div class="info-row"><span class="label">SipariÅŸ:</span> ${siparisNo}</div>
                <div class="info-row"><span class="label">AlÄ±cÄ±:</span> ${musteriAdi} ${musteriSoyadi}</div>
                <div class="info-row"><span class="label">Telefon:</span> ${musteriTelefon}</div>
                <div class="info-row"><span class="label">Adres:</span></div>
                <div class="adres">${musteriAdres}</div>
                ${kapidaOdemeHTML}
                <div class="footer">${new Date().toLocaleDateString('tr-TR')} ${new Date().toLocaleTimeString('tr-TR')}</div>
            </body></html>`;

        const printWindow = window.open('', '_blank', 'width=400,height=300');
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.focus(); // BazÄ± tarayÄ±cÄ±lar iÃ§in gerekli
        // Gecikmeli yazdÄ±rma, iÃ§eriÄŸin tam yÃ¼klenmesini saÄŸlar
        setTimeout(() => {
            printWindow.print();
            // printWindow.close(); // Otomatik kapatma istenirse
        }, 250);

    } catch (error) {
        console.error('MÃ¼ÅŸteri bilgileri yazdÄ±rma hatasÄ±:', error);
        alert('MÃ¼ÅŸteri bilgileri yazdÄ±rÄ±lÄ±rken bir hata oluÅŸtu.');
    }
}

</script>
  <div id="toastContainer"></div>

<!-- KullanÄ±m Bilgisi Modal -->
<div id="usageInfoModal" style="display:none;position:fixed;z-index:9999;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5)">
  <div style="background-color:white;margin:5% auto;padding:0;width:90%;max-width:900px;border-radius:10px;max-height:85vh;overflow-y:auto">
    <div style="background:#B76E79;color:white;padding:20px;border-radius:10px 10px 0 0">
      <h3 style="margin:0"><i class="bi bi-info-circle"></i> SipariÅŸler SayfasÄ± - KullanÄ±m KÄ±lavuzu</h3>
      <button onclick="document.getElementById('usageInfoModal').style.display='none'" 
              style="position:absolute;top:15px;right:20px;background:none;border:none;color:white;font-size:30px;cursor:pointer">&times;</button>
    </div>
    <div style="padding:30px;line-height:1.8">
      
      <!-- NASIL KULLANILIR -->
      <div style="background:#f8f9fa;padding:20px;border-radius:8px;margin-bottom:25px">
        <h4 style="color:#B76E79;margin-bottom:15px"><i class="bi bi-book"></i> NASIL KULLANILIR?</h4>
        
        <div style="margin-bottom:20px">
          <h5 style="color:#212529"><i class="bi bi-1-circle-fill text-success"></i> Yeni SipariÅŸ OluÅŸturma</h5>
          <ol style="margin-left:20px">
            <li><strong>"Yeni SipariÅŸ OluÅŸtur"</strong> butonuna tÄ±klayÄ±n</li>
            <li><strong>MÃ¼ÅŸteri Bilgilerini</strong> doldurun (Ad, Soyad, Telefon, Adres)</li>
            <li><strong>ÃœrÃ¼n Ekleyin:</strong>
              <ul>
                <li>Barkod alanÄ±na Ã¼rÃ¼n barkodunu yazÄ±n</li>
                <li>"Ara" butonuna tÄ±klayÄ±n</li>
                <li>ÃœrÃ¼n bilgileri gelecek, adet ve fiyat kontrol edin</li>
                <li>"Ekle" butonuna basÄ±n</li>
                <li>Birden fazla Ã¼rÃ¼n ekleyebilirsiniz</li>
              </ul>
            </li>
            <li><strong>KapÄ±da Ã–deme:</strong> EÄŸer kapÄ±da Ã¶deme varsa checkbox'Ä± iÅŸaretleyin ve tutarÄ± girin</li>
            <li><strong>SipariÅŸ Durumu:</strong> VarsayÄ±lan "Yeni SipariÅŸ" olarak gelir, deÄŸiÅŸtirebilirsiniz</li>
            <li><strong>"SipariÅŸi Kaydet"</strong> butonuna tÄ±klayÄ±n</li>
          </ol>
        </div>

        <div style="margin-bottom:20px">
          <h5 style="color:#212529"><i class="bi bi-2-circle-fill text-info"></i> SipariÅŸ YÃ¶netimi</h5>
          <ul style="margin-left:20px">
            <li><strong>Durum DeÄŸiÅŸtirme:</strong> Her sipariÅŸ kartÄ±ndaki dropdown'dan durumu deÄŸiÅŸtirin (Yeni SipariÅŸ â†’ HazÄ±rlanÄ±yor â†’ Kargoya HazÄ±r â†’ Kargoda â†’ Teslim Edildi)</li>
            <li><strong>Detay GÃ¶rÃ¼ntÃ¼leme:</strong> "Detay" butonuyla sipariÅŸteki Ã¼rÃ¼nleri, raf kodlarÄ±nÄ± gÃ¶rÃ¼n</li>
            <li><strong>MÃ¼ÅŸteri Etiketi:</strong> "MÃ¼ÅŸteri" butonuyla 100x100mm etiket yazdÄ±rÄ±n (kapÄ±da Ã¶deme varsa kÄ±rmÄ±zÄ± kutu ile gÃ¶sterilir)</li>
            <li><strong>SipariÅŸ Silme:</strong> "Sil" butonuyla sipariÅŸi tamamen kaldÄ±rabilirsiniz</li>
          </ul>
        </div>

        <div style="margin-bottom:20px">
          <h5 style="color:#212529"><i class="bi bi-3-circle-fill text-warning"></i> Toplu Ä°ÅŸlemler</h5>
          <ul style="margin-left:20px">
            <li><strong>"TÃ¼mÃ¼nÃ¼ SeÃ§":</strong> TÃ¼m sipariÅŸleri seÃ§er</li>
            <li><strong>Checkbox:</strong> Ä°stediÄŸiniz sipariÅŸleri tek tek seÃ§in</li>
            <li><strong>"SeÃ§ili SipariÅŸleri Sil":</strong> SeÃ§ili olanlarÄ± toplu siler</li>
            <li><strong>"SeÃ§imi KaldÄ±r":</strong> TÃ¼m seÃ§imleri iptal eder</li>
          </ul>
        </div>

        <div style="background:#fff3cd;padding:15px;border-left:4px solid #ffc107;border-radius:5px">
          <strong><i class="bi bi-exclamation-triangle text-warning"></i> Ã–NEMLÄ°:</strong>
          <ul style="margin:10px 0 0 20px">
            <li>ÃœrÃ¼n eklerken otomatik olarak <strong>en fazla stoklu raftan</strong> tahsis edilir</li>
            <li>Stok hem <strong>raf</strong> hem de <strong>merkez stok</strong>tan dÃ¼ÅŸer</li>
            <li>Silinen sipariÅŸler <strong>geri alÄ±namaz</strong>, stok iade edilmez</li>
            <li>KapÄ±da Ã¶deme etiketi <strong>100mm x 100mm</strong> termal yazÄ±cÄ± iÃ§in optimize edilmiÅŸtir</li>
          </ul>
        </div>
      </div>

      <!-- TEKNÄ°K DETAYLAR -->
      <div style="background:#e7f3ff;padding:20px;border-radius:8px">
        <h4 style="color:#0066cc;margin-bottom:15px"><i class="bi bi-gear"></i> TEKNÄ°K DETAYLAR</h4>
        
        <div style="margin-bottom:15px">
          <h5 style="color:#212529"><i class="bi bi-file-code"></i> Backend DosyalarÄ± (Python)</h5>
          <table style="width:100%;border-collapse:collapse">
            <tr style="background:#f8f9fa">
              <th style="padding:10px;text-align:left;border:1px solid #dee2e6;width:30%">Dosya</th>
              <th style="padding:10px;text-align:left;border:1px solid #dee2e6">GÃ¶revi</th>
            </tr>
            <tr>
              <td style="padding:10px;border:1px solid #dee2e6"><code>siparisler.py</code></td>
              <td style="padding:10px;border:1px solid #dee2e6">
                Ana route dosyasÄ±. TÃ¼m sipariÅŸ iÅŸlemlerini yÃ¶netir:<br>
                â€¢ <code>/yeni-siparis</code> - Liste gÃ¶sterimi ve sipariÅŸ oluÅŸturma<br>
                â€¢ <code>/siparis-detay/&lt;no&gt;</code> - SipariÅŸ detaylarÄ±<br>
                â€¢ <code>/siparis-musteri-bilgisi/&lt;no&gt;</code> - MÃ¼ÅŸteri bilgisi JSON<br>
                â€¢ <code>/siparis-durum-guncelle/&lt;no&gt;</code> - Durum deÄŸiÅŸtirme<br>
                â€¢ <code>/siparis-sil/&lt;no&gt;</code> - Tekil silme<br>
                â€¢ <code>/siparis-toplu-sil</code> - Toplu silme
              </td>
            </tr>
            <tr style="background:#f8f9fa">
              <td style="padding:10px;border:1px solid #dee2e6"><code>models.py</code></td>
              <td style="padding:10px;border:1px solid #dee2e6">
                VeritabanÄ± modelleri tanÄ±mlÄ±:<br>
                â€¢ <code>YeniSiparis</code> - SipariÅŸ bilgileri (mÃ¼ÅŸteri, tutar, kapÄ±da Ã¶deme)<br>
                â€¢ <code>SiparisUrun</code> - SipariÅŸteki Ã¼rÃ¼nler (barkod, adet, fiyat, raf_kodu)<br>
                â€¢ <code>RafUrun</code> - Raf stok bilgileri<br>
                â€¢ <code>CentralStock</code> - Merkez stok bilgileri<br>
                â€¢ <code>Product</code> - ÃœrÃ¼n bilgileri (model, renk, beden, gÃ¶rsel)
              </td>
            </tr>
            <tr>
              <td style="padding:10px;border:1px solid #dee2e6"><code>app.py</code></td>
              <td style="padding:10px;border:1px solid #dee2e6">Ana Flask uygulamasÄ±. Blueprint'leri register eder</td>
            </tr>
          </table>
        </div>

        <div style="margin-bottom:15px">
          <h5 style="color:#212529"><i class="bi bi-file-earmark-code"></i> Frontend DosyalarÄ± (HTML/CSS/JS)</h5>
          <table style="width:100%;border-collapse:collapse">
            <tr style="background:#f8f9fa">
              <th style="padding:10px;text-align:left;border:1px solid #dee2e6;width:30%">Dosya</th>
              <th style="padding:10px;text-align:left;border:1px solid #dee2e6">GÃ¶revi</th>
            </tr>
            <tr>
              <td style="padding:10px;border:1px solid #dee2e6"><code>yeni_siparis.html</code></td>
              <td style="padding:10px;border:1px solid #dee2e6">
                Ana sayfa template'i. Ä°Ã§erir:<br>
                â€¢ SipariÅŸ listesi (card layout)<br>
                â€¢ SipariÅŸ oluÅŸturma formu<br>
                â€¢ JavaScript fonksiyonlarÄ± (AJAX, form iÅŸlemleri)<br>
                â€¢ CSS stil tanÄ±mlamalarÄ±<br>
                â€¢ Modal'lar (detay, toplu Ã¼rÃ¼n ekleme)
              </td>
            </tr>
            <tr style="background:#f8f9fa">
              <td style="padding:10px;border:1px solid #dee2e6"><code>siparis_detay_partial.html</code></td>
              <td style="padding:10px;border:1px solid #dee2e6">
                SipariÅŸ detay modal iÃ§eriÄŸi. GÃ¶sterir:<br>
                â€¢ SipariÅŸ bilgileri<br>
                â€¢ MÃ¼ÅŸteri bilgileri (kapÄ±da Ã¶deme uyarÄ±sÄ± ile)<br>
                â€¢ ÃœrÃ¼n listesi (gÃ¶rsel, barkod, raf kodu, fiyat)
              </td>
            </tr>
            <tr>
              <td style="padding:10px;border:1px solid #dee2e6"><code>base.html</code></td>
              <td style="padding:10px;border:1px solid #dee2e6">Ana layout template. Menu ve footer iÃ§erir</td>
            </tr>
          </table>
        </div>

        <div style="margin-bottom:15px">
          <h5 style="color:#212529"><i class="bi bi-database"></i> VeritabanÄ± TablolarÄ±</h5>
          <table style="width:100%;border-collapse:collapse">
            <tr style="background:#f8f9fa">
              <th style="padding:10px;text-align:left;border:1px solid #dee2e6;width:30%">Tablo</th>
              <th style="padding:10px;text-align:left;border:1px solid #dee2e6">Ã–nemli SÃ¼tunlar</th>
            </tr>
            <tr>
              <td style="padding:10px;border:1px solid #dee2e6"><code>yeni_siparisler</code></td>
              <td style="padding:10px;border:1px solid #dee2e6">
                siparis_no, musteri_adi, musteri_soyadi, musteri_telefon, musteri_adres, 
                toplam_tutar, durum, siparis_tarihi, <strong>kapida_odeme (Boolean)</strong>, 
                <strong>kapida_odeme_tutari (Numeric)</strong>, notlar
              </td>
            </tr>
            <tr style="background:#f8f9fa">
              <td style="padding:10px;border:1px solid #dee2e6"><code>siparis_urunler</code></td>
              <td style="padding:10px;border:1px solid #dee2e6">
                siparis_id, urun_barkod, urun_adi, adet, birim_fiyat, toplam_fiyat, 
                renk, beden, urun_gorseli, <strong>raf_kodu (String)</strong>
              </td>
            </tr>
          </table>
        </div>

        <div style="background:#d1ecf1;padding:15px;border-left:4px solid #0dcaf0;border-radius:5px">
          <strong><i class="bi bi-lightbulb text-info"></i> Ä°Å AKIÅI:</strong>
          <ol style="margin:10px 0 0 20px">
            <li>KullanÄ±cÄ± form doldurur â†’ JavaScript AJAX ile <code>/yeni-siparis</code> POST</li>
            <li>Backend (<code>siparisler.py</code>) Ã¼rÃ¼nleri alÄ±r</li>
            <li>Her Ã¼rÃ¼n iÃ§in <code>allocate_from_shelf_and_decrement()</code> Ã§aÄŸrÄ±lÄ±r</li>
            <li>En yÃ¼ksek stoÄŸa sahip raf bulunur (<code>RafUrun</code>)</li>
            <li>Stok dÃ¼ÅŸÃ¼rÃ¼lÃ¼r (hem <code>RafUrun</code> hem <code>CentralStock</code>)</li>
            <li>Raf kodu Ã¼rÃ¼n kaydÄ±na eklenir</li>
            <li>SipariÅŸ ve Ã¼rÃ¼nler veritabanÄ±na kaydedilir</li>
            <li>Sayfa yenilenir ve yeni sipariÅŸ listede gÃ¶rÃ¼nÃ¼r</li>
          </ol>
        </div>
      </div>

    </div>
  </div>
</div>

{% endblock %}