<!doctype html>
<html lang="tr">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Paketleme Ekranı - Güllü Ayakkabı</title>
        <link
            rel="stylesheet"
            href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
        />
        <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
        />
        <style>
            /* Sayfa Düzeni */
            body {
                margin: 0;
                padding: 0;
                font-family: "Roboto", sans-serif;
                background-color: #f5f5f5;
            }
            /* Canvas: Arka plan */
            #weatherCanvas {
                position: fixed;
                top: 0;
                left: 0;
                z-index: -1; /* İçeriklerin arkasında */
                width: 100vw;
                height: 100vh;
            }
            .container {
                max-width: 1200px;
                margin-top: 60px; /* Mevcut değerini koruduk */
                margin-left: auto; /* Ortalamak için */
                margin-right: auto; /* Ortalamak için */
                padding: 0 15px; /* Sağ ve sol iç boşluk */
            }
            .user-info {
                position: fixed;
                top: 15px;
                left: 20px;
                z-index: 10;
                font-size: 14px;
                color: #333;
                display: flex;
                align-items: center;
                gap: 10px;
            }
            .user-info img {
                max-width: 100px;
                height: auto;
                border-radius: 5px;
            }
            .btn-group-top {
                position: fixed;
                top: 15px;
                right: 20px;
                display: flex;
                gap: 10px;
                z-index: 10;
                flex-wrap: wrap; /* Sığmazsa alt satıra insin */
                justify-content: flex-end; /* Sağa hizala */
                align-items: center; /* Dikeyde ortala */
            }

            /* Ortak buton görünümü */
            .btn {
                border-radius: 20px;
                padding: 10px 20px;
                font-size: 0.9rem;
                transition: all 0.3s ease;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                border: none;
                color: #fff;
            }
            .btn:hover {
                transform: scale(1.05);
                text-decoration: none;
                color: #fff; /* Hover'da yazı rengi değişmesin */
            }

            /* Bootstrap renk sınıflarını gradientlerle override edelim */
            .btn-secondary {
                background: linear-gradient(
                    to right,
                    #757f9a,
                    #d7dde8
                ); /* Gri tonlu */
                color: #fff;
            }
            .btn-warning {
                background: linear-gradient(
                    to right,
                    #f7971e,
                    #ffd200
                ); /* Turuncu-sarı */
                color: #fff;
            }
            .btn-primary {
                background: linear-gradient(
                    to right,
                    #2193b0,
                    #6dd5ed
                ); /* Mavi tonlu */
                color: #fff;
            }
            .btn-success {
                background: linear-gradient(
                    to right,
                    #56ab2f,
                    #a8e063
                ); /* Yeşil tonlu */
                color: #fff;
            }
            .btn-info {
                background: linear-gradient(
                    to right,
                    #667db6,
                    #0082c8,
                    #0082c8,
                    #667db6
                ); /* Mavi tonlu */
                color: #fff;
            }
            .btn-danger {
                background: linear-gradient(
                    to right,
                    #cb2d3e,
                    #ef473a
                ); /* Kırmızı tonlu */
                color: #fff;
            }
            .btn-dark {
                background: linear-gradient(
                    to right,
                    #343a40,
                    #495057
                ); /* Koyu gri tonlu */
                color: #fff;
            }
            /* Disabled buton rengi */
            .btn.disabled,
            .btn:disabled {
                background-color: #cccccc; /* Pasif buton arka plan */
                background-image: none; /* Gradient'i kaldır */
                cursor: not-allowed;
                opacity: 0.7;
            }

            /* Dropdown görünümü */
            .dropdown-toggle {
                border-radius: 20px !important; /* Arada .btn sınıfı da var, override için !important */
            }
            .dropdown-menu {
                border-radius: 10px;
                padding: 0.5rem 0;
                background-color: #fff;
                border: none;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            }
            .dropdown-item {
                font-size: 0.85rem;
                padding: 0.5rem 1rem;
                color: #333;
                transition: background-color 0.3s ease;
            }
            .dropdown-item:hover {
                background-color: #efefef;
            }

            .order-container {
                display: flex;
                flex-wrap: wrap;
                gap: 20px;
                align-items: flex-start;
                justify-content: center; /* Kartları ortala */
            }
            .card {
                width: 200px;
                border: none;
                border-radius: 10px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
                margin-bottom: 20px;
                transition: transform 0.2s;
                overflow: hidden; /* Resim köşeleri için */
                background-color: #fff;
            }
            .card:hover {
                transform: translateY(-5px);
                box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            }
            .product-image {
                width: 100%;
                height: 180px; /* Sabit yükseklik */
                border-radius: 10px 10px 0 0;
                object-fit: cover; /* Resmin orantısını koru */
                cursor: zoom-in; /* Büyütme imleci */
            }
            .card-title {
                font-weight: bold;
                color: #444;
                text-align: center;
                margin: 10px 0;
                white-space: nowrap; 
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .card-text {
                font-size: 0.9rem;
                color: #666;
                text-align: center;
            }
            .form-control {
                border-radius: 10px;
                padding: 8px;
                font-size: 0.85rem;
                box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
                border: 1px solid #ddd;
            }
            .form-control:focus {
                border-color: #6dd5ed;
                box-shadow:
                    inset 0 1px 3px rgba(0, 0, 0, 0.1),
                    0 0 5px rgba(109, 213, 237, 0.5);
            }

            .form-group {
                position: relative;
                margin-bottom: 35px;
            }
            .alert {
                position: absolute;
                top: -30px;
                left: 0;
                right: 0;
                font-size: 12px;
                padding: 5px;
                border-radius: 5px;
                opacity: 0;
                transition: opacity 0.3s ease;
                text-align: center;
                z-index: 10;
                pointer-events: none;
                width: 100%; 
                box-sizing: border-box;
                visibility: hidden;
            }
            .alert-show {
                opacity: 1;
                visibility: visible;
            }
            .alert-success {
                background-color: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }
            .alert-danger {
                background-color: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }

            #autoShipMessage {
                position: fixed;
                top: 80px; 
                left: 0;
                right: 0;
                background-color: #e9ffe9;
                color: #155724; 
                padding: 10px 20px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
                z-index: 9; 
                opacity: 0;
                visibility: hidden;
                transition:
                    opacity 0.5s ease,
                    visibility 0.5s ease;
                font-size: 1rem;
                text-align: center;
                font-weight: bold;
                border-bottom: 1px solid #c3e6cb;
            }
            #autoShipMessage.show {
                opacity: 1;
                visibility: visible;
            }

            .copy-container {
                position: relative;
                cursor: pointer;
                display: inline-block;
                margin-left: 5px;
                color: #007bff;
                transition: color 0.2s ease;
            }
            .copy-container:hover {
                color: #0056b3;
            }
            .copy-confirmation {
                color: green;
                font-size: 1em;
                margin-left: 5px;
                display: none;
            }
            .copy-confirmation.show {
                display: inline-block;
            }
            .btn-bottom {
                max-width: 200px;
                margin: 10px 0;
                padding: 8px 15px;
                border-radius: 10px;
            }
            .bottom-buttons {
                text-align: left;
                margin-top: 20px;
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
            }
            .fixed-header {
                background-color: #ffffff;
                border-radius: 10px;
                padding: 15px;
                margin-top: 20px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
                z-index: auto;
            }
            .fixed-header h4 {
                margin-top: 0;
                margin-bottom: 10px;
                color: #333;
            }
            .fixed-header p {
                margin: 0;
                line-height: 1.5;
                color: #555;
            }
            .fixed-header .copy-container {
                color: #555;
            }

            .modal-content {
                border-radius: 15px;
                padding: 20px;
            }
            .modal-header {
                border-bottom: none;
                justify-content: center;
            }
            .modal-footer {
                border-top: none;
                justify-content: center;
            }
            .highlight-quantity {
                color: red;
                font-size: 1.3em;
                font-weight: bold;
            }
            /* RESİM BÜYÜTME (LIGHTBOX) STİLİ */
            #lightbox {
                position:fixed;
                top:0;
                left:0;
                width:100%;
                height:100%;
                background:rgba(0,0,0,0.7);
                backdrop-filter: blur(5px);
                display:none;
                align-items:center;
                justify-content:center;
                z-index:1050; /* Modalların üstünde */
                cursor: zoom-out;
            }
            #lightbox img {
                max-width: 90%;
                max-height: 90%;
                box-shadow: 0 0 25px rgba(0,0,0,0.5);
                border-radius: 5px;
            }
            .custom-control {
                position: relative; 
                display: inline-flex; 
                min-height: 1.5rem; 
                padding-left: 1.5rem; 
                align-items: center; 
            }
            .custom-switch {
                padding-left: 2.25rem;
            }
            .custom-control-input {
                position: absolute;
                left: 0;
                z-index: -1;
                width: 1rem;
                height: 1.25rem;
                opacity: 0;
            }
            .custom-control-label {
                margin-bottom: 0;
                line-height: 1.5;
                cursor: pointer;
            }
            .custom-control-label::before {
                position: absolute;
                top: 0.25rem;
                left: -2.25rem;
                display: block;
                width: 1.75rem; 
                height: 1rem;
                pointer-events: none;
                content: "";
                background-color: #adb5bd; 
                border: #adb5bd solid 1px; 
                border-radius: 1rem; 
                transition:
                    background-color 0.15s ease-in-out,
                    border-color 0.15s ease-in-out,
                    box-shadow 0.15s ease-in-out;
            }
            .custom-control-label::after {
                position: absolute;
                top: 0.25rem;
                left: -2rem; 
                display: block;
                width: 1rem; 
                height: 1rem;
                content: "";
                background-color: #fff; 
                border-radius: 1rem;
                transition:
                    transform 0.15s ease-in-out,
                    background-color 0.15s ease-in-out,
                    border-color 0.15s ease-in-out,
                    box-shadow 0.15s ease-in-out;
            }
            .custom-switch
                .custom-control-input:checked
                ~ .custom-control-label::before {
                color: #fff;
                border-color: #28a745;
                background-color: #28a745;
            }
            .custom-switch
                .custom-control-input:checked
                ~ .custom-control-label::after {
                transform: translateX(0.75rem);
            }

            @media (max-width: 768px) {
                .btn {
                    font-size: 0.8rem;
                    padding: 8px 12px;
                }
                .card-title {
                    font-size: 0.9rem;
                }
                .card-text {
                    font-size: 0.8rem;
                }
                .user-info img {
                    max-width: 70px;
                }
                .user-info {
                    top: 10px;
                    left: 10px;
                    gap: 5px;
                    font-size: 12px;
                }
                .user-info img {
                    max-width: 60px;
                }
                .btn-group-top {
                    top: 10px;
                    right: 10px;
                    gap: 5px;
                    flex-direction: column; 
                    align-items: flex-end; 
                }
                .btn {
                    width: 100%;
                    text-align: center;
                    padding: 6px 10px;
                    font-size: 0.8rem;
                }
                .dropdown-toggle {
                    width: 100%;
                    text-align: center !important;
                }
                .dropdown-menu {
                    left: auto !important;
                    right: 0 !important;
                    min-width: auto;
                    width: auto;
                }
                .dropdown-item {
                    text-align: right;
                    font-size: 0.8rem;
                }
                .custom-switch {
                    margin-top: 10px;
                    width: 100%;
                    justify-content: flex-end;
                    padding-right: 2.25rem;
                    padding-left: 0;
                }
                .custom-control-label::before {
                    left: auto;
                    right: 0;
                }
                .custom-control-label::after {
                    left: auto;
                    right: 0.25rem;
                }
                .custom-switch
                    .custom-control-input:checked
                    ~ .custom-control-label::after {
                    transform: translateX(
                        -0.75rem
                    );
                }
                #autoShipMessage {
                    top: 120px;
                    padding: 8px 10px;
                    font-size: 0.9rem;
                }
                .container {
                    margin-top: 180px;
                    padding: 0 10px;
                }
                .fixed-header {
                    margin-top: 10px;
                    padding: 10px;
                }
            }
            @media (max-width: 576px) {
                /* Çok küçük ekranlar */
                .card {
                    width: calc(50% - 15px);
                }
            }
        </style>
    </head>
    <body>
        <canvas id="weatherCanvas"></canvas>
        <div id="lightbox"><img src="" alt="Büyütülmüş Ürün Görseli"></div>

        <div class="user-info">
            <img src="{{ url_for('static', filename='logo/gullu.png') }}" alt="Güllü Shoes Logo" />
            Giriş Yapan:
            <strong>{{ session['first_name'] }} {{ session['last_name'] }}</strong>
        </div>

        <div class="btn-group-top">
            <a href="{{ url_for('home.home') }}" class="btn btn-secondary">Anasayfa</a>
            <a href="{{ url_for('display_archive') }}" class="btn btn-secondary">Arşiv</a>
            <div class="dropdown">
                <button class="btn btn-warning dropdown-toggle" type="button" id="kullaniciMenu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Kullanıcı İşlemleri
                </button>
                <div class="dropdown-menu" aria-labelledby="kullaniciMenu">
                    <a class="dropdown-item" href="{{ url_for('approve_users') }}">Kullanıcı Yönetimi</a>
                    {% if session['role'] in ['admin', 'manager'] %}
                    <a class="dropdown-item" href="{{ url_for('user_logs.view_logs') }}">
                        <i class="fas fa-history"></i> Kullanıcı Hareketleri
                    </a>
                    {% endif %}
                </div>
            </div>
            <div class="dropdown">
                <button class="btn btn-primary dropdown-toggle" type="button" id="siparisMenu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Sipariş İşlemleri
                </button>
                <div class="dropdown-menu" aria-labelledby="siparisMenu">
                    <a class="dropdown-item" href="{{ url_for('siparisler_bp.yeni_siparis') }}">Yeni Sipariş</a>
                    <a class="dropdown-item" href="{{ url_for('order_list_all') }}">Sipariş Listesi</a>
                    <a class="dropdown-item" href="{{ url_for('degisim_talep') }}">Değişim Talepleri</a>
                </div>
            </div>
            <div class="dropdown">
                <button class="btn btn-success dropdown-toggle" type="button" id="urunMenu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Ürün İşlemleri
                </button>
                <div class="dropdown-menu" aria-labelledby="urunMenu">
                    <a class="dropdown-item" href="{{ url_for('siparis_fisi_bp.siparis_fisi_sayfasi') }}">Ürün Tedarik Sayfası</a>
                    <a class="dropdown-item" href="{{ url_for('raf.raf_form_sayfasi') }}">Raf Oluştur</a>
                    <a class="dropdown-item" href="{{ url_for('product_list') }}">Ürün Listesi</a>
                    <a class="dropdown-item" href="{{ url_for('stock_management.stock_addition_page') }}">Stok Ekleme</a>
                    <a class="dropdown-item" href="{{ url_for('iade_listesi') }}">İade Listesi</a>
                </div>
            </div>
            <div class="dropdown">
                <button class="btn btn-info dropdown-toggle" type="button" id="analizMenu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Analizler
                </button>
                <div class="dropdown-menu" aria-labelledby="analizMenu">
                    <a class="dropdown-item" href="{{ url_for('analysis.sales_analysis') }}">Satış Analizi</a>
                    <a class="dropdown-item" href="{{ url_for('openai_bp.ai_analiz') }}">AI Analiz</a>
                    <a class="dropdown-item" href="{{ url_for('commission_update_bp.update_commission_from_excel') }}">Excel Komisyon Yükle</a>
                    <a class="dropdown-item" href="/intelligent-stock/">🧠 Stok Zekası Paneli</a>
                </div>
            </div>
            {% if session['role'] in ['admin', 'manager'] %}
            <a href="{{ url_for('kasa.kasa_sayfasi') }}" class="btn btn-dark">
                <i class="fas fa-cash-register"></i> Kasa
            </a>
            {% endif %}
            <div class="custom-control custom-switch">
                <input type="checkbox" class="custom-control-input" id="autoShipToggle" />
                <label class="custom-control-label" for="autoShipToggle">Otomatik Gönderim</label>
            </div>
        </div>

        <div id="autoShipMessage">
            <strong>Otomatik Gönderim Aktif:</strong> Kargo kodu:
            <span id="autoShipBarcode"></span>
        </div>

        <div class="container">
            <form method="POST" action="{{ url_for('update_service.confirm_packing') }}" id="packingForm" autocomplete="off">
                <input type="hidden" name="order_number" value="{{ order.order_number if order else '' }}" />

                <div class="order-container">
                    {% for product in order.products if order %}
                    <div class="col-sm-6 col-md-4 col-lg-3 col-xl-2">
                        <div class="card product-card">
                            <img src="{{ product['image_url'] }}" alt="Ürün Görseli" class="card-img-top product-image" />
                            <div class="card-body">
                                <h5 class="card-title">{{ product['sku'] }}</h5>
                                <p class="card-text">
                                    <strong>Miktar:</strong>
                                    <span class="{% if product['quantity']|int > 1 %}highlight-quantity{% endif %}">
                                        {{ product['quantity'] }}
                                    </span>
                                </p>
                                <p class="card-text">
                                    <strong>Barkod:</strong>
                                    <span id="productBarcode-{{ loop.index0 }}">{{ product['barcode'] }}</span>
                                    <span class="copy-container">
                                        <span class="clipboard-icon" onclick="copyToClipboard('productBarcode-{{ loop.index0 }}', this)">📋</span>
                                        <span class="copy-confirmation">✔️</span>
                                    </span>
                                </p>
                                <div class="card-text">
                                    {% if product['raflar'] %}
                                    <p style="margin-bottom: 5px;"><strong>Raf Bilgisi:</strong></p>
                                    <ul style="padding-left: 20px; text-align: left; margin-bottom: 10px; list-style-position: inside;">
                                        {% for raf in product['raflar'] %}
                                        <li>{{ raf.kod }} &mdash; {{ raf.adet }} adet</li>
                                        {% endfor %}
                                    </ul>
                                    {% else %}
                                    <p><em>Bu ürün rafta kayıtlı değil.</em></p>
                                    {% endif %}
                                </div>

                                {% for q in range(product['quantity']|int) %}
                                <div class="form-group">
                                    <div id="barkodMatchMessage-right-{{ loop.index0 }}-{{ q }}" class="alert"></div>
                                    <input
                                        type="text"
                                        class="form-control barkod-input"
                                        data-product-index="{{ loop.index0 }}"
                                        data-quantity-index="{{ q }}"
                                        data-side="right"
                                        id="barkodInput-right-{{ loop.index0 }}-{{ q }}"
                                        name="barkod_right_{{ loop.index0 }}_{{ q }}"
                                        placeholder="{{ product['sku'] }} Sağ Tek ({{ q+1 }})"
                                        required
                                        autocomplete="off"
                                    />
                                </div>
                                <div class="form-group">
                                    <div id="barkodMatchMessage-left-{{ loop.index0 }}-{{ q }}" class="alert"></div>
                                    <input
                                        type="text"
                                        class="form-control barkod-input"
                                        data-product-index="{{ loop.index0 }}"
                                        data-quantity-index="{{ q }}"
                                        data-side="left"
                                        id="barkodInput-left-{{ loop.index0 }}-{{ q }}"
                                        name="barkod_left_{{ loop.index0 }}_{{ q }}"
                                        placeholder="{{ product['sku'] }} Sol Tek ({{ q+1 }})"
                                        required
                                        autocomplete="off"
                                    />
                                </div>
                                {% endfor %}
                                {% for q in range(product['quantity']|int) %}
                                    <input type="hidden" id="expectedBarcode-right-{{ loop.index0 }}-{{ q }}" value="{{ product['barcode'] }}" />
                                    <input type="hidden" id="expectedBarcode-left-{{ loop.index0 }}-{{ q }}" value="{{ product['barcode'] }}" />
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% else %}
                        <p class="text-center w-100">İşlenecek yeni sipariş bulunamadı.</p>
                    {% endfor %}
                </div>

                <div class="bottom-buttons">
                    <button type="submit" class="btn btn-primary btn-bottom disabled" id="onaylaBtn" disabled>
                        Paketlemeyi Onayla
                    </button>
                </div>
            </form>

            <div class="bottom-buttons">
                <form method="POST" action="{{ url_for('order_label') }}" target="_blank" id="yazdirForm" autocomplete="off">
                    <input type="hidden" name="order_number" value="{{ order.order_number if order else '' }}" />
                    <input type="hidden" name="shipping_barcode" value="{{ order.shipping_barcode if order else '' }}" />
                    <input type="hidden" name="cargo_provider" value="{{ order.cargo_provider_name if order else '' }}" />
                    <input type="hidden" name="customer_name" value="{{ order.customer_name if order else '' }}" />
                    <input type="hidden" name="customer_surname" value="{{ order.customer_surname if order else '' }}" />
                    <input type="hidden" name="customer_address" value="{{ order.customer_address if order else '' }}" />
                    <button type="submit" class="btn btn-warning btn-bottom disabled" id="yazdirBtn" disabled>
                        Yazdır
                    </button>
                </form>
                {% if order %}
                <button type="button" class="btn btn-danger btn-bottom" onclick="showArchiveModal('{{ order.order_number }}')">
                    Arşive Gönder
                </button>
                {% endif %}
            </div>

            {% if order %}
            <div class="fixed-header">
                <h4>Kargo Bilgileri</h4>
                <p>
                    <strong>Sipariş No:</strong> {{ order.order_number }}<br />
                    <strong>Müşteri:</strong> {{ order.customer_name }} {{ order.customer_surname }}<br />
                    <strong>Kargoya Kalan Süre:</strong> {{ remaining_time }}<br />
                    <strong>Kargo Firması:</strong> {{ order.cargo_provider_name }}<br />
                    <strong>Kargo Kodu:</strong>
                    <span id="shippingBarcode">{{ order.shipping_barcode }}</span>
                    <span class="copy-container">
                        <span class="clipboard-icon" onclick="copyToClipboard('shippingBarcode', this)">📋</span>
                        <span class="copy-confirmation">✔️</span>
                    </span>
                </p>
            </div>
            {% endif %}

            <div class="modal fade" id="archiveModal" tabindex="-1" aria-labelledby="archiveModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <form id="archiveForm">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Siparişi Arşivle</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Kapat">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <input type="hidden" id="archiveOrderNumber" name="order_number" />

                                <div class="form-group">
                                    <label for="archiveReason">Arşivleme Sebebi</label>
                                    <select id="archiveReason" name="archive_reason" class="form-control" required>
                                        <option value="">Sebep Seçin</option>
                                        <option value="Stok Yok">Stok Tükendi</option>
                                        <option value="Stok Yok">Ürün Sorunu Düzeltiliyor</option>
                                        <option value="Kusurlu Ürün">Kusurlu Ürün</option>
                                        <option value="Diğer">Diğer</option>
                                    </select>
                                </div>

                                <div class="form-group" id="otherReasonDiv" style="display:none;">
                                    <label for="otherReasonText">Diğer Sebep Açıklaması</label>
                                    <textarea id="otherReasonText" name="other_reason" class="form-control" rows="3"></textarea>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-primary">Arşivle</button>
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">İptal</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>


    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.bundle.min.js"></script>

    <script>
    // Canvas Animasyon Script'i
    (function () {
        const canvas = document.getElementById("weatherCanvas");
        if (!canvas) return;
        const ctx = canvas.getContext("2d");

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener("resize", resizeCanvas);
        resizeCanvas();

        function getIstanbulTime() {
            try {
                return new Date(
                    new Date().toLocaleString("en-US", {
                        timeZone: "Europe/Istanbul",
                    }),
                );
            } catch (e) {
                console.error("Saat dilimi hatası:", e);
                return new Date();
            }
        }

        function getIstanbulHour() {
            return getIstanbulTime().getHours();
        }

        function drawBackground() {
            const hour = getIstanbulHour();
            if (hour >= 6 && hour < 18) {
                ctx.fillStyle = "#87CEEB";
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                drawSun();
                drawClouds();
            } else {
                ctx.fillStyle = "#2c3e50";
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                drawMoon();
                drawStars();
            }
        }

        function drawSun() {
            const hour = getIstanbulHour();
            let progress = (hour - 6) / 12;
            const sunX = canvas.width * 0.1 + progress * canvas.width * 0.8;
            const sunY =
                canvas.height * 0.7 -
                Math.sin(progress * Math.PI) * canvas.height * 0.6;

            ctx.beginPath();
            const gradient = ctx.createRadialGradient(
                sunX,
                sunY,
                20,
                sunX,
                sunY,
                60,
            );
            gradient.addColorStop(0, "#FFD700");
            gradient.addColorStop(1, "#FFA500");
            ctx.fillStyle = gradient;
            ctx.arc(sunX, sunY, 60, 0, 2 * Math.PI);
            ctx.fill();
        }

        let clouds = [];
        const cloudCount = 5;

        function createCloud() {
            return {
                x: Math.random() * (canvas.width + 200) - 100,
                y: Math.random() * canvas.height * 0.3,
                width: 120 + Math.random() * 80,
                height: 60 + Math.random() * 20,
                speed: 0.3 + Math.random() * 0.5,
            };
        }

        function initClouds() {
            clouds = [];
            for (let i = 0; i < cloudCount; i++) {
                clouds.push(createCloud());
            }
        }

        initClouds();

        function drawClouds() {
            clouds.forEach((cloud) => {
                ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
                ctx.beginPath();
                ctx.arc(cloud.x, cloud.y, cloud.width * 0.3, 0, 2 * Math.PI);
                ctx.arc(
                    cloud.x + cloud.width * 0.3,
                    cloud.y - cloud.height * 0.2,
                    cloud.width * 0.25,
                    0,
                    2 * Math.PI,
                );
                ctx.arc(
                    cloud.x + cloud.width * 0.6,
                    cloud.y,
                    cloud.width * 0.35,
                    0,
                    2 * Math.PI,
                );
                ctx.arc(
                    cloud.x + cloud.width * 0.4,
                    cloud.y + cloud.height * 0.2,
                    cloud.width * 0.2,
                    0,
                    2 * Math.PI,
                );
                ctx.fill();
            });
            updateClouds();
        }

        function updateClouds() {
            clouds.forEach((cloud) => {
                cloud.x += cloud.speed;
                if (cloud.x - cloud.width > canvas.width) {
                    cloud.x = -cloud.width;
                    cloud.y = Math.random() * canvas.height * 0.3;
                    cloud.speed = 0.3 + Math.random() * 0.5;
                }
            });
        }

        function drawMoon() {
            const moonX = canvas.width * 0.8;
            const moonY = canvas.height * 0.2;

            ctx.beginPath();
            ctx.fillStyle = "#F0E68C";
            ctx.arc(moonX, moonY, 40, 0, 2 * Math.PI);
            ctx.fill();

            ctx.beginPath();
            ctx.fillStyle = "#2c3e50";
            ctx.arc(moonX + 15, moonY - 5, 40, 0, 2 * Math.PI);
            ctx.fill();
        }

        let stars = [];
        const starCount = 100;

        function createStar() {
            return {
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                radius: Math.random() * 1.2,
                alpha: Math.random() * 0.7 + 0.3,
            };
        }

        function initStars() {
            stars = [];
            for (let i = 0; i < starCount; i++) {
                stars.push(createStar());
            }
        }

        initStars();

        function drawStars() {
            ctx.fillStyle = "white";
            stars.forEach((star) => {
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.radius, 0, 2 * Math.PI);
                ctx.fillStyle = `rgba(255, 255, 255, ${star.alpha})`;
                ctx.fill();
                star.alpha += (Math.random() - 0.5) * 0.02;
                if (star.alpha > 1) star.alpha = 1;
                if (star.alpha < 0.3) star.alpha = 0.3;
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            drawBackground();
        }

        animate();
    })();
    </script>


    <script>
    // --- YENİ VE DÜZENLENMİŞ SCRIPT ---
    document.addEventListener('DOMContentLoaded', function () {
        const onaylaBtn = document.getElementById('onaylaBtn');
        const yazdirBtn = document.getElementById('yazdirBtn');
        const yazdirForm = document.getElementById('yazdirForm');
        const packingForm = document.getElementById('packingForm');
        const autoShipToggle = document.getElementById('autoShipToggle');
        const autoShipMessage = document.getElementById('autoShipMessage');
        const autoShipBarcodeSpan = document.getElementById('autoShipBarcode');
        const shippingBarcode = "{{ order.shipping_barcode if order else '' }}";
        const barkodInputs = document.querySelectorAll('.barkod-input');

        let printTimer = null;
        let confirmTimer = null;

        const savedToggleState = localStorage.getItem('autoShipEnabled');
        if (savedToggleState !== null) {
            autoShipToggle.checked = savedToggleState === 'true';
        }

        function clearAllTimersAndHideMessage() {
            if (printTimer) clearTimeout(printTimer);
            if (confirmTimer) clearTimeout(confirmTimer);
            autoShipMessage.classList.remove('show');
        }

        function showAutoShipMessage() {
            autoShipBarcodeSpan.innerText = shippingBarcode;
            autoShipMessage.classList.add('show');
            setTimeout(() => autoShipMessage.classList.remove('show'), 3000);
        }

        function updateButtonStates() {
            clearAllTimersAndHideMessage();
            let allBarcodesMatched = true;

            // Eğer hiç input yoksa, butonlar pasif kalmalı
            if (barkodInputs.length === 0) {
                 allBarcodesMatched = false;
            }

            // Sayfadaki TÜM barkod inputlarını kontrol et
            barkodInputs.forEach(input => {
                const productIndex = input.dataset.productIndex;
                const quantityIndex = input.dataset.quantityIndex;
                const side = input.dataset.side;

                // Her bir input için beklenen barkodu kendi ID'si ile bul
                const expectedEl = document.getElementById(`expectedBarcode-${side}-${productIndex}-${quantityIndex}`);
                const expectedValue = expectedEl ? expectedEl.value.trim() : '';
                const inputValue = input.value.trim();

                // Eğer input boşsa veya değeri yanlışsa, genel durumu 'false' yap
                if (inputValue === '' || inputValue !== expectedValue) {
                    allBarcodesMatched = false;
                }
            });

            if (allBarcodesMatched) {
                onaylaBtn.classList.remove('disabled');
                yazdirBtn.classList.remove('disabled');
                onaylaBtn.disabled = false;
                yazdirBtn.disabled = false;

                confirmTimer = setTimeout(() => packingForm.submit(), 15000);

                if (autoShipToggle.checked) {
                    showAutoShipMessage();
                } else {
                    printTimer = setTimeout(() => yazdirForm.submit(), 5000);
                }
            } else {
                onaylaBtn.classList.add('disabled');
                yazdirBtn.classList.add('disabled');
                onaylaBtn.disabled = true;
                yazdirBtn.disabled = true;
            }
        }

        barkodInputs.forEach((input, currentIndex) => {
            input.addEventListener('input', function () {
                const productIndex = this.dataset.productIndex;
                const quantityIndex = this.dataset.quantityIndex;
                const side = this.dataset.side;

                // Her input için form-group içindeki alert elementini doğrudan bul
                const formGroup = this.closest('.form-group');
                if (!formGroup) return;

                const matchMessage = formGroup.querySelector('.alert');
                if (!matchMessage) return;

                // Barkod değerini input'un bulunduğu card-body'den al
                const cardBody = this.closest('.card-body');
                if (!cardBody) return;

                // Gizli barkod değerini bul
                const expectedEl = cardBody.querySelector(`input[type="hidden"][id="expectedBarcode-${side}-${productIndex}-${quantityIndex}"]`);
                if (!expectedEl) return;

                const expectedValue = expectedEl.value.trim();
                const inputValue = this.value.trim();

                if (inputValue === expectedValue) {
                    matchMessage.textContent = 'Doğru!';
                    matchMessage.className = 'alert alert-success alert-show';
                    this.style.backgroundColor = '#e9ffe9';

                    // Bir sonraki input'a otomatik geçiş
                    const next = barkodInputs[currentIndex + 1];
                    if (next) {
                        setTimeout(() => next.focus(), 150);
                    } else {
                        onaylaBtn.focus();
                    }
                } else if (inputValue.length > 0) {
                    matchMessage.textContent = 'Yanlış!';
                    matchMessage.className = 'alert alert-danger alert-show';
                    this.style.backgroundColor = '';
                } else {
                    matchMessage.className = 'alert';
                    matchMessage.style.opacity = '0';
                    matchMessage.style.visibility = 'hidden';
                    this.style.backgroundColor = '';
                }

                updateButtonStates();
            });
        });

        autoShipToggle.addEventListener('change', function () {
            localStorage.setItem('autoShipEnabled', this.checked.toString());
            updateButtonStates();
        });

        if (barkodInputs.length > 0) {
            barkodInputs[0].focus();
        }

        updateButtonStates();
    });

    function copyToClipboard(elementId, element) {
        const text = document.getElementById(elementId).innerText;
        if (navigator.clipboard) {
            navigator.clipboard.writeText(text).then(() => {
                const confirmation = element.nextElementSibling;
                confirmation.classList.add('show');
                setTimeout(() => confirmation.classList.remove('show'), 1500);
            }).catch(err => console.error('Kopyalama hatası: ', err));
        }
    }

    function showArchiveModal(order_number) {
        document.getElementById('archiveOrderNumber').value = order_number;
        $('#archiveModal').modal('show');
    }

    $('#archiveReason').change(function () {
        if ($(this).val() === 'Diğer') {
            $('#otherReasonDiv').show();
            $('#otherReasonText').prop('required', true);
        } else {
            $('#otherReasonDiv').hide();
            $('#otherReasonText').prop('required', false);
        }
    });

    $('#archiveForm').submit(function (event) {
        event.preventDefault();
        var postData = {
            order_number: $('#archiveOrderNumber').val(),
            archive_reason: $('#archiveReason').val(),
            other_reason: $('#otherReasonText').val()
        };

        if (!postData.archive_reason || (postData.archive_reason === 'Diğer' && !postData.other_reason.trim())) {
            alert('Lütfen bir sebep belirtin.');
            return;
        }

        $.post("/archive_order", postData, function (response) {
            if (response.success) {
                $('#archiveModal').modal('hide');
                setTimeout(() => window.location.reload(), 2000);
            } else {
                alert('Hata: ' + response.message);
            }
        }).fail(() => alert('Sunucu hatası.'));
    });
    </script>
    </body>
</html>