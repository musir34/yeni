<!doctype html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="weather-description" content="{{ weather.description if weather else 'Açık Hava' }}" />
  <title>Paketleme Ekranı - Güllü Ayakkabı</title>

  <!-- Bootstrap & Icons -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"/>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"/>

  <style>
    /* Sayfa Düzeni */
    body{margin:0;padding:0;font-family:"Roboto",sans-serif;background:#f5f5f5}
    /* Canvas: Arka plan */
    #weatherCanvas{position:fixed;top:0;left:0;z-index:-1;width:100vw;height:100vh}

    .container{max-width:1200px;margin-top:60px;margin-left:auto;margin-right:auto;padding:0 15px}

    .user-info{position:fixed;top:15px;left:20px;z-index:10;font-size:14px;color:#333;display:flex;align-items:center;gap:10px;padding:10px 15px;border-radius:10px;background:rgba(255,255,255,.7);backdrop-filter:blur(6px);box-shadow:0 6px 18px rgba(0,0,0,.08);max-width:450px;}
    .user-info img{max-width:100px;height:auto;border-radius:5px;box-shadow:0 8px 18px rgba(0,0,0,.12)}

    .btn-group-top{position:fixed;top:15px;right:20px;display:flex;gap:10px;z-index:10;flex-wrap:wrap;justify-content:flex-end;align-items:center}

    /* Ortak buton görünümü */
    .btn{border-radius:20px;padding:10px 20px;font-size:.9rem;transition:all .3s ease;box-shadow:0 2px 4px rgba(0,0,0,.1);border:none;color:#fff}
    .btn:hover{transform:scale(1.05);text-decoration:none;color:#fff}

    /* Bootstrap renk sınıflarını gradientlerle override */
    .btn-secondary{background:linear-gradient(to right,#757f9a,#d7dde8)}
    .btn-warning{background:linear-gradient(to right,#f7971e,#ffd200)}
    .btn-primary{background:linear-gradient(to right,#2193b0,#6dd5ed)}
    .btn-success{background:linear-gradient(to right,#56ab2f,#a8e063)}
    .btn-info{background:linear-gradient(to right,#667db6,#0082c8,#0082c8,#667db6)}
    .btn-danger{background:linear-gradient(to right,#cb2d3e,#ef473a)}
    .btn-dark{background:linear-gradient(to right,#343a40,#495057)}
    .btn.disabled,.btn:disabled{background:#ccc;background-image:none;cursor:not-allowed;opacity:.7}

    /* Dropdown */
    .dropdown-toggle{border-radius:20px!important}
    .dropdown-menu{border:none;border-radius:10px;padding:.5rem 0;background:#fff;box-shadow:0 4px 8px rgba(0,0,0,.1)}
    .dropdown-item{font-size:.85rem;padding:.5rem 1rem;color:#333;transition:background-color .3s}
    .dropdown-item:hover{background:#efefef}

    .order-container{display:flex;flex-wrap:wrap;gap:20px;align-items:flex-start;justify-content:center}
    .card{width:200px;border:none;border-radius:10px;box-shadow:0 4px 8px rgba(0,0,0,.05);margin-bottom:20px;transition:transform .2s;overflow:hidden;background:#fff}
    .card:hover{transform:translateY(-5px);box-shadow:0 6px 12px rgba(0,0,0,.1)}
    .product-image{width:100%;height:250px;border-radius:10px 10px 0 0;object-fit:cover;cursor:zoom-in;transition:transform .3s}
    .product-image:hover{transform:scale(1.05)}
    .card-title{font-weight:bold;color:#444;text-align:center;margin:10px 0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .card-text{font-size:.9rem;color:#666;text-align:center}

    .form-control{border-radius:10px;padding:8px;font-size:.85rem;box-shadow:inset 0 1px 3px rgba(0,0,0,.1);border:1px solid #ddd}
    .form-control:focus{border-color:#6dd5ed;box-shadow:inset 0 1px 3px rgba(0,0,0,.1),0 0 5px rgba(109,213,237,.5)}

    .form-group{position:relative;margin-bottom:35px}
    .alert{position:absolute;top:-30px;left:0;right:0;font-size:12px;padding:5px;border-radius:5px;opacity:0;transition:opacity .3s;text-align:center;z-index:10;pointer-events:none;width:100%;box-sizing:border-box;visibility:hidden}
    .alert-show{opacity:1;visibility:visible}
    .alert-success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .alert-danger{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}

    #autoShipMessage{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.9);color:#fff;padding:0;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.3);z-index:1000;opacity:0;visibility:hidden;transition:all .3s;min-width:400px;max-width:500px}
    .auto-ship-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:15px;padding:30px;text-align:center;position:relative;overflow:hidden}
    .auto-ship-card::before{content:'';position:absolute;inset:0;background:linear-gradient(45deg,transparent 30%,rgba(255,255,255,.1) 50%,transparent 70%);animation:shine 2s infinite}
    @keyframes shine{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
    .shipping-header h3{margin:0 0 10px;font-size:1.5rem;font-weight:bold;color:#fff}
    .shipping-header p{margin:0 0 20px;font-size:1rem;color:rgba(255,255,255,.8)}
    .shipping-barcode{background:rgba(255,255,255,.1);border:2px solid rgba(255,255,255,.2);border-radius:10px;padding:20px;margin-top:15px}
    .shipping-barcode strong{font-size:2rem;font-weight:bold;color:#fff;letter-spacing:2px;text-shadow:0 2px 4px rgba(0,0,0,.3)}
    #autoShipMessage.show{opacity:1;visibility:visible}

    .copy-container{position:relative;cursor:pointer;display:inline-block;margin-left:5px;color:#007bff;transition:color .2s}
    .copy-container:hover{color:#0056b3}
    .copy-confirmation{color:green;font-size:1em;margin-left:5px;display:none}
    .copy-confirmation.show{display:inline-block}

    .btn-bottom{max-width:200px;margin:10px 0;padding:8px 15px;border-radius:10px}
    .bottom-buttons{text-align:left;margin-top:20px;display:flex;gap:10px;flex-wrap:wrap}

    /* Görsel Modal (custom lightbox) */
    .image-modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);backdrop-filter:blur(5px);z-index:1060;display:none;align-items:center;justify-content:center;opacity:0;transition:opacity .3s}
    .image-modal-overlay.is-visible{display:flex;opacity:1}
    .image-modal-content{background:#fff;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.3);max-width:90vw;max-height:90vh;position:relative;overflow:hidden;transform:scale(.8);transition:transform .3s}
    .image-modal-overlay.is-visible .image-modal-content{transform:scale(1)}
    .image-modal-header{padding:1rem 1.5rem;border-bottom:1px solid #dee2e6;display:flex;justify-content:space-between;align-items:center;background:#f8f9fa}
    .image-modal-header h4{margin:0;font-size:1.2rem;color:#333}
    .image-modal-close{background:none;border:none;font-size:2rem;cursor:pointer;color:#999;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all .2s}
    .image-modal-close:hover{background:#f1f1f1;color:#333}
    .image-modal-body{padding:1rem;text-align:center;max-height:80vh;overflow-y:auto}
    .image-modal-body img{max-width:100%;max-height:70vh;object-fit:contain;border-radius:10px;box-shadow:0 4px 8px rgba(0,0,0,.1)}
    .image-modal-footer{padding:1rem 1.5rem;background:#f8f9fa;border-top:1px solid #dee2e6;text-align:center}
    .image-modal-footer p{margin:0;color:#666;font-size:.9rem}

    .fixed-header{background:#fff;border-radius:10px;padding:15px;margin-top:20px;box-shadow:0 4px 8px rgba(0,0,0,.05)}
    .fixed-header h4{margin-top:0;margin-bottom:10px;color:#333}
    .fixed-header p{margin:0;line-height:1.5;color:#555}
    .fixed-header .copy-container{color:#555}

    .modal-content{border-radius:15px;padding:20px}
    .modal-header{border-bottom:none;justify-content:center}
    .modal-footer{border-top:none;justify-content:center}

    .highlight-quantity{color:red;font-size:1.3em;font-weight:bold}

    .custom-control{position:relative;display:inline-flex;min-height:1.5rem;padding-left:1.5rem;align-items:center}
    .custom-switch{padding-left:2.25rem}
    .custom-control-input{position:absolute;left:0;z-index:-1;width:1rem;height:1.25rem;opacity:0}
    .custom-control-label{margin-bottom:0;line-height:1.5;cursor:pointer}
    .custom-control-label::before{position:absolute;top:.25rem;left:-2.25rem;display:block;width:1.75rem;height:1rem;content:"";background:#adb5bd;border:#adb5bd solid 1px;border-radius:1rem;transition:background-color .15s,border-color .15s,box-shadow .15s}
    .custom-control-label::after{position:absolute;top:.25rem;left:-2rem;display:block;width:1rem;height:1rem;content:"";background:#fff;border-radius:1rem;transition:transform .15s,background-color .15s,border-color .15s,box-shadow .15s}
    .custom-switch .custom-control-input:checked ~ .custom-control-label::before{color:#fff;border-color:#28a745;background:#28a745}
    .custom-switch .custom-control-input:checked ~ .custom-control-label::after{transform:translateX(.75rem)}

    /* Raf seçimi (mavi tik) */
    .raf-option{display:block;text-align:left;margin-bottom:6px;position:relative;padding-left:28px}
    .raf-option input[type="radio"]{position:absolute;left:0;top:2px}
    .raf-option .tick{margin-left:6px;font-weight:bold;color:#0d6efd;opacity:0;transition:opacity .15s}
    .raf-option input[type="radio"]:checked ~ .tick{opacity:1}

    @media (max-width:768px){
      .btn{font-size:.8rem;padding:8px 12px}
      .card-title{font-size:.9rem}
      .card-text{font-size:.8rem}
      .user-info{top:10px;left:10px;gap:5px;font-size:12px}
      .user-info img{max-width:60px}
      .btn-group-top{top:10px;right:10px;gap:5px;flex-direction:column;align-items:flex-end}
      .btn{width:100%;text-align:center;padding:6px 10px;font-size:.8rem}
      .dropdown-toggle{width:100%;text-align:center!important}
      .dropdown-menu{left:auto!important;right:0!important;min-width:auto;width:auto}
      .dropdown-item{text-align:right;font-size:.8rem}
      .custom-switch{margin-top:10px;width:100%;justify-content:flex-end;padding-right:2.25rem;padding-left:0}
      .custom-control-label::before{left:auto;right:0}
      .custom-control-label::after{left:auto;right:.25rem}
      .custom-switch .custom-control-input:checked ~ .custom-control-label::after{transform:translateX(-.75rem)}
      #autoShipMessage{min-width:300px;max-width:90%;margin:0 5%}
      .auto-ship-card{padding:20px}
      .shipping-header h3{font-size:1.2rem}
      .shipping-barcode strong{font-size:1.5rem}
      .container{margin-top:180px;padding:0 10px}
      .fixed-header{margin-top:10px;padding:10px}
    }
    @media (max-width:576px){.card{width:calc(50% - 15px)}}

    /* 🔔 Arşiv uyarısı kritik modları */
    .aw-critical .modal-content{background:#ffe3e3!important}
    @keyframes aw-shake{10%,90%{transform:translateX(-1px)}20%,80%{transform:translateX(2px)}30%,50%,70%{transform:translateX(-4px)}40%,60%{transform:translateX(4px)}}
    .aw-shake{animation:aw-shake .45s ease-in-out 2}

    /* ✅ Değişim uyarısı (yeşil tema) */
    .dw-success .modal-content{background:#d4edda!important}
    .dw-success .modal-title{color:#155724!important}
  </style>
</head>

<body>
  <canvas id="weatherCanvas"></canvas>

  <!-- Görsel Büyütme Modal -->
  <div id="imageModal" class="image-modal-overlay">
    <div class="image-modal-content">
      <div class="image-modal-header">
        <h4 id="imageModalTitle">Ürün Görseli</h4>
        <button class="image-modal-close">&times;</button>
      </div>
      <div class="image-modal-body">
        <img id="imageModalImg" src="" alt="Ürün Görseli"/>
      </div>
      <div class="image-modal-footer">
        <p id="imageModalInfo">Görseli kapatmak için dışarı tıklayın</p>
      </div>
    </div>
  </div>

  <!-- Kullanıcı info -->
  <div class="user-info">
    <img src="{{ url_for('static', filename='logo/gullu.png') }}" alt="Güllü Shoes Logo"/>
    <div style="display:flex;flex-direction:column;gap:2px;">
      <div>Giriş Yapan: <strong>{{ session['first_name'] }} {{ session['last_name'] }}</strong></div>
      {% if weather %}
      <div style="font-size:12px;color:#555;">
        {{ weather.icon }} {{ weather.description }} • {{ weather.temperature }}°C
        {% if weather.feels_like %}(Hissedilen: {{ weather.feels_like }}°C){% endif %}
      </div>
      <div style="font-size:11px;color:#666;">
        💨 {{ weather.wind_speed }} km/h {{ weather.wind_direction }} • 💧 Nem: {{ weather.humidity }}%
        {% if weather.visibility %} • 👁️ Görüş: {{ weather.visibility|round(1) }} km{% endif %}
      </div>
      {% endif %}
      {% if current_time %}
      <div style="font-size:11px;color:#666;">
        🕐 {{ current_time.strftime('%d %B %Y, %A - %H:%M:%S') }}
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Üst butonlar -->
  <div class="btn-group-top">
    <a href="{{ url_for('home.home') }}" class="btn btn-secondary">Anasayfa</a>
    <a href="{{ url_for('display_archive') }}" class="btn btn-secondary">Arşiv</a>

    <div class="dropdown">
      <button class="btn btn-warning dropdown-toggle" type="button" id="kullaniciMenu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Kullanıcı İşlemleri</button>
      <div class="dropdown-menu" aria-labelledby="kullaniciMenu">
        <a class="dropdown-item" href="{{ url_for('approve_users') }}">Kullanıcı Yönetimi</a>
        <a class="dropdown-item" href="{{ url_for('rapor_gir.giris') }}"><i class="fas fa-file-alt"></i> Raporlama</a>
        {% if session['role'] in ['admin','manager'] %}
          <a class="dropdown-item" href="{{ url_for('user_logs.view_logs') }}"><i class="fas fa-history"></i> Kullanıcı Hareketleri</a>
        {% endif %}
      </div>
    </div>

    <div class="dropdown">
      <button class="btn btn-primary dropdown-toggle" type="button" id="siparisMenu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Sipariş İşlemleri</button>
      <div class="dropdown-menu" aria-labelledby="siparisMenu">
        <a class="dropdown-item" href="{{ url_for('siparisler_bp.yeni_siparis') }}">Yeni Sipariş</a>
        <a class="dropdown-item" href="{{ url_for('order_list_all') }}">Sipariş Listesi</a>
        <a class="dropdown-item" href="{{ url_for('degisim_talep') }}">Değişim Talepleri</a>
      </div>
    </div>

    <div class="dropdown">
      <button class="btn btn-success dropdown-toggle" type="button" id="urunMenu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Ürün İşlemleri</button>
      <div class="dropdown-menu" aria-labelledby="urunMenu">
        <a class="dropdown-item" href="{{ url_for('siparis_fisi_bp.siparis_fisi_sayfasi') }}">Ürün Tedarik Sayfası</a>
        <a class="dropdown-item" href="{{ url_for('product_list') }}">Ürün Listesi</a>
        <a class="dropdown-item" href="{{ url_for('stock_management.stock_addition_page') }}">Stok Ekleme</a>
        <a class="dropdown-item" href="{{ url_for('raf.raf_form_sayfasi') }}">Raf Listesi</a>
        <a class="dropdown-item" href="{{ url_for('iade_listesi') }}">İade Listesi</a>
      </div>
    </div>

    <div class="dropdown">
      <button class="btn btn-info dropdown-toggle" type="button" id="analizMenu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Analizler</button>
      <div class="dropdown-menu" aria-labelledby="analizMenu">
        <a class="dropdown-item" href="{{ url_for('analysis.sales_analysis') }}">Satış Analizi</a>
        <a class="dropdown-item" href="{{ url_for('openai_bp.ai_analiz') }}">AI Analiz</a>
        <a class="dropdown-item" href="{{ url_for('commission_update_bp.update_commission_from_excel') }}">Excel Komisyon Yükle</a>
        <a class="dropdown-item" href="/intelligent-stock/">🧠 Stok Zekası Paneli</a>
        <a class="dropdown-item" href="{{ url_for('profit.profit_report') }}">💰 Kâr Analizi</a>
        <a class="dropdown-item" href="{{ url_for('canli_panel.canli_panel_sayfa') }}">📊 Canlı Satış & Stok Paneli</a>
      </div>
    </div>

    {% if session['role'] in ['admin','manager'] %}
    <a href="{{ url_for('kasa.kasa_sayfasi') }}" class="btn btn-dark">
      <i class="fas fa-cash-register"></i> Kasa
    </a>
    {% endif %}

    <div class="custom-control custom-switch">
      <input type="checkbox" class="custom-control-input" id="autoShipToggle"/>
      <label class="custom-control-label" for="autoShipToggle">Otomatik Gönderim</label>
    </div>
  </div>

  <!-- Otomatik Gönderim popup -->
  <div id="autoShipMessage">
    <div class="auto-ship-card">
      <div class="shipping-header">
        <h3>Otomatik Gönderim Aktif</h3>
        <p>Kargo kodu: <span id="autoShipBarcode"></span></p>
      </div>
      <div class="shipping-barcode">
        <strong id="autoShipBarcodeDisplay"></strong>
      </div>
    </div>
  </div>

  <div class="container">
    <form method="POST" action="{{ url_for('update_service.confirm_packing') }}" id="packingForm" autocomplete="off">
      <input type="hidden" name="order_number" value="{{ order.order_number if order else '' }}"/>

      <div class="order-container">
        {% for product in order.products if order %}
        <div class="col-sm-6 col-md-4 col-lg-3 col-xl-2">
          <div class="card product-card">
            <img src="{{ product['image_url'] }}" alt="Ürün Görseli" class="card-img-top product-image zoomable-image" data-image-src="{{ product['image_url'] }}"/>
            <div class="card-body">
              <h5 class="card-title">{{ product['sku'] }}</h5>

              <p class="card-text">
                <strong>Miktar:</strong>
                <span class="{% if product['quantity']|int > 1 %}highlight-quantity{% endif %}">{{ product['quantity'] }}</span>
              </p>

              <p class="card-text">
                <strong>Barkod:</strong>
                <span id="productBarcode-{{ loop.index0 }}">{{ product['barcode'] }}</span>
                <span class="copy-container">
                  <span class="clipboard-icon" onclick="copyToClipboard('productBarcode-{{ loop.index0 }}', this)">📋</span>
                  <span class="copy-confirmation">✔️</span>
                </span>
              </p>

              <div class="card-text">
                {% set aktif_raflar = product['raflar']|selectattr('adet','gt',0)|sort(attribute='adet', reverse=True)|list %}
                {% if aktif_raflar %}
                  <p style="margin-bottom:5px;"><strong>Raf Seçimi (aktif olanların tamamı):</strong></p>
                  {% for raf in aktif_raflar %}
                    <label class="raf-option">
                      <input type="radio" name="pick_{{ product['barcode'] }}" value="{{ raf.kod }}" {% if loop.first %}checked{% endif %}>
                      {{ raf.kod }} — {{ raf.adet }} adet
                      <span class="tick">✔</span>
                    </label>
                  {% endfor %}
                {% else %}
                  <p><em>Bu ürün için aktif raf stoğu yok.</em></p>
                {% endif %}
              </div>

              {% for q in range(product['quantity']|int) %}
                <div class="form-group">
                  <div id="barkodMatchMessage-right-{{ loop.index0 }}-{{ q }}" class="alert"></div>
                  <input type="text"
                    class="form-control barkod-input"
                    data-product-index="{{ loop.index0 }}"
                    data-quantity-index="{{ q }}"
                    data-side="right"
                    id="barkodInput-right-{{ loop.index0 }}-{{ q }}"
                    name="barkod_right_{{ loop.index0 }}_{{ q }}"
                    placeholder="{{ product['sku'] }} Sağ Tek ({{ q+1 }})"
                    required autocomplete="off"/>
                </div>

                <div class="form-group">
                  <div id="barkodMatchMessage-left-{{ loop.index0 }}-{{ q }}" class="alert"></div>
                  <input type="text"
                    class="form-control barkod-input"
                    data-product-index="{{ loop.index0 }}"
                    data-quantity-index="{{ q }}"
                    data-side="left"
                    id="barkodInput-left-{{ loop.index0 }}-{{ q }}"
                    name="barkod_left_{{ loop.index0 }}_{{ q }}"
                    placeholder="{{ product['sku'] }} Sol Tek ({{ q+1 }})"
                    required autocomplete="off"/>
                </div>
              {% endfor %}

              {% for q in range(product['quantity']|int) %}
                <input type="hidden" id="expectedBarcode-right-{{ loop.index0 }}-{{ q }}" value="{{ product['barcode'] }}"/>
                <input type="hidden" id="expectedBarcode-left-{{ loop.index0 }}-{{ q }}" value="{{ product['barcode'] }}"/>
              {% endfor %}
            </div><!-- card-body -->
          </div>
        </div>
        {% else %}
          <p class="text-center w-100">İşlenecek yeni sipariş bulunamadı.</p>
        {% endfor %}
      </div>

      <div class="bottom-buttons">
        <button type="submit" class="btn btn-primary btn-bottom disabled" id="onaylaBtn" disabled>Paketlemeyi Onayla</button>
      </div>
    </form>

    <div class="bottom-buttons">
      <form method="POST" action="{{ url_for('order_label') }}" target="_blank" id="yazdirForm" autocomplete="off">
        <input type="hidden" name="order_number" value="{{ order.order_number if order else '' }}"/>
        <input type="hidden" name="shipping_barcode" value="{{ order.shipping_barcode if order else '' }}"/>
        <input type="hidden" name="cargo_provider" value="{{ order.cargo_provider_name if order else '' }}"/>
        <input type="hidden" name="customer_name" value="{{ order.customer_name if order else '' }}"/>
        <input type="hidden" name="customer_surname" value="{{ order.customer_surname if order else '' }}"/>
        <input type="hidden" name="customer_address" value="{{ order.customer_address if order else '' }}"/>
        <button type="submit" class="btn btn-warning btn-bottom disabled" id="yazdirBtn" disabled>Yazdır</button>
      </form>

      {% if order %}
        <button type="button" class="btn btn-danger btn-bottom" onclick="showArchiveModal('{{ order.order_number }}')">Arşive Gönder</button>
      {% endif %}
    </div>

    {% if order %}
    <div class="fixed-header">
      <h4>Kargo Bilgileri</h4>
      <p>
        <strong>Sipariş No:</strong> {{ order.order_number }}<br/>
        <strong>Müşteri:</strong> {{ order.customer_name }} {{ order.customer_surname }}<br/>
        <strong>Kargoya Kalan Süre:</strong> {{ remaining_time }}<br/>
        <strong>Kargo Firması:</strong> {{ order.cargo_provider_name }}<br/>
        <strong>Kargo Kodu:</strong>
        <span id="shippingBarcode">{{ order.shipping_barcode }}</span>
        <span class="copy-container">
          <span class="clipboard-icon" onclick="copyToClipboard('shippingBarcode', this)">📋</span>
          <span class="copy-confirmation">✔️</span>
        </span>
      </p>
    </div>
    {% endif %}
  </div><!-- /container -->

  <!-- Arşiv modal (GLOBAL, TEK KEZ) -->
  <div class="modal fade" id="archiveModal" tabindex="-1" aria-labelledby="archiveModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="archiveForm">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Siparişi Arşivle</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Kapat"><span aria-hidden="true">&times;</span></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="archiveOrderNumber" name="order_number"/>
            <div class="form-group">
              <label for="archiveReason">Arşivleme Sebebi</label>
              <select id="archiveReason" name="archive_reason" class="form-control" required>
                <option value="">Sebep Seçin</option>
                <option value="Stok Yok">Stok Tükendi</option>
                <option value="Urun Sorunu">Ürün Sorunu Düzeltiliyor</option>
                <option value="Kusurlu Ürün">Kusurlu Ürün</option>
                <option value="Diğer">Diğer</option>
              </select>
            </div>
            <div class="form-group" id="otherReasonDiv" style="display:none;">
              <label for="otherReasonText">Diğer Sebep Açıklaması</label>
              <textarea id="otherReasonText" name="other_reason" class="form-control" rows="3"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Arşivle</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">İptal</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Arşiv Uyarısı (GLOBAL, TEK KEZ) -->
  <div id="archiveWarningModal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
      <div class="modal-content" style="border-radius:15px;background:#fff3cd;">
        <div class="modal-header">
          <h4 class="modal-title" style="color:#856404;font-weight:bold;">📦 Arşiv Uyarısı</h4>
          <button type="button" class="close" data-dismiss="modal" aria-label="Kapat"><span aria-hidden="true">&times;</span></button>
        </div>
        <div class="modal-body">
          <h5>Arşivde <strong id="aw-count">0</strong> sipariş bulunuyor.</h5>
          <ul id="aw-list" class="mb-0"></ul>
          <p class="text-danger mt-3 mb-0"><strong>⚠️ Lütfen bu siparişleri kontrol et!</strong></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-warning" data-dismiss="modal">Tamam</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ Değişim Uyarısı (GLOBAL, TEK KEZ) -->
  <div id="exchangeWarningModal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered dw-success" role="document">
      <div class="modal-content" style="border-radius:15px;">
        <div class="modal-header">
          <h4 class="modal-title" style="font-weight:bold;">🔄 Değişim Uyarısı</h4>
          <button type="button" class="close" data-dismiss="modal" aria-label="Kapat"><span class="sr-only">Kapat</span>&times;</button>
        </div>
        <div class="modal-body">
          <h5>İşleme alındı statüsünde <strong id="dw-count">0</strong> değişim var.</h5>
          <ul id="dw-list" class="mb-0"></ul>
          <p class="mt-3 mb-0 text-success"><strong>✅ Önce bu değişimleri hazırla ekranından işleme al.</strong></p>
        </div>
        <div class="modal-footer">
          <a href="{{ url_for('degisim.degisim_talep', filter_status='İşleme Alındı') }}" class="btn btn-success">Değişim Listesine Git</a>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Tamam</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Vendor JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.bundle.min.js"></script>

  <!-- Gelişmiş hava durumu canvas animasyonları -->
  <script src="{{ url_for('static', filename='js/weather-canvas.js') }}"></script>

  <!-- Uygulama JS -->
  <script>
    // Görsel modal
    (function(){
      const overlay=document.getElementById('imageModal');
      const img=document.getElementById('imageModalImg');
      document.addEventListener('click',e=>{
        const t=e.target;
        if(t.classList && t.classList.contains('zoomable-image')){
          img.src=t.getAttribute('data-image-src')||t.src; overlay.classList.add('is-visible');
        }
        if(t.classList && (t.classList.contains('image-modal-close')||t===overlay)){overlay.classList.remove('is-visible');}
      });
    })();

    // DOM Hazır
    document.addEventListener('DOMContentLoaded', function(){
      const onaylaBtn=document.getElementById('onaylaBtn');
      const yazdirBtn=document.getElementById('yazdirBtn');
      const yazdirForm=document.getElementById('yazdirForm');
      const packingForm=document.getElementById('packingForm');
      const autoShipToggle=document.getElementById('autoShipToggle');
      const autoShipMessage=document.getElementById('autoShipMessage');
      const autoShipBarcodeSpan=document.getElementById('autoShipBarcode');
      const shippingBarcode="{{ order.shipping_barcode if order else '' }}";
      const barkodInputs=document.querySelectorAll('.barkod-input');

      let printTimer=null, confirmTimer=null;

      // Toggle state (localStorage)
      const savedToggleState=localStorage.getItem('autoShipEnabled');
      if(savedToggleState!==null) autoShipToggle.checked = (savedToggleState==='true');

      function clearTimers(){ if(printTimer) clearTimeout(printTimer); if(confirmTimer) clearTimeout(confirmTimer); autoShipMessage.classList.remove('show'); }
      function showAutoShip(){document.getElementById('autoShipBarcodeDisplay').innerText=shippingBarcode; autoShipBarcodeSpan.innerText=shippingBarcode; autoShipMessage.classList.add('show'); setTimeout(()=>autoShipMessage.classList.remove('show'),3000);}

      function updateButtons(){
        clearTimers();
        let ok=true;
        if(barkodInputs.length===0) ok=false;
        barkodInputs.forEach(input=>{
          const pi=input.dataset.productIndex, qi=input.dataset.quantityIndex, side=input.dataset.side;
          const cardBody=input.closest('.card-body'); if(!cardBody){ok=false;return;}
          const expectedEl=cardBody.querySelector(`input[type="hidden"][id="expectedBarcode-${side}-${pi}-${qi}"]`);
          const exp=expectedEl? expectedEl.value.trim():'';
          const val=input.value.trim();
          if(val===''||val!==exp) ok=false;
        });

        if(ok){
          onaylaBtn.classList.remove('disabled');yazdirBtn.classList.remove('disabled');
          onaylaBtn.disabled=false;yazdirBtn.disabled=false;
          confirmTimer=setTimeout(()=>packingForm.submit(),15000);
          if(autoShipToggle.checked){showAutoShip();}
          else{printTimer=setTimeout(()=>yazdirForm.submit(),5000);}
        }else{
          onaylaBtn.classList.add('disabled');yazdirBtn.classList.add('disabled');
          onaylaBtn.disabled=true;yazdirBtn.disabled=true;
        }
      }

      barkodInputs.forEach((input,idx)=>{
        input.addEventListener('input',function(){
          const pi=this.dataset.productIndex, qi=this.dataset.quantityIndex, side=this.dataset.side;
          const fg=this.closest('.form-group'); if(!fg) return;
          const msg=fg.querySelector('.alert'); if(!msg) return;
          const cb=this.closest('.card-body'); if(!cb) return;
          const expectedEl=cb.querySelector(`input[type="hidden"][id="expectedBarcode-${side}-${pi}-${qi}"]`); if(!expectedEl) return;
          const exp=expectedEl.value.trim(), val=this.value.trim();

          if(val===exp){ msg.textContent='Doğru!'; msg.className='alert alert-success alert-show'; this.style.backgroundColor='#e9ffe9';
            const next=barkodInputs[idx+1]; if(next) setTimeout(()=>next.focus(),150); else onaylaBtn.focus();
          }else if(val.length>0){ msg.textContent='Yanlış!'; msg.className='alert alert-danger alert-show'; this.style.backgroundColor=''; }
          else{ msg.className='alert'; msg.style.opacity='0'; msg.style.visibility='hidden'; this.style.backgroundColor=''; }

          updateButtons();
        });
      });

      autoShipToggle.addEventListener('change',function(){localStorage.setItem('autoShipEnabled',this.checked.toString()); updateButtons();});
      if(barkodInputs.length>0) barkodInputs[0].focus();
      updateButtons();
    });

    function copyToClipboard(elementId, el){
      const tag=document.getElementById(elementId); if(!tag) return;
      const text=tag.innerText;
      if(navigator.clipboard){
        navigator.clipboard.writeText(text).then(()=>{const conf=el.nextElementSibling; if(conf){conf.classList.add('show'); setTimeout(()=>conf.classList.remove('show'),1500);}})
          .catch(err=>console.error('Kopyalama hatası:',err));
      }
    }

    function showArchiveModal(order_number){
      document.getElementById('archiveOrderNumber').value=order_number;
      $('#archiveModal').modal('show');
    }

    // Arşiv formu
    $(document).on('change','#archiveReason',function(){
      if ($(this).val()==='Diğer'){ $('#otherReasonDiv').show(); $('#otherReasonText').prop('required',true); }
      else{ $('#otherReasonDiv').hide(); $('#otherReasonText').prop('required',false); }
    });
    $(document).on('submit','#archiveForm',function(e){
      e.preventDefault();
      var postData={order_number:$('#archiveOrderNumber').val(),archive_reason:$('#archiveReason').val(),other_reason:$('#otherReasonText').val()};
      if(!postData.archive_reason|| (postData.archive_reason==='Diğer' && !postData.other_reason.trim())){alert('Lütfen bir sebep belirtin.');return;}
      $.post("/archive_order",postData,function(res){
        if(res.success){ $('#archiveModal').modal('hide'); setTimeout(()=>window.location.reload(),2000); }
        else{ alert('Hata: '+res.message); }
      }).fail(()=>alert('Sunucu hatası.'));
    });
  </script>

  <!-- ✅ Ortak yardımcılar: interval + 3sn kilit -->
  <script>
    function extractMaxDelayHours(messages, meta){
      if (meta && Number.isFinite(meta.max_delay_hours)) return meta.max_delay_hours;
      let maxH = 0;
      (messages || []).forEach((m)=>{
        const mt = String(m).match(/(\d+)\s*saat/i);
        if (mt) maxH = Math.max(maxH, parseInt(mt[1], 10));
      });
      return maxH;
    }
    function computeIntervalMsByMaxH(maxH){
      if (maxH >= 10) return 15 * 60 * 1000;
      if (maxH >= 5)  return 30 * 60 * 1000;
      return 60 * 60 * 1000;
    }
    function showLockedModal(modalSelector, okBtnSelector, closeBtnSelector){
      const $m = $(modalSelector);
      $m.modal({ backdrop:'static', keyboard:false });
      const $ok = $(okBtnSelector);
      const $x  = $(closeBtnSelector);
      $ok.prop('disabled', true).addClass('disabled');
      $x.hide();
      $m.modal('show');
      setTimeout(() => {
        $ok.prop('disabled', false).removeClass('disabled');
        $x.show();
      }, 3000);
    }
  </script>

  <!-- Arşiv Uyarısı (zaman kontrollü + 3sn kilit) -->
  <script>
    (function(){
      const AW_RAW  = {{ archive_warnings | default([], true) | tojson | safe }};
      const AW_META = {{ archive_meta     | default({},  true) | tojson | safe }};
      const LS_KEY_LAST_TS='aw_last_shown_ts_v3';

      function normalize(input){
        if(!input) return {messages:[],count:0};
        if(Array.isArray(input)){
          if(input.length===2 && Array.isArray(input[0]) && Number.isFinite(input[1])) return {messages:input[0],count:input[1]};
          return {messages:input,count:input.length};
        }
        if(typeof input==='object'){
          const msgs=Array.isArray(input.messages)?input.messages:[];
          const cnt = Number.isFinite(input.count)?input.count:msgs.length;
          return {messages:msgs,count:cnt};
        }
        return {messages:[],count:0};
      }

      function render(aw,critical){
        const modal=document.getElementById('archiveWarningModal'); if(!modal) return;
        const listEl=modal.querySelector('#aw-list'), countEl=modal.querySelector('#aw-count');
        listEl.innerHTML=''; countEl.textContent=aw.count;
        aw.messages.forEach(m=>{const li=document.createElement('li'); li.textContent=String(m); listEl.appendChild(li);});
        const dialog=modal.querySelector('.modal-dialog'); dialog.classList.remove('aw-critical','aw-shake');
        if(critical){dialog.classList.add('aw-critical','aw-shake'); setTimeout(()=>dialog.classList.remove('aw-shake'),1200);}
      }

      function shouldShow(interval){ if(!interval) return false; const now=Date.now(); const last=parseInt(localStorage.getItem(LS_KEY_LAST_TS)||'0',10); return (now-last)>=interval; }
      function stamp(){ localStorage.setItem(LS_KEY_LAST_TS, Date.now().toString()); }

      function tick(){
        const aw=normalize(AW_RAW); if(aw.count<=0) return;
        const maxH=extractMaxDelayHours(aw.messages,AW_META);
        const interval=computeIntervalMsByMaxH(maxH);
        if(shouldShow(interval)){
          render(aw,maxH>=10);
          showLockedModal('#archiveWarningModal', '#archiveWarningModal .btn-warning', '#archiveWarningModal .close');
          stamp();
        }
      }
      $(function(){ tick(); setInterval(tick,60*1000); });
    })();
  </script>

  <!-- ✅ Değişim Uyarısı (İşleme Alındı; arşivle aynı mantık + 3sn kilit) -->
  <script>
    (function(){
      const DW_RAW  = {{ degisim_warnings | default([], true) | tojson | safe }};
      const DW_META = {{ degisim_meta     | default({},  true) | tojson | safe }};
      const LS_KEY_LAST_TS='dw_last_shown_ts_v2';

      function normalize(input){
        if(!input) return {messages:[],count:0};
        if(Array.isArray(input)) return {messages:input,count:input.length};
        if(typeof input==='object'){
          const msgs=Array.isArray(input.messages)?input.messages:[];
          const cnt = Number.isFinite(input.count)?input.count:msgs.length;
          return {messages:msgs,count:cnt};
        }
        return {messages:[],count:0};
      }

      function shouldShow(interval){ const now=Date.now(), last=parseInt(localStorage.getItem(LS_KEY_LAST_TS)||'0',10); return (now-last)>=interval; }
      function stamp(){ localStorage.setItem(LS_KEY_LAST_TS, Date.now().toString()); }

      function render(aw){
        const modal=document.getElementById('exchangeWarningModal');
        const listEl=modal.querySelector('#dw-list');
        const cntEl =modal.querySelector('#dw-count');
        listEl.innerHTML=''; cntEl.textContent=aw.count;
        aw.messages.forEach(m=>{const li=document.createElement('li'); li.textContent=String(m); listEl.appendChild(li);});
      }

      function tick(){
        const aw=normalize(DW_RAW); if(aw.count<=0) return;
        const maxH = extractMaxDelayHours(aw.messages, DW_META);
        const interval = computeIntervalMsByMaxH(maxH);
        if(shouldShow(interval)){
          render(aw);
          showLockedModal('#exchangeWarningModal', '#exchangeWarningModal .btn-secondary', '#exchangeWarningModal .close');
          stamp();
        }
      }

      $(function(){ tick(); setInterval(tick,60*1000); });
    })();
  </script>
</body>
</html>
