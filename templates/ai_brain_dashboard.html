{% extends "base.html" %}

{% block title %}AI Brain Dashboard - Güllü Shoes{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">AI Brain Dashboard</h1>
    
    <div class="row">
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Günlük Analiz</h5>
                    <button id="refreshDailyAnalysis" class="btn btn-sm btn-primary">Yenile</button>
                </div>
                <div class="card-body">
                    <div id="dailyAnalysisSpinner" class="text-center" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Yükleniyor...</span>
                        </div>
                    </div>
                    <div id="dailyAnalysisResult">
                        <p class="text-muted text-center">Analiz yüklemek için "Yenile" butonuna tıklayın.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Riskli Siparişler</h5>
                    <button id="checkRiskyOrders" class="btn btn-sm btn-warning">Kontrol Et</button>
                </div>
                <div class="card-body">
                    <div id="riskyOrdersSpinner" class="text-center" style="display: none;">
                        <div class="spinner-border text-warning" role="status">
                            <span class="visually-hidden">Yükleniyor...</span>
                        </div>
                    </div>
                    <div id="riskyOrdersResult">
                        <p class="text-muted text-center">Riskli siparişleri kontrol etmek için butona tıklayın.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Stok Durumu</h5>
                    <button id="checkStockStatus" class="btn btn-sm btn-info">Kontrol Et</button>
                </div>
                <div class="card-body">
                    <div id="stockStatusSpinner" class="text-center" style="display: none;">
                        <div class="spinner-border text-info" role="status">
                            <span class="visually-hidden">Yükleniyor...</span>
                        </div>
                    </div>
                    <div id="stockStatusResult">
                        <p class="text-muted text-center">Stok durumunu kontrol etmek için butona tıklayın.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">AI Asistanına Sor</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="questionInput" class="form-label">Sorunuzu yazın:</label>
                        <textarea id="questionInput" class="form-control" rows="3" placeholder="Örnek: Son 30 günde en çok satılan ürünler hangileri?"></textarea>
                    </div>
                    <button id="askQuestion" class="btn btn-primary">Sor</button>
                    
                    <div id="questionSpinner" class="text-center mt-3" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Yanıt alınıyor...</span>
                        </div>
                    </div>
                    
                    <div id="questionResult" class="mt-4" style="display: none;">
                        <h6>Yanıt:</h6>
                        <div id="answerContent" class="p-3 border rounded bg-light"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-md-12">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Zamanlanmış Görevler</h5>
                </div>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Görev</th>
                                <th>Sıklık</th>
                                <th>Son Çalışma</th>
                                <th>Sonraki Çalışma</th>
                                <th>Durum</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Günlük Analiz</td>
                                <td>Her gün 07:00</td>
                                <td id="dailyAnalysisLastRun">-</td>
                                <td>07:00</td>
                                <td><span class="badge bg-success">Aktif</span></td>
                            </tr>
                            <tr>
                                <td>Riskli Sipariş Kontrolü</td>
                                <td>Her 4 saatte bir</td>
                                <td id="riskyOrdersLastRun">-</td>
                                <td id="riskyOrdersNextRun">-</td>
                                <td><span class="badge bg-success">Aktif</span></td>
                            </tr>
                            <tr>
                                <td>Stok Kontrolü</td>
                                <td>Her saat</td>
                                <td id="stockCheckLastRun">-</td>
                                <td id="stockCheckNextRun">-</td>
                                <td><span class="badge bg-success">Aktif</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Günlük analiz yenileme
        document.getElementById('refreshDailyAnalysis').addEventListener('click', function() {
            const resultDiv = document.getElementById('dailyAnalysisResult');
            const spinner = document.getElementById('dailyAnalysisSpinner');
            
            resultDiv.innerHTML = '';
            spinner.style.display = 'block';
            
            fetch('/api/ai-brain/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    analysis_type: 'daily'
                }),
            })
            .then(response => response.json())
            .then(data => {
                spinner.style.display = 'none';
                
                if (data.success) {
                    // Markdown içeriğini HTML'e dönüştürmek için basit bir işlev
                    // (gerçek bir markdown parser kullanılabilir)
                    const markdownToHtml = (markdown) => {
                        let html = markdown;
                        // Başlıklar
                        html = html.replace(/^### (.*$)/gim, '<h5>$1</h5>');
                        html = html.replace(/^## (.*$)/gim, '<h4>$1</h4>');
                        html = html.replace(/^# (.*$)/gim, '<h3>$1</h3>');
                        
                        // Kalın ve italik
                        html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                        html = html.replace(/\_(.*?)\_/g, '<em>$1</em>');
                        
                        // Listeler
                        html = html.replace(/^\s*\d+\.\s+(.*$)/gim, '<li>$1</li>');
                        html = html.replace(/^\s*[\-\*]\s+(.*$)/gim, '<li>$1</li>');
                        
                        // Paragraflar
                        html = html.replace(/^\s*(\n)?([^\n]+)\n/gm, function(m) {
                            return /\<(\/)?(h|ul|ol|li|blockquote|pre|img)/.test(m) ? m : '<p>' + m.trim() + '</p>';
                        });
                        
                        // Listeleri düzelt
                        html = html.replace(/<\/li><li>/g, '</li>\n<li>');
                        html = html.replace(/<li>(.+?)(?=<\/li>)/g, '<li>$1');
                        html = html.replace(/<li>(.+?)(?=<li>)/g, '<ul><li>$1</li></ul>');
                        
                        return html;
                    };
                    
                    resultDiv.innerHTML = markdownToHtml(data.analysis);
                    document.getElementById('dailyAnalysisLastRun').textContent = new Date().toLocaleTimeString();
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">Hata: ${data.error}</div>`;
                }
            })
            .catch(error => {
                spinner.style.display = 'none';
                resultDiv.innerHTML = `<div class="alert alert-danger">İstek hatası: ${error.message}</div>`;
            });
        });
        
        // Riskli siparişleri kontrol et
        document.getElementById('checkRiskyOrders').addEventListener('click', function() {
            const resultDiv = document.getElementById('riskyOrdersResult');
            const spinner = document.getElementById('riskyOrdersSpinner');
            
            resultDiv.innerHTML = '';
            spinner.style.display = 'block';
            
            fetch('/api/ai-brain/check-orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                spinner.style.display = 'none';
                
                if (data.success) {
                    const analysis = data.analysis;
                    document.getElementById('riskyOrdersLastRun').textContent = new Date().toLocaleTimeString();
                    
                    // Bir sonraki çalışma zamanını hesapla ve göster
                    const nextRun = new Date();
                    nextRun.setHours(nextRun.getHours() + 4);
                    document.getElementById('riskyOrdersNextRun').textContent = nextRun.toLocaleTimeString();
                    
                    if (analysis.risky_orders && analysis.risky_orders.length > 0) {
                        let html = `<div class="alert alert-warning">
                            <strong>${analysis.risky_orders.length} adet riskli sipariş tespit edildi.</strong>
                            <p>${analysis.summary}</p>
                        </div>
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Sipariş No</th>
                                    <th>Risk Seviyesi</th>
                                    <th>Risk Nedenleri</th>
                                    <th>Öneri</th>
                                </tr>
                            </thead>
                            <tbody>`;
                        
                        analysis.risky_orders.forEach(order => {
                            const riskLevelClass = order.risk_level === 'yüksek' ? 'danger' : 
                                                  order.risk_level === 'orta' ? 'warning' : 'info';
                            
                            html += `<tr>
                                <td>${order.order_number}</td>
                                <td><span class="badge bg-${riskLevelClass}">${order.risk_level}</span></td>
                                <td><ul class="mb-0 ps-3">`;
                            
                            order.risk_reasons.forEach(reason => {
                                html += `<li>${reason}</li>`;
                            });
                            
                            html += `</ul></td>
                                <td>${order.recommendation}</td>
                            </tr>`;
                        });
                        
                        html += `</tbody></table>`;
                        resultDiv.innerHTML = html;
                    } else {
                        resultDiv.innerHTML = `<div class="alert alert-success">Riskli sipariş tespit edilmedi.</div>`;
                    }
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">Hata: ${data.error}</div>`;
                }
            })
            .catch(error => {
                spinner.style.display = 'none';
                resultDiv.innerHTML = `<div class="alert alert-danger">İstek hatası: ${error.message}</div>`;
            });
        });
        
        // Stok durumunu kontrol et
        document.getElementById('checkStockStatus').addEventListener('click', function() {
            const resultDiv = document.getElementById('stockStatusResult');
            const spinner = document.getElementById('stockStatusSpinner');
            
            resultDiv.innerHTML = '';
            spinner.style.display = 'block';
            
            // AI Brain'den stok özeti al
            fetch('/api/ai-brain/ask', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    question: 'Stok durumu nedir? Düşük stoklu ve tükenmiş ürünleri listele.'
                }),
            })
            .then(response => response.json())
            .then(data => {
                spinner.style.display = 'none';
                
                if (data.success) {
                    resultDiv.innerHTML = `<div class="p-3">${data.answer.replace(/\n/g, '<br>')}</div>`;
                    document.getElementById('stockCheckLastRun').textContent = new Date().toLocaleTimeString();
                    
                    // Bir sonraki çalışma zamanını hesapla ve göster
                    const nextRun = new Date();
                    nextRun.setHours(nextRun.getHours() + 1);
                    document.getElementById('stockCheckNextRun').textContent = nextRun.toLocaleTimeString();
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">Hata: ${data.error}</div>`;
                }
            })
            .catch(error => {
                spinner.style.display = 'none';
                resultDiv.innerHTML = `<div class="alert alert-danger">İstek hatası: ${error.message}</div>`;
            });
        });
        
        // Soru-cevap işlevi
        document.getElementById('askQuestion').addEventListener('click', function() {
            const questionInput = document.getElementById('questionInput');
            const question = questionInput.value.trim();
            
            if (!question) {
                alert('Lütfen bir soru girin.');
                return;
            }
            
            const resultDiv = document.getElementById('questionResult');
            const answerContent = document.getElementById('answerContent');
            const spinner = document.getElementById('questionSpinner');
            
            resultDiv.style.display = 'none';
            answerContent.innerHTML = '';
            spinner.style.display = 'block';
            
            fetch('/api/ai-brain/ask', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    question: question
                }),
            })
            .then(response => response.json())
            .then(data => {
                spinner.style.display = 'none';
                resultDiv.style.display = 'block';
                
                if (data.success) {
                    answerContent.innerHTML = data.answer.replace(/\n/g, '<br>');
                } else {
                    answerContent.innerHTML = `<div class="alert alert-danger">Hata: ${data.error}</div>`;
                }
            })
            .catch(error => {
                spinner.style.display = 'none';
                resultDiv.style.display = 'block';
                answerContent.innerHTML = `<div class="alert alert-danger">İstek hatası: ${error.message}</div>`;
            });
        });
        
        // Sayfa yüklendiğinde tarih ve saatleri ayarla
        const now = new Date();
        // Sonraki çalışma zamanlarını hesapla
        const nextStockCheck = new Date();
        nextStockCheck.setMinutes(0);
        nextStockCheck.setSeconds(0);
        nextStockCheck.setHours(nextStockCheck.getHours() + 1);
        
        const nextRiskyCheck = new Date();
        nextRiskyCheck.setMinutes(0);
        nextRiskyCheck.setSeconds(0);
        const hours = nextRiskyCheck.getHours();
        nextRiskyCheck.setHours(hours + (4 - (hours % 4)));
        
        document.getElementById('stockCheckNextRun').textContent = nextStockCheck.toLocaleTimeString();
        document.getElementById('riskyOrdersNextRun').textContent = nextRiskyCheck.toLocaleTimeString();
    });
</script>
{% endblock %}