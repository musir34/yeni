<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sipariş Detayı #{{ order.order_number }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .detail-section {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .detail-section h5 {
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .info-row:last-child {
            border-bottom: none;
        }
        .info-label {
            font-weight: 600;
            color: #6c757d;
        }
        .product-item {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .note-item {
            background: #f8f9fa;
            border-left: 3px solid #0d6efd;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Başlık -->
        <div class="row mb-4">
            <div class="col">
                <a href="{{ url_for('woo.orders') }}" class="btn btn-outline-secondary mb-2">
                    <i class="bi bi-arrow-left"></i> Sipariş Listesine Dön
                </a>
                <h1 class="h3 mb-0">
                    <i class="bi bi-receipt text-primary"></i>
                    Sipariş #{{ order.order_number }}
                </h1>
            </div>
            <div class="col-auto">
                <!-- Teslimat Etiketi Butonu -->
                <a href="{{ url_for('woo.shipping_label', order_id=order.id) }}" 
                   class="btn btn-success me-2" 
                   target="_blank">
                    <i class="bi bi-printer"></i> Teslimat Etiketi
                </a>
                
                <span class="badge fs-6
                    {% if order.status == 'completed' %}bg-success
                    {% elif order.status == 'processing' %}bg-info
                    {% elif order.status == 'pending' %}bg-warning
                    {% elif order.status == 'cancelled' %}bg-danger
                    {% elif order.status == 'shipped' %}bg-primary
                    {% elif order.status == 'on-hold' %}bg-secondary
                    {% else %}bg-dark{% endif %}">
                    {{ statuses.get(order.status, order.status) }}
                </span>
                
                <!-- Hızlı Sipariş İçin Bilgi Gir Butonu -->
                {% if not order.customer.first_name or not order.customer.phone or not order.billing_address.address_1 %}
                <button type="button" class="btn btn-warning btn-sm ms-2" data-bs-toggle="modal" data-bs-target="#customerInfoModal">
                    <i class="bi bi-person-plus"></i> Bilgi Gir
                </button>
                {% endif %}
            </div>
        </div>

        <div class="row">
            <!-- Sol Kolon -->
            <div class="col-lg-8">
                <!-- Ürünler -->
                <div class="detail-section">
                    <h5><i class="bi bi-box-seam"></i> Sipariş Kalemleri</h5>
                    {% for item in order.line_items %}
                    <div class="product-item">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h6 class="mb-1">{{ item.name }}</h6>
                                {% if item.sku %}
                                <small class="text-muted">SKU: {{ item.sku }}</small>
                                {% endif %}
                            </div>
                            <div class="col-md-2 text-center">
                                <small class="text-muted">Miktar</small>
                                <div class="fw-bold">{{ item.quantity }}</div>
                            </div>
                            <div class="col-md-2 text-center">
                                <small class="text-muted">Birim Fiyat</small>
                                <div class="fw-bold">{{ (item.total|float / item.quantity)|round(2) }} {{ order.currency }}</div>
                            </div>
                            <div class="col-md-2 text-end">
                                <small class="text-muted">Toplam</small>
                                <div class="h6 mb-0 text-success">{{ item.total }} {{ order.currency }}</div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    
                    <!-- Özet -->
                    <div class="mt-3 pt-3 border-top">
                        <div class="row">
                            <div class="col-md-8"></div>
                            <div class="col-md-4">
                                <div class="info-row">
                                    <span>Ara Toplam:</span>
                                    <span>{{ (order.total|float - order.shipping_total|float)|round(2) }} {{ order.currency }}</span>
                                </div>
                                <div class="info-row">
                                    <span>Kargo:</span>
                                    <span>{{ order.shipping_total }} {{ order.currency }}</span>
                                </div>
                                <div class="info-row">
                                    <span class="fw-bold">Genel Toplam:</span>
                                    <span class="fw-bold text-success fs-5">{{ order.total }} {{ order.currency }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notlar -->
                <div class="detail-section">
                    <h5><i class="bi bi-chat-left-text"></i> Sipariş Notları</h5>
                    {% if notes %}
                        {% for note in notes %}
                        <div class="note-item">
                            <div class="d-flex justify-content-between mb-2">
                                <strong>
                                    {% if note.customer_note %}
                                    <i class="bi bi-person-fill text-primary"></i> Müşteri Notu
                                    {% else %}
                                    <i class="bi bi-pencil-fill text-secondary"></i> Sistem Notu
                                    {% endif %}
                                </strong>
                                <small class="text-muted">{{ note.date_created[:16] if note.date_created else '' }}</small>
                            </div>
                            <div>{{ note.note }}</div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">Henüz not eklenmemiş.</p>
                    {% endif %}

                    <!-- Not Ekle Formu -->
                    <div class="mt-3">
                        <form id="addNoteForm">
                            <div class="mb-3">
                                <label class="form-label">Yeni Not Ekle</label>
                                <textarea class="form-control" id="noteText" rows="3" placeholder="Not içeriği..."></textarea>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="customerNote">
                                <label class="form-check-label" for="customerNote">
                                    Müşteriye göster
                                </label>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-plus-circle"></i> Not Ekle
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Sağ Kolon -->
            <div class="col-lg-4">
                <!-- Durum Güncelleme -->
                <div class="detail-section">
                    <h5><i class="bi bi-arrow-repeat"></i> Durum Güncelle</h5>
                    <form id="updateStatusForm">
                        <div class="mb-3">
                            <select class="form-select" id="newStatus">
                                {% for status_key, status_name in statuses.items() %}
                                <option value="{{ status_key }}" {% if order.status == status_key %}selected{% endif %}>
                                    {{ status_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success w-100">
                            <i class="bi bi-check-circle"></i> Durumu Güncelle
                        </button>
                    </form>
                </div>

                <!-- Müşteri Bilgileri -->
                <div class="detail-section">
                    <h5><i class="bi bi-person"></i> Müşteri Bilgileri</h5>
                    <div class="info-row">
                        <span class="info-label">Ad Soyad:</span>
                        <span>{{ order.customer.first_name }} {{ order.customer.last_name }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">E-posta:</span>
                        <span>{{ order.customer.email or 'Belirtilmemiş' }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Telefon:</span>
                        <span>{{ order.customer.phone or 'Belirtilmemiş' }}</span>
                    </div>
                </div>

                <!-- Fatura Adresi -->
                <div class="detail-section">
                    <h5><i class="bi bi-file-earmark-text"></i> Fatura Adresi</h5>
                    <address>
                        {{ order.billing_address.address_1 }}<br>
                        {% if order.billing_address.address_2 %}
                        {{ order.billing_address.address_2 }}<br>
                        {% endif %}
                        {{ order.billing_address.city }}, {{ order.billing_address.state }}<br>
                        {{ order.billing_address.postcode }}<br>
                        {{ order.billing_address.country }}
                    </address>
                </div>

                <!-- Teslimat Adresi -->
                <div class="detail-section">
                    <h5><i class="bi bi-truck"></i> Teslimat Adresi</h5>
                    <address>
                        {{ order.shipping_address.address_1 or order.billing_address.address_1 }}<br>
                        {% if order.shipping_address.address_2 or order.billing_address.address_2 %}
                        {{ order.shipping_address.address_2 or order.billing_address.address_2 }}<br>
                        {% endif %}
                        {{ order.shipping_address.city or order.billing_address.city }}, 
                        {{ order.shipping_address.state or order.billing_address.state }}<br>
                        {{ order.shipping_address.postcode or order.billing_address.postcode }}<br>
                        {{ order.shipping_address.country or order.billing_address.country }}
                    </address>
                </div>

                <!-- Ödeme Bilgisi -->
                <div class="detail-section">
                    <h5><i class="bi bi-credit-card"></i> Ödeme</h5>
                    <div class="info-row">
                        <span class="info-label">Yöntem:</span>
                        <span>{{ order.payment_method or 'Belirtilmemiş' }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Tarih:</span>
                        <span>{{ order.date_created[:10] if order.date_created else 'Belirtilmemiş' }}</span>
                    </div>
                </div>

                <!-- Müşteri Notu -->
                {% if order.customer_note %}
                <div class="detail-section">
                    <h5><i class="bi bi-chat-quote"></i> Müşteri Notu</h5>
                    <p class="mb-0">{{ order.customer_note }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Müşteri Bilgileri Modal -->
    <div class="modal fade" id="customerInfoModal" tabindex="-1" aria-labelledby="customerInfoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customerInfoModalLabel">
                        <i class="bi bi-person-plus"></i> Müşteri Bilgilerini Gir
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="customerInfoForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="firstName" class="form-label">Ad <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="firstName" required 
                                       value="{{ order.customer.first_name or '' }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="lastName" class="form-label">Soyad <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="lastName" required
                                       value="{{ order.customer.last_name or '' }}">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="phone" class="form-label">Telefon <span class="text-danger">*</span></label>
                                <input type="tel" class="form-control" id="phone" required
                                       value="{{ order.customer.phone or '' }}"
                                       placeholder="05XX XXX XX XX">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label">E-posta</label>
                                <input type="email" class="form-control" id="email"
                                       value="{{ order.customer.email or '' }}"
                                       placeholder="ornek@email.com">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="address" class="form-label">Adres <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="address" rows="2" required
                                      placeholder="Mahalle, sokak, bina no...">{{ order.billing_address.address_1 or '' }}</textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="city" class="form-label">İl <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="city" required
                                       value="{{ order.billing_address.city or '' }}"
                                       placeholder="İstanbul">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="state" class="form-label">İlçe</label>
                                <input type="text" class="form-control" id="state"
                                       value="{{ order.billing_address.state or '' }}"
                                       placeholder="Kadıköy">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="postcode" class="form-label">Posta Kodu</label>
                                <input type="text" class="form-control" id="postcode"
                                       value="{{ order.billing_address.postcode or '' }}"
                                       placeholder="34XXX">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="paymentMethod" class="form-label">Ödeme Yöntemi <span class="text-danger">*</span></label>
                            <select class="form-select" id="paymentMethod" required>
                                <option value="">Seçiniz...</option>
                                <option value="bacs" {% if order.payment_method == 'bacs' %}selected{% endif %}>Havale/EFT</option>
                                <option value="cod" {% if order.payment_method == 'cod' %}selected{% endif %}>Kapıda Ödeme</option>
                                <option value="credit_card" {% if order.payment_method == 'credit_card' %}selected{% endif %}>Kredi Kartı</option>
                                <option value="debit_card">Banka Kartı</option>
                                <option value="paypal">PayPal</option>
                                <option value="stripe">Stripe</option>
                                <option value="other">Diğer</option>
                            </select>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 
                            <small>Bu bilgiler WooCommerce'e kaydedilecek ve sipariş güncellenecektir.</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" id="saveCustomerInfo">
                        <i class="bi bi-save"></i> Kaydet
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Durum Güncelleme
        document.getElementById('updateStatusForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const newStatus = document.getElementById('newStatus').value;
            
            // Çöp kutusuna taşıma için onay iste
            if (newStatus === 'trash') {
                if (!confirm('Bu siparişi çöp kutusuna taşımak istediğinize emin misiniz?')) {
                    return;
                }
            }
            
            try {
                const response = await fetch('{{ url_for("woo.update_order_status", order_id=order.id) }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Sipariş durumu güncellendi!');
                    // Çöp kutusuna taşındıysa sipariş listesine yönlendir
                    if (data.deleted) {
                        window.location.href = '{{ url_for("woo.orders") }}';
                    } else {
                        location.reload();
                    }
                } else {
                    alert('Hata: ' + data.message);
                }
            } catch (error) {
                alert('Bir hata oluştu: ' + error.message);
            }
        });

        // Not Ekleme
        document.getElementById('addNoteForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const noteText = document.getElementById('noteText').value;
            const customerNote = document.getElementById('customerNote').checked;
            
            if (!noteText.trim()) {
                alert('Lütfen bir not girin.');
                return;
            }
            
            try {
                const response = await fetch('{{ url_for("woo.add_order_note", order_id=order.id) }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        note: noteText,
                        customer_note: customerNote 
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Not eklendi!');
                    location.reload();
                } else {
                    alert('Hata: ' + data.message);
                }
            } catch (error) {
                alert('Bir hata oluştu: ' + error.message);
            }
        });
        
        // Müşteri Bilgilerini Kaydet
        document.getElementById('saveCustomerInfo').addEventListener('click', async function() {
            const form = document.getElementById('customerInfoForm');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const customerData = {
                first_name: document.getElementById('firstName').value,
                last_name: document.getElementById('lastName').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                address: document.getElementById('address').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value,
                postcode: document.getElementById('postcode').value,
                country: 'TR',
                payment_method: document.getElementById('paymentMethod').value,
                payment_method_title: document.getElementById('paymentMethod').selectedOptions[0].text
            };
            
            const saveBtn = document.getElementById('saveCustomerInfo');
            const originalText = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Kaydediliyor...';
            
            try {
                const response = await fetch('{{ url_for("woo.update_customer_info", order_id=order.id) }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(customerData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Müşteri bilgileri başarıyla güncellendi!');
                    location.reload();
                } else {
                    alert('Hata: ' + data.message);
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = originalText;
                }
            } catch (error) {
                alert('Bir hata oluştu: ' + error.message);
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
            }
        });
    </script>
</body>
</html>
