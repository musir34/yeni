<!DOCTYPE html>
<html>
<head>
  <title>Barkod Etiketleri Yazdırma - Güllü Ayakkabı</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      font-family: Arial, Helvetica, sans-serif;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 30px;
    }
    .barcode-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .barcode-card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 15px;
      text-align: center;
      position: relative;
    }
    .barcode-card.printed {
      background-color: #e8f5e9;
    }
    .print-status {
      position: absolute;
      top: 10px;
      right: 10px;
      color: #4caf50;
      font-weight: bold;
    }
    .barcode-image {
      max-width: 120px;
      max-height: 120px;
      margin: 0 auto 10px;
      display: block;
    }
    .barcode-info {
      margin-bottom: 15px;
    }
    .barcode-info span {
      display: block;
      margin-bottom: 5px;
      font-size: 15px;
    }
    .barcode-text {
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 10px;
      word-break: break-all;
    }
    .print-button {
      background-color: #2196f3;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      width: 100%;
      margin-top: 10px;
    }
    .print-button:hover {
      background-color: #1976d2;
    }
    .a4-button {
      background-color: #4caf50;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      display: block;
      margin: 20px auto;
      font-size: 16px;
    }
    .a4-button:hover {
      background-color: #388e3c;
    }
    .nav-buttons {
      display: flex;
      justify-content: center;
      margin-top: 30px;
      gap: 20px;
    }
    .nav-buttons a {
      text-decoration: none;
      color: white;
      background-color: #3f51b5;
      padding: 10px 20px;
      border-radius: 4px;
      font-weight: bold;
    }
    .info-box {
      background-color: #e3f2fd;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 5px solid #2196f3;
      text-align: left;
    }
    .info-box h3 {
      margin-top: 0;
      color: #0d47a1;
    }
  </style>
</head>
<body data-siparis-id="{{ siparis_id }}">
  <div class="container">
    <h1>Barkod Etiketleri Yazdırma</h1>
    
    <div class="info-box">
      <h3>Barkod Yazdırma</h3>
      <p>1. Her barkod için "Bu Barkodu Yazdır" butonuna tıklayarak ayrı ayrı yazdırabilirsiniz.</p>
      <p>2. Aşağıdaki yeşil buton ile tüm barkodları A4 kağıtta düzenli biçimde yazdırabilirsiniz.</p>
    </div>

    <button class="a4-button" id="a4Button">Tüm Barkodları A4 Kağıtta Düzenle</button>
    
    <div class="barcode-grid">
      {% for item in barcodes %}
        {% for j in range(item.print_count) %}
          <div class="barcode-card {% if item.is_printed %}printed{% endif %}" data-barcode="{{ item.barcode }}">
            {% if item.is_printed %}
              <span class="print-status">✓ Yazdırıldı</span>
            {% endif %}
            <img class="barcode-image" src="{{ item.qr_image_path }}" alt="QR Kod: {{ item.barcode }}">
            <div class="barcode-text">{{ item.barcode }}</div>
            <div class="barcode-info">
              <span><strong>Model:</strong> {{ item.model }}</span>
              <span><strong>Renk:</strong> {{ item.color }}</span>
              <span><strong>Beden:</strong> {{ item.size }}</span>
            </div>
            <button class="print-button" onclick="printSingleBarcode('{{ item.barcode }}', '{{ item.model }}', '{{ item.color }}', '{{ item.size }}', '{{ item.qr_image_path }}')">
              Bu Barkodu Yazdır
            </button>
          </div>
        {% endfor %}
      {% endfor %}
    </div>
    
    <div class="nav-buttons">
      <a href="{{ url_for('home.home') }}">Ana Sayfa</a>
      <a href="{{ url_for('siparis_fisi_bp.siparis_fisi_sayfasi') }}">Sipariş Fişleri</a>
    </div>
  </div>

  <script>
    // Bütün barkodları topla
    const allBarcodes = [];
    {% for item in barcodes %}
      {% for j in range(item.print_count) %}
        allBarcodes.push({
          barcode: "{{ item.barcode }}",
          model: "{{ item.model }}",
          color: "{{ item.color }}",
          size: "{{ item.size }}",
          qrPath: "{{ item.qr_image_path }}"
        });
      {% endfor %}
    {% endfor %}

    const siparisId = Number(document.body.dataset.siparisId || 0);

    // Tek barkod yazdırma fonksiyonu
    function printSingleBarcode(barcode, model, color, size, qrPath) {
      const printWindow = window.open("", "_blank");
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Barkod: ${barcode}</title>
          <style>
            @page {
              size: 67mm 41mm;
              margin: 0;
            }
            body {
              margin: 0;
              padding: 0;
              width: 67mm;
              height: 41mm;
              font-family: Arial, sans-serif;
            }
            .label {
              display: flex;
              width: 100%;
              height: 100%;
            }
            .left {
              width: 50%;
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              padding: 2mm;
            }
            .right {
              width: 50%;
              display: flex;
              flex-direction: column;
              justify-content: center;
              text-align: center;
              padding: 2mm;
            }
            img {
              max-width: 22mm;
              max-height: 22mm;
              margin-bottom: 2mm;
            }
            .barcode-text {
              font-size: 9.5pt;
              text-align: center;
              font-weight: bold;
              word-break: break-all;
            }
            .info {
              margin-bottom: 3mm;
              font-size: 10pt;
              font-weight: 600;
            }
          </style>
        </head>
        <body>
          <div class="label">
            <div class="left">
              <img src="${qrPath}" alt="QR Kod">
              <div class="barcode-text">${barcode}</div>
            </div>
            <div class="right">
              <div class="info">Model: ${model}</div>
              <div class="info">Renk: ${color}</div>
              <div class="info">Beden: ${size}</div>
            </div>
          </div>
          <script>
            window.onload = function() {
              setTimeout(function() {
                window.print();
                setTimeout(function() {
                  window.close();
                }, 500);
              }, 300);
            };
          <\/script>
        </body>
        </html>
      `);
      printWindow.document.close();
      
      // Yazdırma işlemi tamamlandıktan sonra sunucuya bildir
      setTimeout(function() {
        markAsPrinted([barcode]);
      }, 2000);
    }

    // A4 düzeninde tüm barkodları yazdırma
    document.getElementById('a4Button').addEventListener('click', function() {
      const printWindow = window.open('', '_blank');
      const totalBarcodes = allBarcodes.length;
      const barcodesPerPage = 21; // 3 sütun x 7 satır
      const totalPages = Math.ceil(totalBarcodes / barcodesPerPage);
      
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>A4 Barkod Düzeni</title>
          <style>
            @page {
              size: A4;
              margin: 0;
              orphans: 0; /* Sayfa sonunda tek kalan öğeler için davranış ayarlaması */
              widows: 0; /* Sayfa başında kalan öğeler için davranış ayarlaması */
            }
            /* Yazdırma özellikleri */
            @media print {
              body, html {
                width: 210mm;
                height: 297mm;
                overflow: hidden; /* Taşan içerik boş sayfalara neden olmasın */
                -webkit-print-color-adjust: exact !important; /* Chrome için */
                color-adjust: exact !important; /* Firefox için */
              }
            }
            body {
              margin: 0;
              padding: 0;
              background: white;
              font-family: Arial, sans-serif;
            }
            .page {
              width: 210mm;
              height: 297mm;
              page-break-after: auto; /* always yerine auto kullanıyoruz */
              display: grid;
              grid-template-columns: repeat(3, 67mm);
              grid-template-rows: repeat(7, 41mm);
              column-gap: 3mm;
              row-gap: 1mm;
              padding: 15mm 8mm 15mm 8mm; /* Yukarı, Sağ, Alt, Sol */
            }
            .label {
              display: flex;
              border: none;
              box-sizing: border-box;
            }
            .left {
              width: 50%;
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              padding: 2mm;
            }
            .right {
              width: 50%;
              display: flex;
              flex-direction: column;
              justify-content: center;
              text-align: center;
              padding: 2mm;
            }
            img {
              max-width: 22mm;
              max-height: 22mm;
              margin-bottom: 2mm;
            }
            .barcode-text {
              font-size: 9.5pt;
              text-align: center;
              font-weight: bold;
              word-break: break-all;
            }
            .info {
              margin-bottom: 3mm;
              font-size: 10pt;
              font-weight: 600;
            }
          </style>
        </head>
        <body>
      `);
      
      // Sayfaları oluştur
      for (let page = 0; page < totalPages; page++) {
        // Son sayfada page-break-after: avoid kullanacağız böylece son sayfadan sonra boş sayfa oluşmayacak
        const isLastPage = page === totalPages - 1;
        printWindow.document.write(`<div class="page" style="${isLastPage ? 'page-break-after: avoid;' : ''}">`);
        
        // Her sayfadaki etiketleri ekle
        for (let i = 0; i < barcodesPerPage; i++) {
          const index = page * barcodesPerPage + i;
          if (index < totalBarcodes) {
            const item = allBarcodes[index];
            printWindow.document.write(`
              <div class="label">
                <div class="left">
                  <img src="${item.qrPath}" alt="QR Kod">
                  <div class="barcode-text">${item.barcode}</div>
                </div>
                <div class="right">
                  <div class="info">Model: ${item.model}</div>
                  <div class="info">Renk: ${item.color}</div>
                  <div class="info">Beden: ${item.size}</div>
                </div>
              </div>
            `);
          } else {
            // Boş etiketleri tamamen gizleyelim - çıktıya gereksiz boşluk eklemesin
            printWindow.document.write(`<div class="label" style="visibility: hidden;"></div>`);
          }
        }
        
        printWindow.document.write(`</div>`);
      }
      
      printWindow.document.write(`
          <script>
            window.onload = function() {
              setTimeout(function() {
                window.print();
              }, 500);
            };
          <\/script>
        </body>
        </html>
      `);
      
      printWindow.document.close();
      
      // Yazdırma işlemi tamamlandıktan sonra sunucuya bildir
      setTimeout(function() {
        const allBarcodeValues = allBarcodes.map(item => item.barcode);
        const uniqueBarcodeValues = [...new Set(allBarcodeValues)];
        markAsPrinted(uniqueBarcodeValues);
      }, 2000);
    });

    // Yazdırma durumunu sunucuya bildiren fonksiyon
    function markAsPrinted(barcodes) {
      if (!siparisId || !barcodes || barcodes.length === 0) return;
      
      fetch("{{ url_for('siparis_fisi_bp.mark_as_printed') }}", {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({siparis_id: siparisId, barcodes: barcodes})
      })
      .then(response => response.json())
      .then(data => {
        if (data.success && data.added && Array.isArray(data.added)) {
          data.added.forEach(barcode => {
            document.querySelectorAll(`.barcode-card[data-barcode="${barcode}"]`).forEach(card => {
              card.classList.add('printed');
              if (!card.querySelector('.print-status')) {
                const status = document.createElement('span');
                status.className = 'print-status';
                status.textContent = '✓ Yazdırıldı';
                card.appendChild(status);
              }
            });
          });
        }
      })
      .catch(error => console.error('Yazdırma durumu gönderilemedi:', error));
    }
  </script>
</body>
</html>
