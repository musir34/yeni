<!DOCTYPE html>
<html>
<head>
  <title>Barkod Etiketleri Yazdırma - Güllü Ayakkabı (Her A4 Sayfasında 21 Etiket)</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      font-family: Arial, Helvetica, sans-serif;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 30px;
    }
    h3 {
      color: #34495e;
      margin-top: 10px;
      margin-bottom: 5px;
      text-align: center;
    }
    .barcode-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .barcode-card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 15px;
      text-align: center;
      position: relative;
    }
    .barcode-card.printed {
      background-color: #e8f5e9;
    }
    .print-status {
      position: absolute;
      top: 10px;
      right: 10px;
      color: #4caf50;
      font-weight: bold;
    }
    .barcode-image {
      max-width: 120px;
      max-height: 120px;
      margin: 0 auto 10px;
      display: block;
    }
    .barcode-info {
      margin-bottom: 15px;
    }
    .barcode-info span {
      display: block;
      margin-bottom: 5px;
      font-size: 15px;
    }
    .barcode-text {
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 10px;
      word-break: break-all;
    }
    .print-button {
      background-color: #2196f3;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      width: 100%;
      margin-top: 10px;
    }
    .print-button:hover {
      background-color: #1976d2;
    }
    .print-button:disabled {
      background-color: #bdbdbd;
      cursor: not-allowed;
    }
    .nav-buttons {
      display: flex;
      justify-content: center;
      margin-top: 40px;
      gap: 20px;
    }
    .nav-buttons a {
      text-decoration: none;
      color: white;
      background-color: #3f51b5;
      padding: 10px 20px;
      border-radius: 4px;
      font-weight: bold;
    }
    .nav-buttons a:hover {
      background-color: #303f9f;
    }
    .print-all-container {
      text-align: center;
      margin: 20px 0;
    }
    .print-all-button {
      background-color: #4caf50;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
    }
    .print-all-button:hover {
      background-color: #388e3c;
    }
    .instructions {
      background-color: #fff3e0;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 5px solid #ff9800;
    }
    .instructions h3 {
      color: #e65100;
      text-align: left;
      margin-top: 0;
    }
    .instructions p {
      margin-bottom: 5px;
    }

    /* Yazdırma şablonu için stiller */
    @media print {
      .print-page {
        width: 210mm;
        height: 297mm;
        margin: 0;
        padding: 0;
        page-break-after: always;
        display: grid;
        grid-template-columns: repeat(3, 69mm);
        grid-template-rows: repeat(7, 42mm);
        gap: 1mm;
        background: white;
      }
      .print-label {
        width: 69mm;
        height: 42mm;
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        box-sizing: border-box;
        overflow: hidden;
      }
      .print-left {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 50%;
        height: 100%;
      }
      .print-right {
        display: flex;
        flex-direction: column;
        justify-content: center;
        width: 50%;
        height: 100%;
        font-size: 10pt;
        padding: 0 2mm;
        text-align: center;
      }
      .print-right div {
        margin-bottom: 3mm;
        font-size: 10pt;
        font-weight: 600;
      }
      .print-qr {
        max-width: 22mm;
        max-height: 22mm;
        margin-bottom: 2mm;
      }
      .print-barcode-text {
        font-size: 9.5pt;
        text-align: center;
        margin: 0;
        padding: 0;
        word-break: break-all;
        width: 100%;
        font-weight: bold;
      }
      /* Ekran görünümünü yazdırma sırasında gizle */
      .container, .barcode-grid, .barcode-card, .nav-buttons, .instructions, 
      .print-all-container, h1, h3, #print-templates-container {
        display: none !important;
      }
    }
  </style>
</head>
<body data-siparis-id="{{ siparis_id }}">
  <div class="container">
    <h1>Barkod Etiketleri Yazdırma</h1>
    
    <div class="instructions">
      <h3>Nasıl Çalışır?</h3>
      <p>1. Her barkod için ayrı bir kart görüntülenir.</p>
      <p>2. Her karttaki "Bu Barkodu Yazdır" butonuyla tek bir barkodu yazdırabilirsiniz.</p>
      <p>3. "Tüm Barkodları A4 Kağıtta Düzenle" butonu ile tüm barkodları A4 kağıt düzeninde yazdırabilirsiniz.</p>
      <p>4. Her A4 kağıda 21 adet barkod etiketi sığacak şekilde düzenlenmiştir (3 sütun x 7 satır).</p>
    </div>

    <div class="print-all-container">
      <button id="printAllA4Button" class="print-all-button">Tüm Barkodları A4 Kağıtta Düzenle</button>
    </div>

    <div class="barcode-grid" id="barcode-grid">
      {% for item in barcodes %}
        {% for j in range(item.print_count) %}
          <div class="barcode-card {% if item.is_printed %}printed{% endif %}" data-barcode="{{ item.barcode }}">
            {% if item.is_printed %}
              <span class="print-status">✓ Yazdırıldı</span>
            {% endif %}
            <img class="barcode-image" src="{{ item.qr_image_path }}" alt="QR Kod: {{ item.barcode }}">
            <div class="barcode-text">{{ item.barcode }}</div>
            <div class="barcode-info">
              <span><strong>Model:</strong> {{ item.model }}</span>
              <span><strong>Renk:</strong> {{ item.color }}</span>
              <span><strong>Beden:</strong> {{ item.size }}</span>
            </div>
            <button class="print-button single-print-button" data-barcode="{{ item.barcode }}" 
                    data-model="{{ item.model }}" data-color="{{ item.color }}" data-size="{{ item.size }}"
                    data-qr-path="{{ item.qr_image_path }}">
                Bu Barkodu Yazdır
            </button>
          </div>
        {% endfor %}
      {% endfor %}
    </div>
    
    <div id="print-templates-container" style="display: none;"></div>

    <div class="nav-buttons">
      <a href="{{ url_for('home.home') }}">Ana Sayfa</a>
      <a href="{{ url_for('siparis_fisi_bp.siparis_fisi_sayfasi') }}">Sipariş Fişleri</a>
    </div>
  </div>

  <script>
    // Tüm barkod bilgilerini topla
    const allBarcodes = [];
    {% for item in barcodes %}
      {% for j in range(item.print_count) %}
        allBarcodes.push({
          barcode: "{{ item.barcode }}",
          model: "{{ item.model }}",
          color: "{{ item.color }}",
          size: "{{ item.size }}",
          qrPath: "{{ item.qr_image_path }}"
        });
      {% endfor %}
    {% endfor %}

    // Sipariş ID
    const siparisId = Number(document.body.dataset.siparisId || 0);
    
    // Tek barkod yazdırma işlevi
    document.querySelectorAll('.single-print-button').forEach(button => {
      button.addEventListener('click', function() {
        const barcode = this.dataset.barcode;
        const model = this.dataset.model;
        const color = this.dataset.color;
        const size = this.dataset.size;
        const qrPath = this.dataset.qrPath;
        
        // Tek bir barkod için yazdırma şablonu oluştur
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
          <!DOCTYPE html>
          <html>
          <head>
            <title>Barkod Yazdırma - ${barcode}</title>
            <style>
              @page {
                size: 69mm 42mm;
                margin: 0;
              }
              body {
                margin: 0;
                padding: 0;
                width: 69mm;
                height: 42mm;
                display: flex;
                font-family: Arial, sans-serif;
              }
              .label {
                display: flex;
                width: 100%;
                height: 100%;
              }
              .left {
                width: 50%;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
              }
              .right {
                width: 50%;
                display: flex;
                flex-direction: column;
                justify-content: center;
                text-align: center;
              }
              img {
                max-width: 22mm;
                max-height: 22mm;
                margin-bottom: 2mm;
              }
              .barcode-text {
                font-size: 9.5pt;
                text-align: center;
                font-weight: bold;
                word-break: break-all;
              }
              .info {
                margin-bottom: 3mm;
                font-size: 10pt;
                font-weight: 600;
              }
            </style>
          </head>
          <body>
            <div class="label">
              <div class="left">
                <img src="${qrPath}" alt="QR Kod: ${barcode}">
                <div class="barcode-text">${barcode}</div>
              </div>
              <div class="right">
                <div class="info">Model: ${model}</div>
                <div class="info">Renk: ${color}</div>
                <div class="info">Beden: ${size}</div>
              </div>
            </div>
            <script>
              window.onload = function() {
                setTimeout(function() {
                  window.print();
                  setTimeout(function() {
                    window.close();
                  }, 500);
                }, 200);
              };
            </script>
          </body>
          </html>
        `);
        printWindow.document.close();
        
        // Yazdırma işlemi tamamlandıktan sonra sunucuya bildir
        printWindow.onafterprint = function() {
          sendPrintStatus([barcode]);
        };
      });
    });
    
    // A4 kağıdına tüm barkodları düzenle ve yazdır
    document.getElementById('printAllA4Button').addEventListener('click', function() {
      // A4 sayfalarını oluştur - her sayfada 21 etiket (3x7)
      const totalBarcodes = allBarcodes.length;
      const barcodesPerPage = 21;
      const totalPages = Math.ceil(totalBarcodes / barcodesPerPage);
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Barkod Etiketleri - A4 Düzeni</title>
          <style>
            @page {
              size: A4;
              margin: 0;
            }
            body {
              margin: 0;
              padding: 0;
              background: white;
              font-family: Arial, sans-serif;
            }
            .print-page {
              width: 210mm;
              height: 297mm;
              page-break-after: always;
              display: grid;
              grid-template-columns: repeat(3, 69mm);
              grid-template-rows: repeat(7, 42mm);
              gap: 1mm;
              padding: 0.5mm;
            }
            .print-label {
              display: flex;
              flex-direction: row;
              align-items: center;
              justify-content: center;
              overflow: hidden;
            }
            .print-left {
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              width: 50%;
              height: 100%;
            }
            .print-right {
              display: flex;
              flex-direction: column;
              justify-content: center;
              width: 50%;
              height: 100%;
              font-size: 10pt;
              padding: 0 2mm;
              text-align: center;
            }
            .print-right div {
              margin-bottom: 3mm;
              font-size: 10pt;
              font-weight: 600;
            }
            .print-qr {
              max-width: 22mm;
              max-height: 22mm;
              margin-bottom: 2mm;
            }
            .print-barcode-text {
              font-size: 9.5pt;
              text-align: center;
              margin: 0;
              padding: 0;
              word-break: break-all;
              width: 100%;
              font-weight: bold;
            }
          </style>
        </head>
        <body>
      `);
      
      for (let page = 0; page < totalPages; page++) {
        printWindow.document.write(`<div class="print-page">`);
        
        for (let i = 0; i < barcodesPerPage; i++) {
          const index = page * barcodesPerPage + i;
          if (index < totalBarcodes) {
            const item = allBarcodes[index];
            printWindow.document.write(`
              <div class="print-label">
                <div class="print-left">
                  <img class="print-qr" src="${item.qrPath}" alt="QR Kod: ${item.barcode}">
                  <div class="print-barcode-text">${item.barcode}</div>
                </div>
                <div class="print-right">
                  <div>Model: ${item.model}</div>
                  <div>Renk: ${item.color}</div>
                  <div>Beden: ${item.size}</div>
                </div>
              </div>
            `);
          } else {
            // Boş etiket
            printWindow.document.write(`<div class="print-label"></div>`);
          }
        }
        
        printWindow.document.write(`</div>`);
      }
      
      printWindow.document.write(`
          <script>
            window.onload = function() {
              setTimeout(function() {
                window.print();
              }, 500);
            };
          </script>
        </body>
        </html>
      `);
      printWindow.document.close();
      
      // Yazdırma işlemi tamamlandıktan sonra sunucuya bildir
      printWindow.onafterprint = function() {
        const allBarcodeValues = allBarcodes.map(item => item.barcode);
        const uniqueBarcodeValues = [...new Set(allBarcodeValues)];
        sendPrintStatus(uniqueBarcodeValues);
      };
    });
    
    // Yazdırma durumunu sunucuya bildiren fonksiyon
    async function sendPrintStatus(list_of_barcodes) {
      if (!siparisId || !list_of_barcodes || list_of_barcodes.length === 0) return;
      
      try {
        const url = "{{ url_for('siparis_fisi_bp.mark_as_printed') }}";
        const response = await fetch(url, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({siparis_id: siparisId, barcodes: list_of_barcodes})
        });
        
        if (response.ok) {
          const responseData = await response.json();
          if (responseData.success) {
            if (responseData.added && Array.isArray(responseData.added)) {
              responseData.added.forEach(bc => {
                document.querySelectorAll(`.barcode-card[data-barcode="${bc}"]`).forEach(card => {
                  card.classList.add('printed');
                  if (!card.querySelector('.print-status')) {
                    const statusElement = document.createElement('span');
                    statusElement.className = 'print-status';
                    statusElement.textContent = '✓ Yazdırıldı';
                    card.appendChild(statusElement);
                  }
                });
              });
            }
          }
        }
      } catch(e) {
        console.error('Yazdırma durumu gönderilirken hata oluştu:', e);
      }
    }
  </script>
</body>
</html>
