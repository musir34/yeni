<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Güllü Shoes Akıllı Stok Zekası</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .card-stock-status {
            position: relative;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .card-stock-status:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        .status-indicator {
            position: absolute;
            top: 0;
            right: 0;
            width: 10px;
            height: 100%;
        }
        
        .status-critical {
            background-color: #dc3545;
        }
        
        .status-warning {
            background-color: #ffc107;
        }
        
        .status-healthy {
            background-color: #28a745;
        }
        
        .card-inner-content {
            padding: 1.25rem;
        }
        
        .stock-info {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .stock-metric {
            display: flex;
            justify-content: space-between;
        }
        
        .stock-metric-label {
            color: #6c757d;
            font-size: 0.875rem;
        }
        
        .stock-metric-value {
            font-weight: 500;
        }
        
        .days-badge {
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .product-image-container {
            width: 80px;
            height: 80px;
            overflow: hidden;
            border-radius: 0.25rem;
            margin-right: 1rem;
        }
        
        .product-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .stock-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .stock-card-title {
            margin-bottom: 0.2rem;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .stock-card-subtitle {
            color: #6c757d;
            font-size: 0.85rem;
        }
        
        .action-badge {
            display: inline-block;
            padding: 0.35em 0.65em;
            font-size: 0.75em;
            font-weight: 500;
            line-height: 1;
            color: #fff;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.375rem;
        }
        
        .overview-card {
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            transition: all 0.3s ease;
        }
        
        .overview-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 8px rgba(0, 0, 0, 0.12);
        }
        
        .overview-card-icon {
            font-size: 2rem;
            color: #6c757d;
        }
        
        .overview-card-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1.5rem;
        }
        
        .overview-card-title {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 0.75rem;
        }
        
        .overview-card-value {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .overview-card-trend {
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .trend-up {
            color: #28a745;
        }
        
        .trend-down {
            color: #dc3545;
        }
        
        #stockAnalysisTable th, 
        #stockAnalysisTable td {
            vertical-align: middle;
        }
        
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
        }
        
        .chart-container {
            height: 400px;
            width: 100%;
        }
        
        .product-detail-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }
        
        .product-detail-info {
            flex: 1;
        }
        
        .recommendation-box {
            border-left: 4px solid #17a2b8;
            padding: 1rem;
            background-color: #f8f9fa;
            margin-bottom: 1.5rem;
        }
        
        .recommendation-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #17a2b8;
        }
        
        @media (max-width: 768px) {
            .overview-card-content {
                padding: 1rem;
            }
            
            .overview-card-value {
                font-size: 1.5rem;
            }
            
            .overview-card-icon {
                font-size: 1.5rem;
            }
        }
        
        .navbar {
            background-color: #2c3e50;
        }
        
        .navbar-brand {
            font-weight: bold;
            color: white;
        }
        
        .nav-link {
            color: rgba(255, 255, 255, 0.8) !important;
        }
        
        .nav-link:hover {
            color: white !important;
        }
        
        .page-header {
            background-color: #f8f9fa;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-bottom: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/">Güllü Shoes</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="fas fa-home"></i> Anasayfa</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#"><i class="fas fa-brain"></i> Stok Zekası</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Content -->
    <div class="container-fluid py-4">
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="h3 mb-0 text-gray-800">Güllü Shoes Akıllı Stok Zekası</h1>
                <p class="mb-4">Stok durumunuzu yapay zeka yardımıyla analiz edin, gelecek satışlarınızı öngörün, üretim planlamanızı optimize edin</p>
            </div>
        </div>

        <!-- Kontrol Paneli -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-sliders-h me-2"></i> Analiz Seçenekleri
                        </div>
                        <button id="runAnalysisButton" class="btn btn-primary btn-sm">
                            <i class="fas fa-sync-alt me-1"></i> Analizi Çalıştır
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="forecastDays" class="form-label">Tahmin Süresi (Gün)</label>
                                <select class="form-select" id="forecastDays">
                                    <option value="7">7 Gün</option>
                                    <option value="15">15 Gün</option>
                                    <option value="30" selected>30 Gün</option>
                                    <option value="60">60 Gün</option>
                                    <option value="90">90 Gün</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="topProducts" class="form-label">Gösterilecek Ürün Sayısı</label>
                                <select class="form-select" id="topProducts">
                                    <option value="10">10 Ürün</option>
                                    <option value="20" selected>20 Ürün</option>
                                    <option value="50">50 Ürün</option>
                                    <option value="100">100 Ürün</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="includeVariants" class="form-label">Gösterim Modu</label>
                                <select class="form-select" id="includeVariants">
                                    <option value="false" selected>Model/Renk Bazlı</option>
                                    <option value="true">Tüm Varyantlar</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="sortBy" class="form-label">Sıralama</label>
                                <select class="form-select" id="sortBy">
                                    <option value="urgency" selected>Aciliyet Durumu</option>
                                    <option value="stock">Stok Miktarı</option>
                                    <option value="sales">Satış Hızı</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Analiz Butonları -->
                        <div class="row mt-4">
                            <div class="col-12 text-center">
                                <button id="runAnalysisButton" class="btn btn-primary btn-lg me-2">
                                    <i class="fas fa-brain me-2"></i> Analizi Başlat
                                </button>
                                <button id="saveAnalysisButton" class="btn btn-success btn-lg" style="display:none;">
                                    <i class="fas fa-save me-2"></i> Analizi Kaydet
                                </button>
                                <a href="{{ url_for('stock_intelligence.analysis_history') }}" class="btn btn-outline-secondary btn-lg">
                                    <i class="fas fa-history me-2"></i> Geçmiş Analizler
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Yükleniyor Göstergesi -->
        <div id="loadingIndicator" class="loading-container" style="display:none;">
            <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Yükleniyor...</span>
            </div>
            <h5 class="text-muted">Yapay Zeka Analizi Çalışıyor</h5>
            <p class="text-muted">Satış verileri işleniyor, tahminler yapılıyor ve öneriler hazırlanıyor...</p>
        </div>

        <!-- Genel Bakış Kartları -->
        <div id="overviewCards" class="row mb-4" style="display:none;">
            <div class="col-md-3 mb-3">
                <div class="card overview-card">
                    <div class="overview-card-content">
                        <i class="fas fa-exclamation-triangle overview-card-icon text-danger mb-2"></i>
                        <span class="overview-card-title">Kritik Stok Sayısı</span>
                        <span id="criticalCount" class="overview-card-value text-danger">0</span>
                        <span class="overview-card-trend">
                            <i id="criticalTrendIcon" class="fas fa-arrow-up trend-up"></i>
                            <span id="criticalTrendValue">0%</span>
                        </span>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card overview-card">
                    <div class="overview-card-content">
                        <i class="fas fa-exclamation overview-card-icon text-warning mb-2"></i>
                        <span class="overview-card-title">Uyarı Stok Sayısı</span>
                        <span id="warningCount" class="overview-card-value text-warning">0</span>
                        <span class="overview-card-trend">
                            <i id="warningTrendIcon" class="fas fa-arrow-down trend-down"></i>
                            <span id="warningTrendValue">0%</span>
                        </span>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card overview-card">
                    <div class="overview-card-content">
                        <i class="fas fa-check-circle overview-card-icon text-success mb-2"></i>
                        <span class="overview-card-title">Sağlıklı Stok Sayısı</span>
                        <span id="healthyCount" class="overview-card-value text-success">0</span>
                        <span class="overview-card-trend">
                            <i id="healthyTrendIcon" class="fas fa-arrow-up trend-up"></i>
                            <span id="healthyTrendValue">0%</span>
                        </span>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card overview-card">
                    <div class="overview-card-content">
                        <i class="fas fa-cubes overview-card-icon text-primary mb-2"></i>
                        <span class="overview-card-title">Toplam Üretim Önerisi</span>
                        <span id="totalProductionNeeded" class="overview-card-value text-primary">0</span>
                        <span class="overview-card-trend">
                            <span>Çift Ayakkabı</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Acil Önlem Gerektiren Ürünler -->
        <div id="urgentActionsSection" class="row mb-4" style="display:none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-fire-alt me-2"></i> Acil Önlem Gerektiren Ürünler
                    </div>
                    <div class="card-body">
                        <div id="urgentActionsList" class="row">
                            <!-- JS ile doldurulacak -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Model Bazlı Stok Analizi -->
        <div id="modelAnalysisSection" class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-sitemap me-2"></i> Model Bazlı Stok Analizi
                        </div>
                        <button id="runModelAnalysisButton" class="btn btn-primary btn-sm">
                            <i class="fas fa-sync-alt me-1"></i> Model Analizi Yap
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label for="modelAnalysisDays" class="form-label">Analiz Süresi (Gün)</label>
                                <select class="form-select" id="modelAnalysisDays">
                                    <option value="7" selected>Son 7 Gün</option>
                                    <option value="15">Son 15 Gün</option>
                                    <option value="30">Son 30 Gün</option>
                                    <option value="60">Son 60 Gün</option>
                                    <option value="90">Son 90 Gün</option>
                                </select>
                            </div>
                            <div class="col-md-8">
                                <label for="modelCodeSelect" class="form-label">Model Kodu Seçin</label>
                                <select class="form-select" id="modelCodeSelect">
                                    <option value="">Tüm Modeller</option>
                                    <!-- Model kodları AJAX ile yüklenecek -->
                                </select>
                            </div>
                        </div>
                        
                        <!-- Model Analiz Sonuçları -->
                        <div id="modelAnalysisResults" style="display:none;">
                            <div class="accordion" id="modelAccordion">
                                <!-- Model sonuçları dinamik olarak eklenecek -->
                            </div>
                        </div>
                        
                        <!-- Model Analiz Yükleniyor -->
                        <div id="modelAnalysisLoading" class="loading-container" style="display:none;">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Yükleniyor...</span>
                            </div>
                            <h5 class="text-muted">Model Analizi Yapılıyor</h5>
                            <p class="text-muted">Varyant satış verileri hesaplanıyor, stok durumları analiz ediliyor...</p>
                        </div>
                        
                        <!-- Model Analiz Boş Durumu -->
                        <div id="modelAnalysisEmpty" class="text-center py-5">
                            <i class="fas fa-chart-bar text-muted" style="font-size: 3rem;"></i>
                            <h5 class="mt-3 text-muted">Model Analizi Yapılmadı</h5>
                            <p class="text-muted">Model bazlı stok ve üretim analizi için yukarıdaki parametreleri ayarlayıp "Model Analizi Yap" butonuna tıklayın.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stok Analiz Tablosu -->
        <div id="stockAnalysisSection" class="row" style="display:none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-table me-2"></i> Detaylı Stok Analizi
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="stockAnalysisTable" class="table table-striped table-bordered" style="width:100%">
                                <thead>
                                    <tr>
                                        <th>Barkod</th>
                                        <th>Model Kodu</th>
                                        <th>Renk</th>
                                        <th>Beden</th>
                                        <th>Mevcut Stok</th>
                                        <th>Stok Durumu</th>
                                        <th>Tahmini Tükeniş</th>
                                        <th>Tavsiye</th>
                                        <th>İşlemler</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- JS ile doldurulacak -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ürün Detay Modalı -->
        <div class="modal fade" id="productDetailModal" tabindex="-1" aria-labelledby="productDetailModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="productDetailModalLabel">Ürün Detayı</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                    </div>
                    <div class="modal-body">
                        <div id="productDetailLoader" class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Yükleniyor...</span>
                            </div>
                            <p class="mt-2">Ürün analizleri yükleniyor...</p>
                        </div>
                        
                        <div id="productDetailContent" style="display:none;">
                            <div class="product-detail-header">
                                <div class="product-image-container me-3">
                                    <img id="productDetailImage" src="" alt="Ürün Görseli" class="product-image">
                                </div>
                                <div class="product-detail-info">
                                    <h4 id="productDetailTitle"></h4>
                                    <div class="mb-3">
                                        <span id="productDetailModelCode" class="badge bg-secondary me-2"></span>
                                        <span id="productDetailColor" class="badge bg-info me-2"></span>
                                        <span id="productDetailSize" class="badge bg-dark"></span>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="card mb-3">
                                                <div class="card-body p-3">
                                                    <h6 class="card-title">Mevcut Stok</h6>
                                                    <h3 id="productDetailStock" class="mb-0 text-primary"></h3>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card mb-3">
                                                <div class="card-body p-3">
                                                    <h6 class="card-title">Günlük Ortalama Satış</h6>
                                                    <h3 id="productDetailDailySales" class="mb-0 text-info"></h3>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card mb-3">
                                                <div class="card-body p-3">
                                                    <h6 class="card-title">Tahmini Tükenme Süresi</h6>
                                                    <h3 id="productDetailStockoutDays" class="mb-0 text-warning"></h3>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="recommendation-box">
                                <h5 class="recommendation-title">Yapay Zeka Analizi ve Öneriler</h5>
                                <div id="productDetailAnalysis"></div>
                            </div>
                            
                            <ul class="nav nav-tabs" id="productDetailTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="forecast-tab" data-bs-toggle="tab" data-bs-target="#forecast" type="button" role="tab" aria-controls="forecast" aria-selected="true">Satış Tahmini</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="components-tab" data-bs-toggle="tab" data-bs-target="#components" type="button" role="tab" aria-controls="components" aria-selected="false">Tahmin Bileşenleri</button>
                                </li>
                            </ul>
                            <div class="tab-content" id="productDetailTabContent">
                                <div class="tab-pane fade show active" id="forecast" role="tabpanel" aria-labelledby="forecast-tab">
                                    <div id="forecastChartContainer" class="chart-container mt-3"></div>
                                </div>
                                <div class="tab-pane fade" id="components" role="tabpanel" aria-labelledby="components-tab">
                                    <div id="componentsChartContainer" class="chart-container mt-3"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-light py-4 mt-5">
        <div class="container">
            <div class="text-center">
                <p class="mb-0">© 2025 Güllü Shoes. Tüm hakları saklıdır.</p>
                <p class="text-muted small">Yapay Zeka Destekli Stok Yönetimi Sistemi</p>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/tr.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script>
        // Global değişkenler
        let stockAnalysisTable;
        let stockAnalysisData = [];
        let modelsList = [];
        let selectedModelData = null;
        let currentModelAnalysis = null;
        
        // Sayfa yüklendiğinde
        $(document).ready(function() {
            // Analizi çalıştır butonu
            $('#runAnalysisButton').click(runStockAnalysis);
            
            // Model Analizi çalıştır butonu
            $('#runModelAnalysisButton').click(runModelAnalysis);
            
            // Modal kapatıldığında grafikleri temizle
            $('#productDetailModal').on('hidden.bs.modal', function (e) {
                $('#forecastChartContainer').empty();
                $('#componentsChartContainer').empty();
            });
            
            // Artık ilk yüklemede analiz çalıştırmıyoruz - manuel başlatılacak
            // runStockAnalysis();
            
            // Model listesini yükle
            loadModelsList();
            
            // Model seçildiğinde varyantları göster
            $('#modelCodeSelect').change(function() {
                const selectedModelCode = $(this).val();
                if (selectedModelCode) {
                    runModelAnalysis();
                }
            });
            
            // Analiz başlatma düğmesi
            $('#runAnalysisButton').click(function() {
                runStockAnalysis();
            });
            
            // Analizi kaydetme düğmesi
            $('#saveAnalysisButton').click(function() {
                saveAnalysisToDatabase();
            });
            
            // Detay butonlarını dinle (tablo doldurulduktan sonra)
            $(document).on('click', '.viewDetailBtn', function() {
                const productId = $(this).data('product-id');
                const color = $(this).data('product-color');
                const size = $(this).data('product-size');
                showProductDetail(productId, color, size);
            });
        });
        
        // Plotly grafik oluşturma yardımcı fonksiyonu
        function renderPlotlyFromJSON(containerSelector, plotJSON) {
            try {
                // Önce seçici içindeki # işaretini kaldıralım
                const containerId = containerSelector.replace('#', '');
                const containerElement = document.getElementById(containerId);
                
                if (!containerElement) {
                    console.error(`${containerSelector} ID'li element bulunamadı`);
                    return;
                }
                
                const figure = JSON.parse(plotJSON);
                Plotly.newPlot(containerId, figure.data, figure.layout, {responsive: true});
            } catch (error) {
                console.error("Grafik oluşturma hatası:", error);
                $(containerSelector).html('<div class="alert alert-danger">Grafik yüklenemedi</div>');
            }
        }
        
        // Ana Fonksiyonlar
        async function runStockAnalysis() {
            $('#loadingIndicator').show();
            $('#overviewCards, #urgentActionsSection, #stockAnalysisSection').hide();
            $('#saveAnalysisButton').hide();
            
            try {
                const report = await getStockHealthReport();
                
                if (report.length === 0) {
                    toastr.warning('Analiz için ürün bulunamadı veya analiz sonucunda kriterlere uygun ürün yok.');
                    $('#loadingIndicator').hide();
                    return;
                }
                
                // Analiz verilerini global değişkende sakla (kaydetmek için)
                window.lastAnalysisResults = report;
                
                // Kaydetme düğmesini göster
                $('#saveAnalysisButton').show();
                
                stockAnalysisData = report;
                updateOverviewCards(report);
                populateUrgentActions(report);
                initStockTable(report);
                
                toastr.success('Stok analizi başarıyla tamamlandı.');
            } catch (error) {
                console.error('Stok analizi tamamlanamadı:', error);
                toastr.error('Stok analizi tamamlanamadı: ' + error.message);
            }
            
            $('#loadingIndicator').hide();
        }
        
        // API İstekleri
        async function getStockHealthReport() {
            const forecastDays = $('#forecastDays').val();
            const topProducts = $('#topProducts').val();
            const includeVariants = $('#includeVariants').val();
            
            const response = await fetch(`/stock_intelligence/api/stock-health-report?days_forecast=${forecastDays}&top_n=${topProducts}&include_variants=${includeVariants}`);
            
            if (!response.ok) {
                throw new Error('Stok raporu alınamadı');
            }
            
            return await response.json();
        }
        
        // Analizi veritabanına kaydet
        async function saveAnalysisToDatabase() {
            if (!window.lastAnalysisResults) {
                toastr.error("Kaydedilecek analiz sonucu bulunamadı. Lütfen önce analizi çalıştırın.");
                return;
            }
            
            // Analiz adını sor
            const analysisName = prompt("Analiz için bir isim girin:", `Stok Analizi ${new Date().toLocaleDateString('tr-TR')}`);
            
            if (!analysisName) return; // İptal edildi
            
            try {
                // Kaydetme parametrelerini hazırla
                const params = new URLSearchParams({
                    top_n: $('#topProducts').val(),
                    days_forecast: $('#forecastDays').val(),
                    include_variants: $('#includeVariants').val(),
                    save_analysis: 'true',
                    analysis_name: analysisName
                });
                
                // Analizi kaydetme isteği gönder
                const response = await fetch(`/stock_intelligence/api/stock-health-report?${params.toString()}`);
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                toastr.success("Analiz başarıyla kaydedildi.");
                
                // 2 saniye sonra geçmiş analizler sayfasına yönlendir
                setTimeout(() => {
                    window.location.href = '/stock_intelligence/analysis-history';
                }, 2000);
                
            } catch (error) {
                console.error('Analiz kaydetme hatası:', error);
                toastr.error(`Analiz kaydedilirken bir hata oluştu: ${error.message}`);
            }
        }
        
        // UI Güncelleme Fonksiyonları
        function updateOverviewCards(report) {
            // Stok durumu sayılarını hesapla
            let criticalCount = 0;
            let warningCount = 0;
            let healthyCount = 0;
            let totalProductionNeeded = 0;
            
            report.forEach(item => {
                if (!item.analysis.success) return;
                
                const stockStatus = item.analysis.stock_analysis.stock_status;
                const productionAmount = item.analysis.recommendations.production_amount || 0;
                
                if (stockStatus === 'critical') {
                    criticalCount++;
                } else if (stockStatus === 'warning') {
                    warningCount++;
                } else {
                    healthyCount++;
                }
                
                totalProductionNeeded += productionAmount;
            });
            
            // Kartları güncelle
            $('#criticalCount').text(criticalCount);
            $('#warningCount').text(warningCount);
            $('#healthyCount').text(healthyCount);
            $('#totalProductionNeeded').text(totalProductionNeeded);
            
            // Trend göstergelerini rastgele belirle (normalde önceki verilerle karşılaştırılır)
            updateTrendIndicator('critical', criticalCount > 0);
            updateTrendIndicator('warning', warningCount > 0);
            updateTrendIndicator('healthy', healthyCount > 0);
            
            // Kartları göster
            $('#overviewCards').show();
        }
        
        function updateTrendIndicator(type, isUp) {
            const iconElement = $(`#${type}TrendIcon`);
            const valueElement = $(`#${type}TrendValue`);
            
            // Rastgele bir değişim yüzdesi (gerçek sistemde önceki verilerle hesaplanır)
            const changePercent = Math.floor(Math.random() * 20 + 5);
            
            if (isUp) {
                iconElement.removeClass('fa-arrow-down trend-down').addClass('fa-arrow-up trend-up');
                valueElement.text(`${changePercent}% artış`);
                valueElement.removeClass('text-danger').addClass('text-success');
            } else {
                iconElement.removeClass('fa-arrow-up trend-up').addClass('fa-arrow-down trend-down');
                valueElement.text(`${changePercent}% azalış`);
                valueElement.removeClass('text-success').addClass('text-danger');
            }
        }
        
        function populateUrgentActions(report) {
            const urgentList = $('#urgentActionsList');
            urgentList.empty();
            
            // Kritik durumda olan ürünleri filtrele
            const criticalItems = report.filter(item => 
                item.analysis.success && item.analysis.stock_analysis.stock_status === 'critical'
            );
            
            if (criticalItems.length === 0) {
                urgentList.html('<div class="col-12 text-center p-4"><p class="text-muted">Şu anda acil önlem gerektiren ürün bulunmuyor.</p></div>');
                $('#urgentActionsSection').show();
                return;
            }
            
            // En fazla 6 kritik ürün göster
            const itemsToShow = criticalItems.slice(0, 6);
            
            itemsToShow.forEach(item => {
                const product = item.product;
                const analysis = item.analysis;
                
                // Stok durumu bilgisi
                const stockOutDays = analysis.stock_analysis.stock_remaining_days;
                let daysUntilStockout = "Bilinmiyor";
                
                if (stockOutDays !== 'belirsiz' && stockOutDays !== 'tükenmeyecek') {
                    daysUntilStockout = Math.round(parseFloat(stockOutDays));
                }
                
                // Ürün kartı oluştur
                const card = $(`
                    <div class="col-md-4 mb-3">
                        <div class="card card-stock-status">
                            <div class="status-indicator status-critical"></div>
                            <div class="card-inner-content">
                                <div class="stock-card-header">
                                    <div class="product-image-container">
                                        <img src="https://placehold.co/80x80" alt="${product.title}" class="product-image">
                                    </div>
                                    <div>
                                        <h5 class="stock-card-title">${product.title}</h5>
                                        <div class="stock-card-subtitle">${product.product_main_id} - ${product.color} ${product.size ? '- ' + product.size : ''}</div>
                                    </div>
                                </div>
                                <div class="stock-info">
                                    <div class="stock-metric">
                                        <div class="stock-metric-label">Mevcut Stok:</div>
                                        <div class="stock-metric-value">${product.quantity} adet</div>
                                    </div>
                                    <div class="stock-metric">
                                        <div class="stock-metric-label">Tahmini Tükeniş:</div>
                                        <div class="stock-metric-value">
                                            <span class="days-badge bg-danger text-white">${daysUntilStockout} gün</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="alert alert-danger mt-2">
                                    <i class="fas fa-exclamation-circle"></i> ${analysis.recommendations.action_needed}
                                </div>
                                <button class="btn btn-sm btn-primary viewDetailBtn" 
                                    data-product-id="${product.product_main_id}"
                                    data-product-color="${product.color}"
                                    data-product-size="${product.size || ''}">
                                    <i class="fas fa-chart-line"></i> Detayları Gör
                                </button>
                            </div>
                        </div>
                    </div>
                `);
                
                urgentList.append(card);
            });
            
            $('#urgentActionsSection').show();
        }
        
        function initStockTable(report) {
            if (stockAnalysisTable) {
                stockAnalysisTable.destroy();
            }
            
            const tableBody = $('#stockAnalysisTable tbody');
            tableBody.empty();
            
            report.forEach(item => {
                const product = item.product;
                const analysis = item.analysis;
                
                // Analiz sonuçlarında hata varsa atla
                if (!analysis.success) {
                    return;
                }
                
                const stockStatus = analysis.stock_analysis.stock_status;
                const stockOutDays = analysis.stock_analysis.stock_remaining_days;
                const actionNeeded = analysis.recommendations.action_needed;
                
                // Stok durumu renkleri ve metinleri
                let stockStatusText, stockStatusClass;
                if (stockStatus === 'critical') {
                    stockStatusText = "Kritik";
                    stockStatusClass = "bg-danger text-white";
                } else if (stockStatus === 'warning') {
                    stockStatusText = "Uyarı";
                    stockStatusClass = "bg-warning";
                } else {
                    stockStatusText = "Sağlıklı";
                    stockStatusClass = "bg-success text-white";
                }
                
                // Tahmini tükenme süresi
                let daysUntilStockout = "Bilinmiyor";
                if (stockOutDays !== 'belirsiz' && stockOutDays !== 'tükenmeyecek') {
                    daysUntilStockout = Math.round(parseFloat(stockOutDays));
                } else if (stockOutDays === 'tükenmeyecek') {
                    daysUntilStockout = "Tükenmeyecek";
                }
                
                // Aksiyon öneri rengi
                let actionClass = "bg-secondary";
                if (actionNeeded.includes("üret") || actionNeeded.includes("sipariş")) {
                    actionClass = "bg-danger";
                } else if (actionNeeded.includes("planla") || actionNeeded.includes("hazırlan")) {
                    actionClass = "bg-warning";
                } else if (actionNeeded.includes("izle") || actionNeeded.includes("takip")) {
                    actionClass = "bg-info";
                }
                
                // Satır oluştur
                const row = $(`<tr>
                    <td>${product.barcode || '-'}</td>
                    <td>${product.product_main_id}</td>
                    <td>${product.color}</td>
                    <td>${product.size || '-'}</td>
                    <td>${product.quantity}</td>
                    <td><span class="badge ${stockStatusClass}">${stockStatusText}</span></td>
                    <td>${daysUntilStockout} gün</td>
                    <td><span class="badge ${actionClass}">${actionNeeded}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary viewDetailBtn" 
                            data-product-id="${product.product_main_id}"
                            data-product-color="${product.color}"
                            data-product-size="${product.size || ''}">
                            <i class="fas fa-chart-line"></i> Detay
                        </button>
                    </td>
                </tr>`);
                
                tableBody.append(row);
            });
            
            stockAnalysisTable = $('#stockAnalysisTable').DataTable({
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Turkish.json"
                },
                "pageLength": 10,
                "ordering": true,
                "responsive": true
            });
            
            $('#stockAnalysisSection').show();
        }
        
        async function showProductDetail(productId, color, size) {
            $('#productDetailModal').modal('show');
            $('#productDetailLoader').show();
            $('#productDetailContent').hide();
            
            try {
                // Ürün analiz verilerini al
                const url = `/stock_intelligence/api/product-stock-analysis/${productId}?color=${encodeURIComponent(color)}${size ? `&size=${encodeURIComponent(size)}` : ''}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Ürün detayları alınamadı');
                }
                
                // Ürün bilgilerini doldur
                const product = data.product;
                const forecast = data.forecast;
                const analysis = data.analysis;
                
                $('#productDetailTitle').text(product.title);
                $('#productDetailModelCode').text(`Model: ${product.product_main_id}`);
                $('#productDetailColor').text(`Renk: ${product.color}`);
                $('#productDetailSize').text(product.size ? `Beden: ${product.size}` : '');
                $('#productDetailStock').text(`${product.quantity} adet`);
                
                // Ürün görseli
                $('#productDetailImage').attr('src', 'https://placehold.co/80x80');
                
                // Satış bilgileri
                let dailySales = 0;
                let stockoutDays = 'Hesaplanamadı';
                
                if (forecast && forecast.success) {
                    const avgDailySales = forecast.average_daily_sales || 0;
                    dailySales = avgDailySales.toFixed(2);
                    
                    if (product.quantity > 0 && avgDailySales > 0) {
                        stockoutDays = Math.round(product.quantity / avgDailySales);
                        $('#productDetailStockoutDays').text(`${stockoutDays} gün`);
                        
                        if (stockoutDays <= 7) {
                            $('#productDetailStockoutDays').addClass('text-danger').removeClass('text-warning text-success');
                        } else if (stockoutDays <= 14) {
                            $('#productDetailStockoutDays').addClass('text-warning').removeClass('text-danger text-success');
                        } else {
                            $('#productDetailStockoutDays').addClass('text-success').removeClass('text-danger text-warning');
                        }
                    } else {
                        $('#productDetailStockoutDays').text('Tükenmeyecek');
                        $('#productDetailStockoutDays').addClass('text-success').removeClass('text-danger text-warning');
                    }
                } else {
                    $('#productDetailStockoutDays').text('Hesaplanamadı');
                    $('#productDetailStockoutDays').addClass('text-secondary').removeClass('text-danger text-warning text-success');
                }
                
                $('#productDetailDailySales').text(`${dailySales} adet/gün`);
                
                // AI Analizi
                if (analysis && analysis.success) {
                    $('#productDetailAnalysis').html(analysis.stock_analysis.full_analysis.replace(/\n/g, '<br>'));
                } else {
                    $('#productDetailAnalysis').html('<div class="alert alert-warning">Bu ürün için analiz yapılamadı.</div>');
                }
                
                // Grafikleri oluştur
                if (forecast && forecast.success) {
                    renderPlotlyFromJSON('#forecastChartContainer', forecast.forecast_plot);
                    renderPlotlyFromJSON('#componentsChartContainer', forecast.components_plot);
                } else {
                    $('#forecastChartContainer').html('<div class="alert alert-warning">Tahmin grafiği oluşturulamadı.</div>');
                    $('#componentsChartContainer').html('<div class="alert alert-warning">Bileşen grafiği oluşturulamadı.</div>');
                }
                
                // İçeriği göster
                $('#productDetailLoader').hide();
                $('#productDetailContent').show();
                
            } catch (error) {
                console.error('Ürün detayları alınırken hata:', error);
                $('#productDetailLoader').hide();
                $('#productDetailContent').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        ${error.message || 'Ürün detayları yüklenirken bir hata oluştu.'}
                    </div>
                `).show();
            }
        }
        
        // Model listesini yükle
        function loadModelsList() {
            $.ajax({
                url: "{{ url_for('stock_intelligence.get_models_list_api') }}",
                method: "GET",
                dataType: "json",
                beforeSend: function() {
                    $('#modelCodeSelect').prop('disabled', true);
                    $('#modelCodeSelect').html('<option value="">Yükleniyor...</option>');
                },
                success: function(response) {
                    $('#modelCodeSelect').empty();
                    $('#modelCodeSelect').append('<option value="">Model Kodu Seçin</option>');
                    
                    if (response && response.length > 0) {
                        modelsList = response;
                        
                        // Model kodlarını listele
                        response.forEach(function(model) {
                            $('#modelCodeSelect').append(`<option value="${model.product_main_id}">${model.product_main_id} - ${model.title} (${model.variants_count} varyant)</option>`);
                        });
                    } else {
                        $('#modelCodeSelect').append('<option value="" disabled>Model bulunamadı</option>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Model listesi yüklenirken hata oluştu:", error);
                    toastr.error("Model listesi yüklenirken bir hata oluştu. Lütfen sayfayı yenileyin.");
                    $('#modelCodeSelect').append('<option value="" disabled>Hata: Model listesi yüklenemedi</option>');
                },
                complete: function() {
                    $('#modelCodeSelect').prop('disabled', false);
                }
            });
        }
        
        // Model bazlı analizi çalıştır
        function runModelAnalysis() {
            const days = $('#modelAnalysisDays').val();
            const modelCode = $('#modelCodeSelect').val();
            
            // Model seçili değilse ve tüm modelleri analiz etmiyorsak uyarı göster
            if (!modelCode && !confirm('Tüm modeller için analiz yapılacak. Bu işlem uzun sürebilir. Devam etmek istiyor musunuz?')) {
                return;
            }
            
            // Yükleniyor göstergesi
            $('#modelAnalysisResults').hide();
            $('#modelAnalysisEmpty').hide();
            $('#modelAnalysisLoading').show();
            
            // API'den veri al
            $.ajax({
                url: "{{ url_for('stock_intelligence.get_model_variants_analysis_api') }}",
                method: "GET",
                data: {
                    product_main_id: modelCode,
                    days: days
                },
                dataType: "json",
                success: function(response) {
                    if (response && response.success) {
                        currentModelAnalysis = response;
                        displayModelAnalysisResults(response);
                    } else {
                        $('#modelAnalysisLoading').hide();
                        $('#modelAnalysisEmpty').show();
                        toastr.error("Model analizi yapılırken bir hata oluştu: " + (response.error || "Bilinmeyen hata"));
                    }
                },
                error: function(xhr, status, error) {
                    $('#modelAnalysisLoading').hide();
                    $('#modelAnalysisEmpty').show();
                    console.error("Model analizi yapılırken hata:", error);
                    toastr.error("Model analizi yapılırken bir hata oluştu. Lütfen tekrar deneyin.");
                }
            });
        }
        
        // Model analiz sonuçlarını göster
        function displayModelAnalysisResults(data) {
            const models = data.models;
            const daysAnalyzed = data.days_analyzed;
            
            // Sonuç alanını temizle
            $('#modelAccordion').empty();
            
            // Sonuç yoksa mesaj göster
            if (!models || Object.keys(models).length === 0) {
                $('#modelAnalysisLoading').hide();
                $('#modelAnalysisResults').hide();
                $('#modelAnalysisEmpty').show().html(`
                    <div class="text-center py-5">
                        <i class="fas fa-search text-muted" style="font-size: 3rem;"></i>
                        <h5 class="mt-3 text-muted">Sonuç Bulunamadı</h5>
                        <p class="text-muted">Seçilen model kodu için satış verisi bulunamadı veya hiç satış yapılmamış.</p>
                    </div>
                `);
                return;
            }
            
            // Her model için bir accordion öğesi oluştur
            let modelIndex = 0;
            for (const modelId in models) {
                const modelItems = models[modelId];
                
                if (modelItems.length === 0) continue;
                
                // Bu model için renkleri grupla
                const colorGroups = {};
                modelItems.forEach(item => {
                    if (!colorGroups[item.color]) {
                        colorGroups[item.color] = [];
                    }
                    colorGroups[item.color].push(item);
                });
                
                // Model adı ve barkodu al
                const firstItem = modelItems[0];
                const modelTitle = firstItem.product_title || "Ürün " + modelId;
                const modelBarcode = firstItem.barcode || "-";
                
                // Kritik ve uyarı sayılarını hesapla
                let criticalCount = 0;
                let warningCount = 0;
                let totalSales = 0;
                let totalStock = 0;
                let totalProduction = 0;
                
                modelItems.forEach(item => {
                    totalSales += item.total_sales;
                    totalStock += item.current_stock;
                    totalProduction += item.suggested_production;
                    
                    if (item.days_until_stockout !== "∞" && item.days_until_stockout <= 7) {
                        criticalCount++;
                    } else if (item.days_until_stockout !== "∞" && item.days_until_stockout <= 14) {
                        warningCount++;
                    }
                });
                
                // Status badge'i belirle
                let statusBadge = '';
                if (criticalCount > 0) {
                    statusBadge = '<span class="badge bg-danger ms-2">Kritik</span>';
                } else if (warningCount > 0) {
                    statusBadge = '<span class="badge bg-warning ms-2">Uyarı</span>';
                } else {
                    statusBadge = '<span class="badge bg-success ms-2">Sağlıklı</span>';
                }
                
                // Accordion item HTML'i
                const accordionItem = `
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="model-heading-${modelIndex}">
                            <button class="accordion-button ${modelIndex > 0 ? 'collapsed' : ''}" type="button" data-bs-toggle="collapse" data-bs-target="#model-collapse-${modelIndex}" aria-expanded="${modelIndex === 0 ? 'true' : 'false'}" aria-controls="model-collapse-${modelIndex}">
                                <strong>${modelId}</strong> - ${modelTitle} ${statusBadge}
                            </button>
                        </h2>
                        <div id="model-collapse-${modelIndex}" class="accordion-collapse collapse ${modelIndex === 0 ? 'show' : ''}" aria-labelledby="model-heading-${modelIndex}">
                            <div class="accordion-body">
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <div class="card bg-light">
                                            <div class="card-body text-center py-2">
                                                <div class="small text-muted">Barkod</div>
                                                <div class="fw-bold">${modelBarcode}</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-light">
                                            <div class="card-body text-center py-2">
                                                <div class="small text-muted">Toplam Satış (${daysAnalyzed} gün)</div>
                                                <div class="fw-bold">${totalSales} adet</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-light">
                                            <div class="card-body text-center py-2">
                                                <div class="small text-muted">Mevcut Stok</div>
                                                <div class="fw-bold">${totalStock} adet</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-light">
                                            <div class="card-body text-center py-2">
                                                <div class="small text-muted">Önerilen Üretim</div>
                                                <div class="fw-bold">${totalProduction} adet</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="model-colors mt-4">
                                    ${renderColorGroups(colorGroups, daysAnalyzed)}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                $('#modelAccordion').append(accordionItem);
                modelIndex++;
            }
            
            // Sonuçları göster
            $('#modelAnalysisLoading').hide();
            $('#modelAnalysisEmpty').hide();
            $('#modelAnalysisResults').show();
        }
        
        // Renk gruplarını render et
        function renderColorGroups(colorGroups, daysAnalyzed) {
            let html = '';
            
            for (const color in colorGroups) {
                const items = colorGroups[color];
                
                // Renk için toplam değerleri hesapla
                let colorTotalSales = 0;
                let colorTotalStock = 0;
                let colorTotalProduction = 0;
                
                items.forEach(item => {
                    colorTotalSales += item.total_sales;
                    colorTotalStock += item.current_stock;
                    colorTotalProduction += item.suggested_production;
                });
                
                html += `
                    <div class="color-group mb-4">
                        <h6 class="border-bottom pb-2">
                            <i class="fas fa-tint me-2"></i>${color}
                        </h6>
                        <div class="row mb-2">
                            <div class="col-md-4">
                                <span class="text-muted">Toplam Satış:</span> <strong>${colorTotalSales} adet</strong>
                            </div>
                            <div class="col-md-4">
                                <span class="text-muted">Toplam Stok:</span> <strong>${colorTotalStock} adet</strong>
                            </div>
                            <div class="col-md-4">
                                <span class="text-muted">Önerilen Üretim:</span> <strong>${colorTotalProduction} adet</strong>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-sm table-hover border">
                                <thead class="table-light">
                                    <tr>
                                        <th>Beden</th>
                                        <th class="text-center">Satış (${daysAnalyzed} gün)</th>
                                        <th class="text-center">Günlük Ort.</th>
                                        <th class="text-center">Mevcut Stok</th>
                                        <th class="text-center">Yeterlilik</th>
                                        <th class="text-center">Önerilen Üretim</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${renderSizeRows(items)}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            
            return html;
        }
        
        // Beden satırlarını render et
        function renderSizeRows(items) {
            // Bedenlere göre sırala
            items.sort((a, b) => {
                // Numerik bedenleri sayı olarak sırala
                const aSize = a.size || '';
                const bSize = b.size || '';
                
                if (!isNaN(aSize) && !isNaN(bSize)) {
                    return parseInt(aSize) - parseInt(bSize);
                }
                
                // Diğer durumlarda metinsel sırala
                return aSize.localeCompare(bSize);
            });
            
            let html = '';
            
            items.forEach(item => {
                // Yeterlilik için renk sınıfını belirle
                let daysClass = 'bg-success text-white';
                if (item.days_until_stockout !== "∞") {
                    if (item.days_until_stockout <= 7) {
                        daysClass = 'bg-danger text-white';
                    } else if (item.days_until_stockout <= 14) {
                        daysClass = 'bg-warning';
                    }
                }
                
                html += `
                    <tr>
                        <td><strong>${item.size || 'Tek Beden'}</strong></td>
                        <td class="text-center">${item.total_sales}</td>
                        <td class="text-center">${item.daily_avg_sales}</td>
                        <td class="text-center">${item.current_stock}</td>
                        <td class="text-center"><span class="badge ${daysClass}">${item.days_until_stockout} gün</span></td>
                        <td class="text-center font-weight-bold">${item.suggested_production > 0 ? `<span class="badge bg-primary">${item.suggested_production}</span>` : '-'}</td>
                    </tr>
                `;
            });
            
            return html;
        }
    </script>
</body>
</html>