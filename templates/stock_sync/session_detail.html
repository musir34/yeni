{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="mb-1">
                <i class="bi bi-file-earmark-text me-2"></i>
                Senkronizasyon Detayı
            </h1>
            <p class="text-muted mb-0">Session ID: <code>{{ session.session_id }}</code></p>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('stock_sync.history') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Geçmişe Dön
            </a>
            <a href="{{ url_for('stock_sync.dashboard') }}" class="btn btn-outline-primary">
                <i class="bi bi-speedometer2"></i> Dashboard
            </a>
        </div>
    </div>

    <!-- Özet Kartları -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card h-100">
                <div class="card-body text-center">
                    <h6 class="text-muted">Platform</h6>
                    <h4 class="text-primary text-uppercase">{{ session.platform }}</h4>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card h-100">
                <div class="card-body text-center">
                    <h6 class="text-muted">Durum</h6>
                    {% if session.status == 'completed' %}
                        <span class="badge bg-success fs-5">Tamamlandı</span>
                    {% elif session.status == 'failed' %}
                        <span class="badge bg-danger fs-5">Hata</span>
                    {% else %}
                        <span class="badge bg-info fs-5">{{ session.status }}</span>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card h-100 bg-light">
                <div class="card-body text-center">
                    <h6 class="text-muted">Toplam</h6>
                    <h3>{{ session.total_products }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card h-100 bg-success text-white">
                <div class="card-body text-center">
                    <h6>Başarılı</h6>
                    <h3>{{ session.success_count }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card h-100 bg-danger text-white">
                <div class="card-body text-center">
                    <h6>Hata</h6>
                    <h3>{{ session.error_count }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card h-100">
                <div class="card-body text-center">
                    <h6 class="text-muted">Süre</h6>
                    <h3>{{ "%.1f"|format(session.duration_seconds) if session.duration_seconds else '-' }}s</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Bilgiler -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <i class="bi bi-info-circle me-2"></i>Genel Bilgiler
                </div>
                <div class="card-body">
                    <table class="table table-sm mb-0">
                        <tr>
                            <th width="40%">Session ID</th>
                            <td><code>{{ session.session_id }}</code></td>
                        </tr>
                        <tr>
                            <th>Başlangıç</th>
                            <td>{{ session.started_at or '-' }}</td>
                        </tr>
                        <tr>
                            <th>Bitiş</th>
                            <td>{{ session.completed_at or '-' }}</td>
                        </tr>
                        <tr>
                            <th>Tetikleyen</th>
                            <td><span class="badge bg-secondary">{{ session.triggered_by }}</span></td>
                        </tr>
                        <tr>
                            <th>Kullanıcı</th>
                            <td>{{ session.triggered_by_user or '-' }}</td>
                        </tr>
                        <tr>
                            <th>Başarı Oranı</th>
                            <td>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-success" style="width: {{ session.success_rate }}%">
                                        {{ session.success_rate }}%
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            {% if session.error_message %}
            <div class="card h-100 border-danger">
                <div class="card-header bg-danger text-white">
                    <i class="bi bi-exclamation-triangle me-2"></i>Hata Mesajı
                </div>
                <div class="card-body">
                    <pre class="mb-0 text-danger">{{ session.error_message }}</pre>
                </div>
            </div>
            {% else %}
            <div class="card h-100">
                <div class="card-header">
                    <i class="bi bi-graph-up me-2"></i>İstatistikler
                </div>
                <div class="card-body">
                    <canvas id="resultChart" height="150"></canvas>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Detaylar Tablosu -->
    {% if session.details %}
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-list-ul me-2"></i>Ürün Detayları ({{ session.details|length }})</span>
            <div class="d-flex align-items-center gap-2">
                <!-- Barkod Arama -->
                <div class="input-group input-group-sm" style="width: 250px;">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="barcodeSearch" placeholder="Barkod ara...">
                    <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-success" onclick="filterTable('success')">
                        <i class="bi bi-check"></i> Başarılı
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="filterTable('error')">
                        <i class="bi bi-x"></i> Hatalı
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="filterTable('all')">
                        Tümü
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                <table class="table table-sm table-hover mb-0" id="detailsTable">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th>#</th>
                            <th>Barkod</th>
                            <th>Gönderilen Stok</th>
                            <th>Rezerv</th>
                            <th>Durum</th>
                            <th>Gönderim Zamanı</th>
                            <th>Hata</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for detail in session.details %}
                        <tr data-status="{{ detail.status }}" data-barcode="{{ detail.barcode|lower }}">
                            <td>{{ loop.index }}</td>
                            <td><code>{{ detail.barcode }}</code></td>
                            <td>{{ detail.stock_sent }}</td>
                            <td>
                                {% if detail.reserved_qty and detail.reserved_qty > 0 %}
                                    <span class="badge bg-warning text-dark" title="Siparişte bekleyen">
                                        <i class="bi bi-lock-fill"></i> {{ detail.reserved_qty }}
                                    </span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if detail.status == 'success' %}
                                    <span class="badge bg-success">OK</span>
                                {% else %}
                                    <span class="badge bg-danger">HATA</span>
                                {% endif %}
                            </td>
                            <td>{{ detail.sent_at or '-' }}</td>
                            <td class="text-danger small">{{ detail.error_message or '-' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer text-muted small" id="searchResultInfo"></div>
    </div>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Pasta grafik
{% if not session.error_message %}
const ctx = document.getElementById('resultChart').getContext('2d');
new Chart(ctx, {
    type: 'doughnut',
    data: {
        labels: ['Başarılı', 'Hata', 'Atlanan'],
        datasets: [{
            data: [{{ session.success_count }}, {{ session.error_count }}, {{ session.skipped_count }}],
            backgroundColor: ['#198754', '#dc3545', '#6c757d']
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});
{% endif %}

// Tablo filtreleme
let currentStatusFilter = 'all';
let currentSearchTerm = '';

function filterTable(status) {
    currentStatusFilter = status;
    applyFilters();
}

function applyFilters() {
    const rows = document.querySelectorAll('#detailsTable tbody tr');
    let visibleCount = 0;
    let totalCount = rows.length;
    
    rows.forEach(row => {
        const statusMatch = currentStatusFilter === 'all' || row.dataset.status === currentStatusFilter;
        const searchMatch = !currentSearchTerm || row.dataset.barcode.includes(currentSearchTerm);
        
        if (statusMatch && searchMatch) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Sonuç bilgisi göster
    const infoEl = document.getElementById('searchResultInfo');
    if (currentSearchTerm || currentStatusFilter !== 'all') {
        infoEl.innerHTML = `<i class="bi bi-funnel me-1"></i>${visibleCount} / ${totalCount} kayıt gösteriliyor`;
    } else {
        infoEl.innerHTML = '';
    }
}

function clearSearch() {
    document.getElementById('barcodeSearch').value = '';
    currentSearchTerm = '';
    applyFilters();
}

// Barkod arama input event listener
document.getElementById('barcodeSearch')?.addEventListener('input', function(e) {
    currentSearchTerm = e.target.value.toLowerCase().trim();
    applyFilters();
});

// Enter tuşu ile arama
document.getElementById('barcodeSearch')?.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        applyFilters();
    }
});
</script>
{% endblock %}
