<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gelişmiş Ürün Etiketi - Güllü Shoes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .main-container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .section-card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 24px; margin-bottom: 24px; }
        .section-title { font-size: 1.4rem; font-weight: 600; color: #2c3e50; margin-bottom: 20px; border-bottom: 2px solid #3498db; padding-bottom: 8px; }
        .search-container { display: flex; gap: 12px; align-items: end; flex-wrap: wrap; }
        .form-field { flex: 1; min-width: 200px; }
        .btn-search { background: linear-gradient(135deg, #3498db, #2980b9); border: none; padding: 12px 24px; border-radius: 8px; color: white; font-weight: 500; transition: all 0.3s; }
        .btn-search:hover { background: linear-gradient(135deg, #2980b9, #21618c); transform: translateY(-1px); }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; margin-top: 20px; }
        .product-card { border: 2px solid #e1e8ed; border-radius: 12px; padding: 16px; background: #f8f9fa; transition: all 0.3s; }
        .product-card:hover { border-color: #3498db; box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2); }
        .product-header { background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 12px; border-radius: 8px; margin-bottom: 12px; text-align: center; font-weight: 600; }
        .variant-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; margin: 4px 0; background: white; border-radius: 6px; border: 1px solid #dee2e6; }
        .variant-info { flex: 1; }
        .variant-size { font-weight: 600; color: #2c3e50; }
        .variant-stock { font-size: 0.9em; color: #7f8c8d; }
        .btn-add-label { background: linear-gradient(135deg, #27ae60, #229954); border: none; padding: 6px 12px; border-radius: 6px; color: white; font-size: 0.9em; transition: all 0.3s; }
        .btn-add-label:hover { background: linear-gradient(135deg, #229954, #1e8449); transform: scale(1.05); }
        .label-queue { max-height: 400px; overflow-y: auto; }
        .label-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; margin: 8px 0; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #3498db; }
        .label-info { flex: 1; }
        .label-model { font-weight: 600; color: #2c3e50; }
        .label-details { font-size: 0.9em; color: #7f8c8d; }
        .quantity-control { display: flex; align-items: center; gap: 8px; margin: 0 12px; }
        .quantity-btn { width: 32px; height: 32px; border: none; border-radius: 6px; background: #ecf0f1; color: #2c3e50; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .quantity-btn:hover { background: #bdc3c7; }
        .quantity-input { width: 60px; text-align: center; border: 1px solid #bdc3c7; border-radius: 4px; padding: 4px; }
        .btn-remove { background: #e74c3c; border: none; padding: 6px 10px; border-radius: 6px; color: white; font-size: 0.9em; transition: all 0.3s; }
        .btn-remove:hover { background: #c0392b; }
        .size-settings { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin: 20px 0; }
        .preset-sizes { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
        .size-preset { padding: 8px 16px; background: #ecf0f1; border: none; border-radius: 20px; font-size: 0.9em; cursor: pointer; transition: all 0.3s; }
        .size-preset:hover { background: #3498db; color: white; }
        .preview-area { border: 2px dashed #bdc3c7; border-radius: 12px; padding: 40px; text-align: center; min-height: 200px; display: flex; align-items: center; justify-content: center; background: #fafafa; }
        .preview-image { max-width: 100%; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .action-buttons { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; margin-top: 20px; }
        .btn-primary-action { background: linear-gradient(135deg, #e74c3c, #c0392b); border: none; padding: 12px 32px; border-radius: 8px; color: white; font-weight: 600; font-size: 1.1em; transition: all 0.3s; }
        .btn-primary-action:hover { background: linear-gradient(135deg, #c0392b, #a93226); transform: translateY(-2px); }
        .btn-secondary-action { background: linear-gradient(135deg, #95a5a6, #7f8c8d); border: none; padding: 12px 32px; border-radius: 8px; color: white; font-weight: 600; transition: all 0.3s; }
        .btn-secondary-action:hover { background: linear-gradient(135deg, #7f8c8d, #6c7b7d); }
        .loading { display: none; text-align: center; padding: 20px; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 12px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .alert { border-radius: 8px; border: none; padding: 16px; margin: 16px 0; }
        .alert-success { background: linear-gradient(135deg, #d5f4e6, #c3e9d0); color: #155724; }
        .alert-danger { background: linear-gradient(135deg, #f8d7da, #f1b0b7); color: #721c24; }
        .page-header { background: linear-gradient(135deg, #2c3e50, #34495e); color: white; padding: 24px; border-radius: 12px; margin-bottom: 24px; text-align: center; }
        .page-title { font-size: 2rem; font-weight: 700; margin: 0; }
        .page-subtitle { font-size: 1.1rem; opacity: 0.9; margin-top: 8px; }
    </style>
</head>
<body style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh;">
    <div class="main-container">
        <div class="page-header">
            <h1 class="page-title"><i class="fas fa-tags"></i> Gelişmiş Ürün Etiketi</h1>
            <p class="page-subtitle">QR kodlu, logolu ve özelleştirilebilir ürün etiketleri</p>
        </div>

        <div class="section-card">
            <h2 class="section-title"><i class="fas fa-search"></i> Ürün Ara</h2>
            <div class="search-container">
                <div class="form-field">
                    <label class="form-label">Arama Tipi</label>
                    <select id="searchType" class="form-select">
                        <option value="model">Model Kodu</option>
                        <option value="barcode">Barkod</option>
                    </select>
                </div>
                <div class="form-field">
                    <label class="form-label">Arama Sorgusu</label>
                    <input type="text" id="searchQuery" class="form-control" placeholder="Model kodu veya barkod girin...">
                </div>
                <button id="searchBtn" class="btn btn-search"><i class="fas fa-search"></i> Ara</button>
            </div>
            <div id="searchResults" class="product-grid"></div>
        </div>

        <div class="section-card">
            <h2 class="section-title"><i class="fas fa-list"></i> Yazdırılacak Etiketler <span id="labelCount" class="badge bg-primary ms-2">0</span></h2>
            <div id="labelQueue" class="label-queue">
                <div class="text-center text-muted py-4">
                    <i class="fas fa-inbox fa-3x mb-3 opacity-50"></i>
                    <p>Henüz etiket eklenmedi</p>
                </div>
            </div>
        </div>

        <div class="section-card">
            <h2 class="section-title"><i class="fas fa-cog"></i> Etiket Ayarları</h2>
            <div class="size-settings">
                <div>
                    <label class="form-label">Etiket Genişliği (mm)</label>
                    <input type="number" id="labelWidth" class="form-control" value="100" min="50" max="200">
                </div>
                <div>
                    <label class="form-label">Etiket Yüksekliği (mm)</label>
                    <input type="number" id="labelHeight" class="form-control" value="50" min="30" max="150">
                </div>
            </div>
            <div class="preset-sizes">
                <strong>Hızlı Boyutlar:</strong>
                <button class="size-preset" data-width="100" data-height="50">100x50mm</button>
                <button class="size-preset" data-width="80" data-height="50">80x50mm</button>
                <button class="size-preset" data-width="80" data-height="40">80x40mm</button>
                <button class="size-preset" data-width="60" data-height="40">60x40mm</button>
                <button class="size-preset" data-width="120" data-height="60">120x60mm</button>
            </div>
            <!-- Manuel Detay Ayarları -->
            <div class="mt-4 text-center">
                <button class="btn btn-outline-primary btn-lg" type="button" data-bs-toggle="collapse" data-bs-target="#detailSettings" aria-expanded="false" aria-controls="detailSettings">
                    <i class="fas fa-sliders-h me-2"></i> Detaylı Ayarlar
                </button>
            </div>
            
            <div class="collapse mt-4 p-3 border rounded" id="detailSettings" style="background-color: #f8f9fa;">
                <div class="row">
                    <!-- Başlık Ayarları -->
                    <div class="col-md-6">
                        <h5 class="mb-3"><i class="fas fa-heading"></i> Başlık Ayarları</h5>
                        <div class="mb-3">
                            <label class="form-label">Başlık Metni</label>
                            <input type="text" id="titleText" class="form-control" value="GÜLLÜ">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Font Boyutu</label>
                            <input type="number" id="titleFontSize" class="form-control" value="24" min="12" max="48">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Y Pozisyonu</label>
                            <input type="number" id="titlePositionY" class="form-control" value="10" min="0" max="100">
                        </div>
                    </div>
                    
                    <!-- Görsel Ayarları -->
                    <div class="col-md-6">
                        <h5 class="mb-3"><i class="fas fa-image"></i> Görsel Ayarları</h5>
                        <div class="mb-3">
                            <label class="form-label">Boyut (px)</label>
                            <input type="number" id="imageSize" class="form-control" value="80" min="30" max="200">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">X Pozisyonu</label>
                            <input type="number" id="imagePositionX" class="form-control" value="10" min="0" max="300">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Y Pozisyonu</label>
                            <input type="number" id="imagePositionY" class="form-control" value="50" min="0" max="200">
                        </div>
                    </div>
                    
                    <!-- QR Kod Ayarları -->
                    <div class="col-md-6">
                        <h5 class="mb-3"><i class="fas fa-qrcode"></i> QR Kod Ayarları</h5>
                        <div class="mb-3">
                            <label class="form-label">Boyut (px)</label>
                            <input type="number" id="qrSize" class="form-control" value="80" min="40" max="150">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">X Pozisyonu</label>
                            <select id="qrPositionX" class="form-control">
                                <option value="right">Sağ</option>
                                <option value="center">Orta</option>
                                <option value="left">Sol</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Y Pozisyonu</label>
                            <input type="number" id="qrPositionY" class="form-control" value="50" min="0" max="200">
                        </div>
                    </div>
                    
                    <!-- Font Ayarları -->
                    <div class="col-md-6">
                        <h5 class="mb-3"><i class="fas fa-font"></i> Font Ayarları</h5>
                        <div class="mb-3">
                            <label class="form-label">Bilgi Font Boyutu</label>
                            <input type="number" id="infoFontSize" class="form-control" value="18" min="10" max="30">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Küçük Font Boyutu</label>
                            <input type="number" id="smallFontSize" class="form-control" value="14" min="8" max="24">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-md-6">
                    <label class="form-label">Sayfa Başına Etiket (Satır)</label>
                    <input type="number" id="labelsPerRow" class="form-control" value="3" min="1" max="6">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Sayfa Başına Etiket (Sütun)</label>
                    <input type="number" id="labelsPerCol" class="form-control" value="7" min="1" max="12">
                </div>
            </div>
        </div>

        <div class="section-card">
            <h2 class="section-title"><i class="fas fa-eye"></i> Etiket Önizlemesi</h2>
            <div id="previewArea" class="preview-area">
                <div class="text-muted">
                    <i class="fas fa-image fa-3x mb-3 opacity-50"></i>
                    <p>Önizleme için etiket ekleyin ve "Önizleme Oluştur" butonuna tıklayın</p>
                </div>
            </div>
            <div class="action-buttons">
                <a href="/enhanced_product_label/advanced_editor" class="btn btn-warning"><i class="fas fa-magic"></i> Gelişmiş Editör</a>
                <button id="previewBtn" class="btn btn-secondary-action"><i class="fas fa-eye"></i> Önizleme Oluştur</button>
                <button id="printBtn" class="btn btn-primary-action"><i class="fas fa-print"></i> Yazdır</button>
                <button type="button" class="btn btn-info" onclick="showSavedDesigns()">
                    <i class="fas fa-list"></i> Kaydedilen Tasarımlar
                </button>
            </div>
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>İşlem devam ediyor...</p>
            </div>
        </div>
    </div>

    <!-- Saved Designs Modal -->
    <div class="modal fade" id="savedDesignsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Kaydedilen Tasarımlar</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="savedDesignsList"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let labelQueue = [];
        let selectedDesignForPrint = null;
        
        // Update selected design info display
        function updateSelectedDesignInfo(design) {
            const infoDiv = document.getElementById('selectedDesignInfo');
            if (infoDiv) {
                if (design) {
                    infoDiv.innerHTML = `<strong>${design.name}</strong><br><small class="text-muted">${design.elements.length} element • ${design.labelWidth || 100}x${design.labelHeight || 50}mm</small>`;
                    infoDiv.className = 'alert alert-success';
                } else {
                    infoDiv.innerHTML = '<small class="text-muted">Henüz tasarım seçilmedi</small>';
                    infoDiv.className = 'alert alert-light';
                }
            }
        }
        
        // Get selected products
        function getSelectedProducts() {
            const selectedProducts = [];
            
            // labelQueue'dan ürünleri al (global değişken)
            if (labelQueue && labelQueue.length > 0) {
                labelQueue.forEach(item => {
                    for (let i = 0; i < (item.quantity || 1); i++) {
                        selectedProducts.push({
                            barcode: item.barcode,
                            model_code: item.model_id,
                            color: item.color,
                            size: item.size
                        });
                    }
                });
            }
            
            // Arama sonuçlarından da kontrol et
            document.querySelectorAll('.product-item input[type="checkbox"]:checked, .variant-item input[type="checkbox"]:checked').forEach(checkbox => {
                const productRow = checkbox.closest('.product-item, .variant-item');
                if (productRow) {
                    const barcode = productRow.querySelector('.barcode')?.textContent || 
                                   productRow.dataset.barcode || '';
                    const modelId = productRow.querySelector('.model-id')?.textContent || 
                                   productRow.dataset.modelId || '';
                    const color = productRow.querySelector('.color')?.textContent || 
                                 productRow.dataset.color || '';
                    const size = productRow.querySelector('.size')?.textContent || 
                                productRow.dataset.size || '';
                    const quantity = parseInt(productRow.querySelector('.quantity-input')?.value) || 1;
                    
                    for (let i = 0; i < quantity; i++) {
                        selectedProducts.push({
                            barcode: barcode,
                            model_code: modelId,
                            color: color,
                            size: size
                        });
                    }
                }
            });
            
            console.log('Selected products:', selectedProducts);
            return selectedProducts;
        }
        
        // Generate preview with selected design
        function generatePreviewWithSavedDesign() {
            if (!selectedDesignForPrint) {
                showAlert('Lütfen önce kaydedilen tasarımlardan birini seçin', 'warning');
                showSavedDesigns();
                return;
            }
            
            const selectedProducts = getSelectedProducts();
            console.log('Label queue:', labelQueue);
            console.log('Selected products for preview:', selectedProducts);
            
            if (selectedProducts.length === 0) {
                showAlert(`Lütfen yazdırılacak ürünleri ekleyin! Kuyrukta ${labelQueue.length} ürün var.`, 'warning');
                return;
            }
            
            showAlert(`${selectedProducts.length} ürün için önizleme oluşturuluyor...`, 'info');
            generateLabelWithDesign(selectedDesignForPrint, selectedProducts);
        }
        
        // Print with selected design
        function printWithSelectedDesign() {
            if (!selectedDesignForPrint) {
                showAlert('Lütfen önce kaydedilen tasarımlardan birini seçin', 'warning');
                showSavedDesigns();
                return;
            }
            
            const selectedProducts = getSelectedProducts();
            console.log('Label queue for print:', labelQueue);
            
            if (selectedProducts.length === 0) {
                showAlert(`Ürün seçili değil! Etiket kuyruğunda ${labelQueue.length} ürün var. Lütfen ürün arayıp "Ekle" butonuna basın.`, 'warning');
                return;
            }
            
            // Önce önizleme oluştur, sonra yazdır
            showAlert(`${selectedProducts.length} etiket yazdırılıyor...`, 'info');
            generateLabelWithDesign(selectedDesignForPrint, selectedProducts);
        }
        
        function showAlert(message, type) {
            console.log(`${type}: ${message}`);
            alert(message);
        }
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        function addToQueue(barcode, modelId, color, size) {
            const existingIndex = labelQueue.findIndex(item => item.barcode === barcode);
            if (existingIndex >= 0) {
                labelQueue[existingIndex].quantity++;
            } else {
                labelQueue.push({ barcode, model_id: modelId, color, size, quantity: 1 });
            }
            updateLabelQueue();
            showAlert('Etiket kuyruğa eklendi', 'success');
        }
        
        function updateLabelQueue() {
            const container = document.getElementById('labelQueue');
            const countBadge = document.getElementById('labelCount');
            countBadge.textContent = labelQueue.length;
            
            if (labelQueue.length === 0) {
                container.innerHTML = `<div class="text-center text-muted py-4"><i class="fas fa-inbox fa-3x mb-3 opacity-50"></i><p>Henüz etiket eklenmedi</p></div>`;
                return;
            }
            
            container.innerHTML = labelQueue.map((item, index) => `
                <div class="label-item">
                    <div class="label-info">
                        <div class="label-model">${item.model_id} - ${item.color}</div>
                        <div class="label-details">Beden: ${item.size} | Barkod: ${item.barcode}</div>
                    </div>
                    <div class="quantity-control">
                        <button class="quantity-btn" onclick="changeQuantity(${index}, -1)">-</button>
                        <input type="number" class="quantity-input" value="${item.quantity}" min="1" onchange="setQuantity(${index}, this.value)">
                        <button class="quantity-btn" onclick="changeQuantity(${index}, 1)">+</button>
                    </div>
                    <button class="btn-remove" onclick="removeFromQueue(${index})"><i class="fas fa-trash"></i></button>
                </div>
            `).join('');
        }
        
        function changeQuantity(index, change) {
            if (labelQueue[index]) {
                labelQueue[index].quantity = Math.max(1, labelQueue[index].quantity + change);
                updateLabelQueue();
            }
        }
        
        function setQuantity(index, value) {
            if (labelQueue[index]) {
                labelQueue[index].quantity = Math.max(1, parseInt(value) || 1);
                updateLabelQueue();
            }
        }
        
        function removeFromQueue(index) {
            labelQueue.splice(index, 1);
            updateLabelQueue();
            showAlert('Etiket kuyruktan çıkarıldı', 'success');
        }
        
        function displaySearchResults(products) {
            const container = document.getElementById('searchResults');
            if (products.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-4"><p>Ürün bulunamadı</p></div>';
                return;
            }
            
            container.innerHTML = products.map(product => `
                <div class="product-card">
                    <div class="product-header">${product.model_id} - ${product.color}</div>
                    ${product.variants.map(variant => `
                        <div class="variant-item">
                            <div class="variant-info">
                                <div class="variant-size">Beden: ${variant.size}</div>
                                <div class="variant-stock">Stok: ${variant.quantity} | Barkod: ${variant.barcode}</div>
                            </div>
                            <button class="btn-add-label" onclick="addToQueue('${variant.barcode}', '${product.model_id}', '${product.color}', '${variant.size}')">
                                <i class="fas fa-plus"></i> Ekle
                            </button>
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }
        
        async function searchProducts() {
            const searchType = document.getElementById('searchType').value;
            const query = document.getElementById('searchQuery').value.trim();
            
            if (!query) {
                showAlert('Lütfen arama sorgusu girin', 'danger');
                return;
            }
            
            showLoading(true);
            try {
                const response = await fetch(`/api/search_products_for_label?search_type=${searchType}&query=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (data.success) {
                    displaySearchResults(data.products);
                } else {
                    showAlert(data.message, 'danger');
                    document.getElementById('searchResults').innerHTML = '';
                }
            } catch (error) {
                showAlert('Arama sırasında hata oluştu', 'danger');
                console.error('Search error:', error);
            } finally {
                showLoading(false);
            }
        }
        
        function getCustomSettings() {
            // Güvenli element erişimi - varsayılan değerlerle
            const getElementValue = (id, defaultValue) => {
                try {
                    const element = document.getElementById(id);
                    return element && element.value !== undefined && element.value !== '' ? element.value : defaultValue;
                } catch (e) {
                    console.warn(`Element ${id} not found, using default:`, defaultValue);
                    return defaultValue;
                }
            };
            
            const getElementIntValue = (id, defaultValue) => {
                try {
                    const element = document.getElementById(id);
                    if (element && element.value !== undefined && element.value !== '') {
                        const intValue = parseInt(element.value);
                        return isNaN(intValue) ? defaultValue : intValue;
                    }
                    return defaultValue;
                } catch (e) {
                    console.warn(`Element ${id} not found, using default:`, defaultValue);
                    return defaultValue;
                }
            };
            
            return {
                title_text: getElementValue('titleText', 'GÜLLÜ'),
                title_font_size: getElementIntValue('titleFontSize', 24),
                title_position_y: getElementIntValue('titlePositionY', 10),
                image_size: getElementIntValue('imageSize', 80),
                image_position_x: getElementIntValue('imagePositionX', 10),
                image_position_y: getElementIntValue('imagePositionY', 50),
                qr_size: getElementIntValue('qrSize', 80),
                qr_position_x: getElementValue('qrPositionX', 'right'),
                qr_position_y: getElementIntValue('qrPositionY', 50),
                info_font_size: getElementIntValue('infoFontSize', 18),
                small_font_size: getElementIntValue('smallFontSize', 14)
            };
        }
        
        // Test function for detailed settings
        function testDetailedSettings() {
            console.log('Testing detailed settings...');
            const settings = getCustomSettings();
            console.log('Current settings:', settings);
            showAlert('Detaylı ayarlar başarıyla yüklendi', 'success');
        }
        
        async function generatePreview() {
            if (labelQueue.length === 0) {
                showAlert('Önizleme için etiket ekleyin', 'danger');
                return;
            }
            
            showLoading(true);
            const firstLabel = labelQueue[0];
            const labelWidth = parseInt(document.getElementById('labelWidth').value);
            const labelHeight = parseInt(document.getElementById('labelHeight').value);
            const settings = getCustomSettings();
            
            try {
                const response = await fetch('/api/generate_label_preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        barcode: firstLabel.barcode,
                        model_id: firstLabel.model_id,
                        color: firstLabel.color,
                        size: firstLabel.size,
                        label_width: labelWidth,
                        label_height: labelHeight,
                        settings: settings
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    document.getElementById('previewArea').innerHTML = `<img src="${data.image}" class="preview-image" alt="Etiket Önizlemesi">`;
                } else {
                    showAlert(data.message, 'danger');
                }
            } catch (error) {
                showAlert('Önizleme oluşturulurken hata oluştu', 'danger');
                console.error('Preview error:', error);
            } finally {
                showLoading(false);
            }
        }
        
        async function printLabels() {
            if (labelQueue.length === 0) {
                showAlert('Yazdırılacak etiket yok', 'danger');
                return;
            }
            
            showLoading(true);
            const labelWidth = parseInt(document.getElementById('labelWidth').value);
            const labelHeight = parseInt(document.getElementById('labelHeight').value);
            const labelsPerRow = parseInt(document.getElementById('labelsPerRow').value);
            const labelsPerCol = parseInt(document.getElementById('labelsPerCol').value);
            const settings = getCustomSettings();
            
            const expandedLabels = [];
            labelQueue.forEach(item => {
                for (let i = 0; i < item.quantity; i++) {
                    expandedLabels.push({
                        barcode: item.barcode,
                        model_id: item.model_id,
                        color: item.color,
                        size: item.size
                    });
                }
            });
            
            try {
                const response = await fetch('/api/print_labels', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        labels: expandedLabels,
                        paper_size: 'a4',
                        labels_per_row: labelsPerRow,
                        labels_per_col: labelsPerCol,
                        label_width: labelWidth,
                        label_height: labelHeight,
                        settings: settings
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`
                        <html>
                        <head>
                            <title>Ürün Etiketleri - Yazdır</title>
                            <style>
                                body { margin: 0; padding: 20px; }
                                img { max-width: 100%; height: auto; }
                                @media print { body { margin: 0; padding: 0; } img { width: 100%; } }
                            </style>
                        </head>
                        <body>
                            <img src="${data.image}" alt="Ürün Etiketleri">
                            <script>window.onload = function() { window.print(); }<\/script>
                        </body>
                        </html>
                    `);
                } else {
                    showAlert(data.message, 'danger');
                }
            } catch (error) {
                showAlert('Yazdırma hazırlanırken hata oluştu', 'danger');
                console.error('Print error:', error);
            } finally {
                showLoading(false);
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize label queue as global
            window.labelQueue = [];
            
            document.getElementById('searchBtn').addEventListener('click', searchProducts);
            document.getElementById('searchQuery').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchProducts();
            });
            
            const urlParams = new URLSearchParams(window.location.search);
            const initialBarcode = urlParams.get('barcode');
            const initialModel = urlParams.get('model');
            const initialColor = urlParams.get('color');
            const initialSize = urlParams.get('size');
            
            if (initialBarcode && initialModel && initialColor && initialSize) {
                addToQueue(initialBarcode, initialModel, initialColor, initialSize);
                document.getElementById('searchType').value = 'barcode';
                document.getElementById('searchQuery').value = initialBarcode;
            }
            
            updateSelectedDesignInfo(null);
        });
        // Show saved designs
        function showSavedDesigns() {
            const saved = JSON.parse(localStorage.getItem('labelDesigns') || '[]');
            const container = document.getElementById('savedDesignsList');
            
            if (saved.length === 0) {
                container.innerHTML = '<p class="text-muted">Henüz kaydedilen tasarım yok</p>';
            } else {
                let html = '';
                saved.forEach((design, index) => {
                    const date = new Date(design.date).toLocaleDateString('tr-TR');
                    html += `
                        <div class="border rounded p-3 mb-2">
                            <h6>${design.name}</h6>
                            <small class="text-muted">${date} - ${design.elements.length} element</small><br>
                            <small class="text-muted">Boyut: ${design.labelWidth || 100}mm x ${design.labelHeight || 50}mm</small>
                            <br>
                            <button class="btn btn-primary btn-sm mt-2" onclick="selectDesignForPrint(${index})">
                                <i class="fas fa-check"></i> Bu Tasarımı Seç
                            </button>
                            <button class="btn btn-success btn-sm mt-2 ms-1" onclick="useDesignForPrint(${index})">
                                <i class="fas fa-print"></i> Direkt Yazdır
                            </button>
                            <small class="text-muted d-block mt-1">* Seçili ürün bilgileri kullanılacak</small>
                        </div>
                    `;
                });
                container.innerHTML = html;
            }
            
            new bootstrap.Modal(document.getElementById('savedDesignsModal')).show();
        }
        
        // Select design for printing (don't close modal)
        function selectDesignForPrint(index) {
            const saved = JSON.parse(localStorage.getItem('labelDesigns') || '[]');
            selectedDesignForPrint = saved[index];
            if (selectedDesignForPrint) {
                bootstrap.Modal.getInstance(document.getElementById('savedDesignsModal')).hide();
                updateSelectedDesignInfo(selectedDesignForPrint);
                showAlert(`Tasarım "${selectedDesignForPrint.name}" seçildi. Artık önizleme ve yazdırma yapabilirsiniz.`, 'success');
            }
        }

        // Use saved design for printing
        function useDesignForPrint(index) {
            const saved = JSON.parse(localStorage.getItem('labelDesigns') || '[]');
            const design = saved[index];
            if (!design) return;
            
            // Seçilen ürün bilgilerini kontrol et - hem search results hem de label queue'dan al
            const selectedProducts = [];
            
            // Label queue'dan ürünleri al
            if (window.labelQueue && window.labelQueue.length > 0) {
                window.labelQueue.forEach(item => {
                    selectedProducts.push({
                        barcode: item.barcode,
                        model_code: item.model_id,
                        color: item.color,
                        size: item.size
                    });
                });
            }
            
            // Arama sonuçlarından seçili ürünleri de al
            document.querySelectorAll('.product-item input[type="checkbox"]:checked').forEach(checkbox => {
                const productRow = checkbox.closest('.product-item');
                if (productRow) {
                    const barcode = productRow.querySelector('.barcode')?.textContent || '';
                    const modelId = productRow.querySelector('.model-id')?.textContent || '';
                    const color = productRow.querySelector('.color')?.textContent || '';
                    const size = productRow.querySelector('.size')?.textContent || '';
                    const quantity = parseInt(productRow.querySelector('.quantity-input')?.value) || 1;
                    
                    for (let i = 0; i < quantity; i++) {
                        selectedProducts.push({
                            barcode: barcode,
                            model_code: modelId,
                            color: color,
                            size: size
                        });
                    }
                }
            });
            
            if (selectedProducts.length === 0) {
                alert('Lütfen önce yazdırılacak ürünleri ekleyin! (Arama yapıp ürün seçin veya manuel ekleyin)');
                return;
            }
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('savedDesignsModal')).hide();
            
            // Generate preview with saved design and selected products
            generateLabelWithDesign(design, selectedProducts);
        }

        // Generate label with saved design
        function generateLabelWithDesign(design, selectedProducts) {
            if (!selectedProducts || selectedProducts.length === 0) {
                alert('Ürün bilgileri bulunamadı!');
                return;
            }
            
            const data = {
                width: design.labelWidth || 100,
                height: design.labelHeight || 50,
                elements: design.elements,
                product_data: selectedProducts[0] // İlk ürünü önizleme için kullan
            };
            
            showLoading(true);
            
            fetch('/enhanced_product_label/api/generate_advanced_label_preview', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                showLoading(false);
                if (data.success) {
                    // Show preview
                    document.getElementById('previewArea').innerHTML = `
                        <img src="${data.preview_url}" class="preview-image" alt="Label Preview">
                    `;
                    const productInfo = selectedProducts[0];
                    showAlert(`Tasarım "${design.name}" ile ${selectedProducts.length} etiket hazırlandı\nÖrnek: ${productInfo.model_code} - ${productInfo.color} - ${productInfo.size}`, 'success');
                } else {
                    showAlert('Hata: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                showLoading(false);
                showAlert('Bağlantı hatası: ' + error.message, 'danger');
            });
        }
    </script>
</body>
</html>