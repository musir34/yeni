<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gelişmiş Ürün Etiketi - Güllü Shoes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .section-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .section-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }
        
        .search-container {
            display: flex;
            gap: 12px;
            align-items: end;
            flex-wrap: wrap;
        }
        
        .form-field {
            flex: 1;
            min-width: 200px;
        }
        
        .btn-search {
            background: linear-gradient(135deg, #3498db, #2980b9);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-search:hover {
            background: linear-gradient(135deg, #2980b9, #21618c);
            transform: translateY(-1px);
        }
        
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }
        
        .product-card {
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            padding: 16px;
            background: #f8f9fa;
            transition: all 0.3s;
        }
        
        .product-card:hover {
            border-color: #3498db;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
        }
        
        .product-header {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            text-align: center;
            font-weight: 600;
        }
        
        .variant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 4px 0;
            background: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        
        .variant-info {
            flex: 1;
        }
        
        .variant-size {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .variant-stock {
            font-size: 0.9em;
            color: #7f8c8d;
        }
        
        .btn-add-label {
            background: linear-gradient(135deg, #27ae60, #229954);
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            color: white;
            font-size: 0.9em;
            transition: all 0.3s;
        }
        
        .btn-add-label:hover {
            background: linear-gradient(135deg, #229954, #1e8449);
            transform: scale(1.05);
        }
        
        .label-queue {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .label-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .label-info {
            flex: 1;
        }
        
        .label-model {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .label-details {
            font-size: 0.9em;
            color: #7f8c8d;
        }
        
        .quantity-control {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0 12px;
        }
        
        .quantity-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            background: #ecf0f1;
            color: #2c3e50;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .quantity-btn:hover {
            background: #bdc3c7;
        }
        
        .quantity-input {
            width: 60px;
            text-align: center;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            padding: 4px;
        }
        
        .btn-remove {
            background: #e74c3c;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            color: white;
            font-size: 0.9em;
            transition: all 0.3s;
        }
        
        .btn-remove:hover {
            background: #c0392b;
        }
        
        .size-settings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin: 20px 0;
        }
        
        .preset-sizes {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }
        
        .size-preset {
            padding: 8px 16px;
            background: #ecf0f1;
            border: none;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .size-preset:hover {
            background: #3498db;
            color: white;
        }
        
        .preview-area {
            border: 2px dashed #bdc3c7;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fafafa;
        }
        
        .preview-image {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .action-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .btn-primary-action {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border: none;
            padding: 12px 32px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            font-size: 1.1em;
            transition: all 0.3s;
        }
        
        .btn-primary-action:hover {
            background: linear-gradient(135deg, #c0392b, #a93226);
            transform: translateY(-2px);
        }
        
        .btn-secondary-action {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            border: none;
            padding: 12px 32px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-secondary-action:hover {
            background: linear-gradient(135deg, #7f8c8d, #6c7b7d);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert {
            border-radius: 8px;
            border: none;
            padding: 16px;
            margin: 16px 0;
        }
        
        .alert-success {
            background: linear-gradient(135deg, #d5f4e6, #c3e9d0);
            color: #155724;
        }
        
        .alert-danger {
            background: linear-gradient(135deg, #f8d7da, #f1b0b7);
            color: #721c24;
        }
        
        .page-header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            text-align: center;
        }
        
        .page-title {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
        }
        
        .page-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-top: 8px;
        }
    </style>
</head>
<body style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh;">
    <div class="main-container">
        <!-- Sayfa Başlığı -->
        <div class="page-header">
            <h1 class="page-title">
                <i class="fas fa-tags"></i>
                Gelişmiş Ürün Etiketi
            </h1>
            <p class="page-subtitle">QR kodlu, logolu ve özelleştirilebilir ürün etiketleri</p>
        </div>

        <!-- Ürün Arama -->
        <div class="section-card">
            <h2 class="section-title">
                <i class="fas fa-search"></i>
                Ürün Ara
            </h2>
            <div class="search-container">
                <div class="form-field">
                    <label class="form-label">Arama Tipi</label>
                    <select id="searchType" class="form-select">
                        <option value="model">Model Kodu</option>
                        <option value="barcode">Barkod</option>
                    </select>
                </div>
                <div class="form-field">
                    <label class="form-label">Arama Sorgusu</label>
                    <input type="text" id="searchQuery" class="form-control" placeholder="Model kodu veya barkod girin...">
                </div>
                <button id="searchBtn" class="btn btn-search">
                    <i class="fas fa-search"></i>
                    Ara
                </button>
            </div>
            
            <div id="searchResults" class="product-grid"></div>
        </div>

        <!-- Etiket Kuyruğu -->
        <div class="section-card">
            <h2 class="section-title">
                <i class="fas fa-list"></i>
                Yazdırılacak Etiketler
                <span id="labelCount" class="badge bg-primary ms-2">0</span>
            </h2>
            <div id="labelQueue" class="label-queue">
                <div class="text-center text-muted py-4">
                    <i class="fas fa-inbox fa-3x mb-3 opacity-50"></i>
                    <p>Henüz etiket eklenmedi</p>
                </div>
            </div>
        </div>

        <!-- Etiket Ayarları -->
        <div class="section-card">
            <h2 class="section-title">
                <i class="fas fa-cog"></i>
                Etiket Ayarları
            </h2>
            
            <div class="size-settings">
                <div>
                    <label class="form-label">Etiket Genişliği (mm)</label>
                    <input type="number" id="labelWidth" class="form-control" value="100" min="50" max="200">
                </div>
                <div>
                    <label class="form-label">Etiket Yüksekliği (mm)</label>
                    <input type="number" id="labelHeight" class="form-control" value="50" min="30" max="150">
                </div>
            </div>
            
            <div class="preset-sizes">
                <strong>Hızlı Boyutlar:</strong>
                <button class="size-preset" data-width="100" data-height="50">100x50mm</button>
                <button class="size-preset" data-width="80" data-height="50">80x50mm</button>
                <button class="size-preset" data-width="80" data-height="40">80x40mm</button>
                <button class="size-preset" data-width="60" data-height="40">60x40mm</button>
                <button class="size-preset" data-width="120" data-height="60">120x60mm</button>
            </div>
            
            <div class="row mt-3">
                <div class="col-md-6">
                    <label class="form-label">Sayfa Başına Etiket (Satır)</label>
                    <input type="number" id="labelsPerRow" class="form-control" value="3" min="1" max="6">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Sayfa Başına Etiket (Sütun)</label>
                    <input type="number" id="labelsPerCol" class="form-control" value="7" min="1" max="12">
                </div>
            </div>
        </div>

        <!-- Önizleme -->
        <div class="section-card">
            <h2 class="section-title">
                <i class="fas fa-eye"></i>
                Etiket Önizlemesi
            </h2>
            <div id="previewArea" class="preview-area">
                <div class="text-muted">
                    <i class="fas fa-image fa-3x mb-3 opacity-50"></i>
                    <p>Önizleme için etiket ekleyin ve "Önizleme Oluştur" butonuna tıklayın</p>
                </div>
            </div>
            
            <div class="action-buttons">
                <button id="previewBtn" class="btn btn-secondary-action">
                    <i class="fas fa-eye"></i>
                    Önizleme Oluştur
                </button>
                <button id="printBtn" class="btn btn-primary-action">
                    <i class="fas fa-print"></i>
                    Yazdır
                </button>
            </div>
            
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>İşlem devam ediyor...</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let labelQueue = [];
        
        // Arama
        document.getElementById('searchBtn').addEventListener('click', searchProducts);
        document.getElementById('searchQuery').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') searchProducts();
        });
        
        // Hızlı boyut seçimi
        document.querySelectorAll('.size-preset').forEach(btn => {
            btn.addEventListener('click', function() {
                document.getElementById('labelWidth').value = this.dataset.width;
                document.getElementById('labelHeight').value = this.dataset.height;
            });
        });
        
        // Önizleme ve yazdırma
        document.getElementById('previewBtn').addEventListener('click', generatePreview);
        document.getElementById('printBtn').addEventListener('click', printLabels);
        
        async function searchProducts() {
            const searchType = document.getElementById('searchType').value;
            const query = document.getElementById('searchQuery').value.trim();
            
            if (!query) {
                showAlert('Lütfen arama sorgusu girin', 'danger');
                return;
            }
            
            showLoading(true);
            
            try {
                const response = await fetch(`/api/search_products_for_label?search_type=${searchType}&query=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (data.success) {
                    displaySearchResults(data.products);
                } else {
                    showAlert(data.message, 'danger');
                    document.getElementById('searchResults').innerHTML = '';
                }
            } catch (error) {
                showAlert('Arama sırasında hata oluştu', 'danger');
            } finally {
                showLoading(false);
            }
        }
        
        function displaySearchResults(products) {
            const container = document.getElementById('searchResults');
            
            if (products.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-4"><p>Ürün bulunamadı</p></div>';
                return;
            }
            
            container.innerHTML = products.map(product => `
                <div class="product-card">
                    <div class="product-header">
                        ${product.model_id} - ${product.color}
                    </div>
                    ${product.variants.map(variant => `
                        <div class="variant-item">
                            <div class="variant-info">
                                <div class="variant-size">Beden: ${variant.size}</div>
                                <div class="variant-stock">Stok: ${variant.quantity} | Barkod: ${variant.barcode}</div>
                            </div>
                            <button class="btn-add-label" onclick="addToQueue('${variant.barcode}', '${product.model_id}', '${product.color}', '${variant.size}')">
                                <i class="fas fa-plus"></i>
                                Ekle
                            </button>
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }
        
        function addToQueue(barcode, modelId, color, size) {
            const existingIndex = labelQueue.findIndex(item => item.barcode === barcode);
            
            if (existingIndex >= 0) {
                labelQueue[existingIndex].quantity++;
            } else {
                labelQueue.push({
                    barcode: barcode,
                    model_id: modelId,
                    color: color,
                    size: size,
                    quantity: 1
                });
            }
            
            updateLabelQueue();
            showAlert('Etiket kuyruğa eklendi', 'success');
        }
        
        function updateLabelQueue() {
            const container = document.getElementById('labelQueue');
            const countBadge = document.getElementById('labelCount');
            
            countBadge.textContent = labelQueue.length;
            
            if (labelQueue.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-3x mb-3 opacity-50"></i>
                        <p>Henüz etiket eklenmedi</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = labelQueue.map((item, index) => `
                <div class="label-item">
                    <div class="label-info">
                        <div class="label-model">${item.model_id} - ${item.color}</div>
                        <div class="label-details">Beden: ${item.size} | Barkod: ${item.barcode}</div>
                    </div>
                    <div class="quantity-control">
                        <button class="quantity-btn" onclick="changeQuantity(${index}, -1)">-</button>
                        <input type="number" class="quantity-input" value="${item.quantity}" min="1" 
                               onchange="setQuantity(${index}, this.value)">
                        <button class="quantity-btn" onclick="changeQuantity(${index}, 1)">+</button>
                    </div>
                    <button class="btn-remove" onclick="removeFromQueue(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }
        
        function changeQuantity(index, change) {
            if (labelQueue[index]) {
                labelQueue[index].quantity = Math.max(1, labelQueue[index].quantity + change);
                updateLabelQueue();
            }
        }
        
        function setQuantity(index, value) {
            if (labelQueue[index]) {
                labelQueue[index].quantity = Math.max(1, parseInt(value) || 1);
                updateLabelQueue();
            }
        }
        
        function removeFromQueue(index) {
            labelQueue.splice(index, 1);
            updateLabelQueue();
            showAlert('Etiket kuyruktan çıkarıldı', 'success');
        }
        
        async function generatePreview() {
            if (labelQueue.length === 0) {
                showAlert('Önizleme için etiket ekleyin', 'danger');
                return;
            }
            
            showLoading(true);
            
            // Sadece ilk etiketi önizleme olarak göster
            const firstLabel = labelQueue[0];
            const labelWidth = parseInt(document.getElementById('labelWidth').value);
            const labelHeight = parseInt(document.getElementById('labelHeight').value);
            
            try {
                const response = await fetch('/api/generate_label_preview', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        barcode: firstLabel.barcode,
                        model_id: firstLabel.model_id,
                        color: firstLabel.color,
                        size: firstLabel.size,
                        label_width: labelWidth,
                        label_height: labelHeight
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('previewArea').innerHTML = 
                        `<img src="${data.image}" class="preview-image" alt="Etiket Önizlemesi">`;
                } else {
                    showAlert(data.message, 'danger');
                }
            } catch (error) {
                showAlert('Önizleme oluşturulurken hata oluştu', 'danger');
            } finally {
                showLoading(false);
            }
        }
        
        async function printLabels() {
            if (labelQueue.length === 0) {
                showAlert('Yazdırılacak etiket yok', 'danger');
                return;
            }
            
            showLoading(true);
            
            const labelWidth = parseInt(document.getElementById('labelWidth').value);
            const labelHeight = parseInt(document.getElementById('labelHeight').value);
            const labelsPerRow = parseInt(document.getElementById('labelsPerRow').value);
            const labelsPerCol = parseInt(document.getElementById('labelsPerCol').value);
            
            // Etiketleri adet sayısına göre çoğalt
            const expandedLabels = [];
            labelQueue.forEach(item => {
                for (let i = 0; i < item.quantity; i++) {
                    expandedLabels.push({
                        barcode: item.barcode,
                        model_id: item.model_id,
                        color: item.color,
                        size: item.size
                    });
                }
            });
            
            try {
                const response = await fetch('/api/print_labels', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        labels: expandedLabels,
                        paper_size: 'a4',
                        labels_per_row: labelsPerRow,
                        labels_per_col: labelsPerCol,
                        label_width: labelWidth,
                        label_height: labelHeight
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Yeni pencerede yazdırma sayfası aç
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`
                        <html>
                        <head>
                            <title>Ürün Etiketleri - Yazdır</title>
                            <style>
                                body { margin: 0; padding: 20px; }
                                img { max-width: 100%; height: auto; }
                                @media print {
                                    body { margin: 0; padding: 0; }
                                    img { width: 100%; }
                                }
                            </style>
                        </head>
                        <body>
                            <img src="${data.image}" alt="Ürün Etiketleri">
                            <script>
                                window.onload = function() {
                                    window.print();
                                }
                            </script>
                        </body>
                        </html>
                    `);
                } else {
                    showAlert(data.message, 'danger');
                }
            } catch (error) {
                showAlert('Yazdırma hazırlanırken hata oluştu', 'danger');
            } finally {
                showLoading(false);
            }
        }
        
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
                ${message}
            `;
            
            document.querySelector('.main-container').insertBefore(alertDiv, document.querySelector('.section-card'));
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
    </script>
</body>
</html>