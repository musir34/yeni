<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Haftalık Üretim Önerisi</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    input,button,select{padding:8px 10px;font-size:14px}
    .card{border:1px solid #e5e7eb;border-radius:10px;padding:12px;margin:10px 0}
    .badge{padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #e5e7eb}
    .muted{color:#6b7280}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;font-size:14px}
    th{background:#fafafa}
    img{height:48px;width:48px;object-fit:cover;border-radius:6px;border:1px solid #eee}
  </style>
</head>
<body>
  <h2>Haftalık Üretim Önerisi</h2>

  <div class="row">
    <input id="models" placeholder="Modeller (ör: gll012,gll088)" style="min-width:320px">
    <input id="days" type="number" min="1" value="7" title="Kaç gün">
    <input id="cover" type="number" step="0.5" value="14" title="Min cover (gün)">
    <input id="sf" type="number" step="0.05" value="0.10" title="Safety factor">
    <label><input id="onlypos" type="checkbox" checked> sadece pozitif</label>
    <button id="btn">Hesapla</button>
  </div>

  <div id="out"></div>

  <script>
    async function run(){
      const models = document.getElementById('models').value.trim();
      if(!models){ alert('Model(ler) gir'); return; }
      const payload = {
        models: models.split(',').map(s=>s.trim()).filter(Boolean),
        days: +document.getElementById('days').value || 7,
        min_cover_days: +document.getElementById('cover').value || 14,
        safety_factor: +document.getElementById('sf').value || 0.10,
        only_positive: document.getElementById('onlypos').checked
      };
      const res = await fetch('/api/uretim-oneri-haftalik', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      render(data);
    }

    function render(data){
      const out = document.getElementById('out');
      if(!data.ok){ out.innerHTML = '<p class="muted">Hata/boş sonuç</p>'; return; }
      if(!data.groups?.length){ out.innerHTML = '<p class="muted">Sonuç yok</p>'; return; }
      out.innerHTML = data.groups.map(g => {
        const head = `
          <div class="card">
            <div class="row" style="justify-content:space-between">
              <div><strong>${g.model}</strong>
                <span class="badge">toplam öneri: ${g.total_suggest}</span>
              </div>
              ${g.image ? `<img src="${g.image}" alt="">` : ''}
            </div>
            ${g.colors.map(c => `
              <div style="margin-top:6px"><strong>${c.renk}</strong></div>
              <table>
                <thead><tr>
                  <th>Barkod</th><th>Beden</th><th>Satış (${data.days}g)</th>
                  <th>Stok</th><th>Günlük Ort.</th><th>Kalan Gün</th><th>Öneri</th>
                </tr></thead>
                <tbody>
                ${c.items.map(it => `
                  <tr>
                    <td>${it.barcode}</td>
                    <td>${it.beden}</td>
                    <td>${it.sold_last_days}</td>
                    <td>${it.stok}</td>
                    <td>${it.avg_daily}</td>
                    <td>${it.days_left ?? '-'}</td>
                    <td><strong>${it.suggest_qty}</strong></td>
                  </tr>
                `).join('')}
                </tbody>
              </table>
            `).join('')}
          </div>
        `;
        return head;
      }).join('');
    }

    document.getElementById('btn').addEventListener('click', run);
  </script>
</body>
</html>
