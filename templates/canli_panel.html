<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <title>üìä Canlƒ± Satƒ±≈ü & Stok Paneli</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{
      --color-primary:#B76E79; --color-primary-dark:#A05F6A;
      --color-secondary:#212529; --color-text:#343a40; --color-bg:#f8f9fa;
      --color-white:#fff; --color-border:#dee2e6; --color-success:#28a745;
      --color-warning:#ffc107; --color-danger:#dc3545; --color-info:#0dcaf0;
      --font-family-base:'Inter',sans-serif; --border-radius:.5rem;
      --shadow-sm:0 1px 3px rgba(0,0,0,.04); --shadow-md:0 5px 15px rgba(0,0,0,.08);
      --transition:all .25s ease-in-out;
    }
    *{box-sizing:border-box}
    body{margin:16px;background:var(--color-bg);color:var(--color-text);font-family:var(--font-family-base)}
    .ust{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:16px}
    .zaman{font-size:13px;color:#6c757d}
    .arama{display:flex;gap:8px;align-items:center}
    input[type=text],.btn{padding:10px 12px;border:1px solid var(--color-border);border-radius:var(--border-radius);background:var(--color-white);color:var(--color-secondary);box-shadow:var(--shadow-sm)}
    .btn{cursor:pointer;transition:var(--transition)}
    .btn:hover{border-color:var(--color-primary);color:var(--color-primary)}
    .btn-primary{background:var(--color-primary);color:#fff;border-color:var(--color-primary)}
    .btn-primary:hover{background:var(--color-primary-dark);border-color:var(--color-primary-dark)}
    .mini{font-size:12px;color:#6c757d}

    .panel-top{display:grid;grid-template-columns:1fr 2fr;gap:16px;margin-bottom:16px}
    .kpi{background:var(--color-white);border:1px solid var(--color-border);border-radius:var(--border-radius);padding:16px;box-shadow:var(--shadow-md);display:flex;flex-direction:column;gap:6px}
    .kpi .title{font-size:13px;color:#6c757d}
    .kpi .value{font-size:28px;font-weight:800;color:var(--color-secondary)}
    .chartbox{background:var(--color-white);border:1px solid var(--color-border);border-radius:var(--border-radius);padding:16px;box-shadow:var(--shadow-md)}

    .kartlar{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:16px}
    .kart{background:var(--color-white);border:1px solid var(--color-border);border-radius:calc(var(--border-radius) + 2px);padding:16px;position:relative;box-shadow:var(--shadow-md);transition:var(--transition)}
    .kart:hover{transform:translateY(-2px);box-shadow:0 10px 24px rgba(0,0,0,.12)}
    .kart.uyari{border-color:#ffe8a1;box-shadow:0 0 0 2px rgba(255,193,7,.15)}
    .ribbon{position:absolute;top:12px;right:12px;background:var(--color-warning);color:#212529;font-weight:700;padding:4px 10px;border-radius:999px;font-size:11px;letter-spacing:.3px;box-shadow:var(--shadow-sm)}

    /* BA≈ûLIK YOK ‚Üí sadece √ßiplerle model/renk ve butonlar */
    .meta{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    .chip{display:inline-flex;align-items:center;gap:8px;background:#fff;border:1px solid var(--color-border);color:var(--color-secondary);padding:6px 10px;border-radius:999px;font-size:12px;box-shadow:var(--shadow-sm)}
    .chip .dot{width:8px;height:8px;border-radius:50%;background:var(--color-primary);box-shadow:0 0 0 3px rgba(183,110,121,.18)}
    .ghost{border:1px dashed var(--color-border);background:transparent;margin-left:auto}
    .ghost:hover{border-color:var(--color-primary);color:var(--color-primary)}

    .media{margin-bottom:12px;border-radius:12px;overflow:hidden;border:1px solid var(--color-border)}
    .media img{display:block;width:100%;height:220px;object-fit:cover;cursor:pointer}

    .istat{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:10px 0 8px}
    .kutu{border:1px solid var(--color-border);border-radius:var(--border-radius);padding:12px;background:#fff;box-shadow:var(--shadow-sm)}
    .kutu .etik{font-size:12px;color:#6c757d;margin-bottom:4px}
    .kutu .deger{font-size:20px;font-weight:800;color:var(--color-secondary)}
    .kutu.ok{border-color:rgba(40,167,69,.25)}
    .kutu.warn{border-color:rgba(255,193,7,.45)}

    .bar{height:10px;background:#f1f3f5;border-radius:999px;border:1px solid var(--color-border);overflow:hidden}
    .bar > i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--color-primary),var(--color-primary-dark));transition:width .6s ease}

    .detay{display:none;margin-top:12px}
    table{width:100%;border-collapse:collapse;border:1px solid var(--color-border);border-radius:10px;overflow:hidden;background:#fff}
    th,td{padding:10px;border-top:1px solid var(--color-border);text-align:left}
    thead th{background:#f1f3f5;color:#6c757d;font-weight:600}
    tbody tr:hover{background:#fafafa}

    /* Lightbox */
    .lightbox{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:9999}
    .lightbox img{max-width:92vw;max-height:92vh;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.4)}
    .nav{display:flex;gap:8px;align-items:center;margin-bottom:12px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="ust">
    <div class="nav">
      <a class="btn" href="/">üè† Anasayfa</a>
    </div>
    <div class="zaman" id="zaman">Y√ºkleniyor‚Ä¶</div>
    <div class="arama">
      <input id="filtreModel" type="text" placeholder="Model filtresi (√∂rn: 099)">
      <button class="btn btn-primary" id="uygulaBtn">Uygula</button>
      <span class="mini">JSON: <code>/api/canli/ozet?model=099</code></span>
    </div>
  </div>

  <div class="panel-top">
    <div class="kpi"><div class="title">Bug√ºn Toplam Satƒ±≈ü (Adet)</div><div class="value" id="kpiToplam">0</div></div>
    <div class="chartbox"><canvas id="grafikTop"></canvas></div>
  </div>

  <div class="kartlar" id="kartlar"></div>
  <div class="lightbox" id="lightbox"><img id="lightImg" alt=""></div>

  <script>
  const elZaman=document.getElementById('zaman'), elKartlar=document.getElementById('kartlar');
  const inpModel=document.getElementById('filtreModel'), btnUygula=document.getElementById('uygulaBtn'), elKpi=document.getElementById('kpiToplam');

  const ctx=document.getElementById('grafikTop').getContext('2d');
  const chart=new Chart(ctx,{type:'bar',data:{labels:[],datasets:[{label:'Bug√ºn Satƒ±≈ü (adet)',data:[],backgroundColor:'rgba(183,110,121,0.45)',borderColor:'#B76E79',borderWidth:1}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{precision:0}}}}});

  function bedenSirala(b){const t=String(b??'').replace(',','.');const n=Number(t);return Number.isFinite(n)?[0,n]:[1,String(b??'')];}
  function yuzde(a,b){if(!b)return 0;const p=Math.max(0,Math.min(100,Math.round((a/b)*100)));return p;}
  function formatTL(x){const n=Number(x)||0;return n.toLocaleString('tr-TR',{style:'currency',currency:'TRY',minimumFractionDigits:2,maximumFractionDigits:2});}

  function render(kartlar,ts,toplam){
    elZaman.textContent='G√ºncellendi: '+ts; elKpi.textContent=toplam??0;

    const top=[...kartlar].sort((a,b)=>b.toplam_siparis_bugun-a.toplam_siparis_bugun).slice(0,10);
    chart.data.labels=top.map(k=>`${k.model} ${k.renk}`); chart.data.datasets[0].data=top.map(k=>k.toplam_siparis_bugun); chart.update();

    elKartlar.innerHTML='';
    kartlar.forEach((k,idx)=>{
      const div=document.createElement('div'); div.className='kart'+(k.dusuk_stok?' uyari':'');
      const detayId='detay-'+idx;

      const cap=k.toplam_stok+k.toplam_siparis_bugun; const pct=yuzde(k.toplam_stok,cap||k.toplam_stok||1);
      const avg=formatTL(k.ortalama_fiyat);

      div.innerHTML=`
        ${k.dusuk_stok?'<span class="ribbon">D√ú≈û√úK STOK</span>':''}
        <div class="meta">
          <span class="chip">${k.model ?? '-'}</span>
          <span class="chip"><span class="dot"></span>${k.renk ?? '-'}</span>
          <button class="btn ghost" data-target="${detayId}">Detay</button>
        </div>

        ${k.image?`<div class="media"><img class="card-img" src="${k.image}" alt="${k.model ?? ''} ${k.renk ?? ''}"></div>`:''}

        <div class="istat">
          <div class="kutu"><div class="etik">Bug√ºn Toplam Sipari≈ü (Gider)</div><div class="deger">${k.toplam_siparis_bugun}</div></div>
          <div class="kutu ${k.dusuk_stok?'warn':'ok'}"><div class="etik">G√ºncel Stok</div><div class="deger">${k.toplam_stok}</div></div>
          <div class="kutu"><div class="etik">Ortalama Fiyat</div><div class="deger">${avg}</div></div>
        </div>

        <div class="bar" title="Stok doluluk"><i style="width:${pct}%"></i></div>

        <div class="detay" id="${detayId}">
          <table>
            <thead><tr><th>Beden</th><th>Bug√ºn</th><th>Stok</th></tr></thead>
            <tbody>
              ${[...k.detay].sort((a,b)=>{const A=bedenSirala(a.beden),B=bedenSirala(b.beden);return A[0]-B[0]||A[1]-B[1];}).map(d=>`
                <tr><td>${d.beden ?? '-'}</td><td>${d.siparis}</td><td>${d.stok}</td></tr>
              `).join('')}
            </tbody>
          </table>
        </div>`;
      elKartlar.appendChild(div);
    });

    elKartlar.querySelectorAll('.btn.ghost').forEach(btn=>{
      btn.onclick=()=>{const id=btn.getAttribute('data-target');const d=document.getElementById(id);const acik=d.style.display==='block';d.style.display=acik?'none':'block';btn.textContent='Detay';};
    });

    // Lightbox
    elKartlar.querySelectorAll('.card-img').forEach(img=>{
      img.onclick=()=>{const lb=document.getElementById('lightbox');const li=document.getElementById('lightImg');li.src=img.getAttribute('src');lb.style.display='flex';};
    });
  }

  document.getElementById('lightbox').onclick=(e)=>{if(e.target.id==='lightbox'||e.target.id==='lightImg'){e.currentTarget.style.display='none';}};

  async function yukle(model){
    const u=model?`/api/canli/ozet?model=${encodeURIComponent(model)}`:'/api/canli/ozet';
    const r=await fetch(u); const j=await r.json(); render(j.kartlar,j.guncellendi,j.toplam_satis);
  }
  btnUygula.onclick=()=>{const m=inpModel.value.trim(); startSSE(m); yukle(m);};

  let ev=null;
  function startSSE(model){
    if(ev){ev.close();ev=null;}
    const url='/api/canli/akis'+(model?`?model=${encodeURIComponent(model)}`:'');
    ev=new EventSource(url);
    ev.onmessage=(e)=>{try{const j=JSON.parse(e.data); render(j.kartlar,j.guncellendi,j.toplam_satis);}catch(err){console.error(err);}};
  }

  startSSE(''); yukle('');
  </script>
</body>
</html>
