<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Kod Etiketi Oluştur - Güllü Ayakkabı</title>
<style>
body {
display: flex;
flex-direction: column;
justify-content: flex-start;
align-items: center;
min-height: 100vh;
margin: 0;
padding-top: 20px;
background-color: #f4f4f4;
font-family: Arial, sans-serif;
}

.form-container {
width: 400px;
background-color: white;
padding: 20px;
border-radius: 8px;
box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
margin-bottom: 20px;
}

.form-container h2,
.form-container h3,
.form-container h4 {
text-align: center;
margin-bottom: 10px;
color: #333;
}
.form-container h4 {
margin-top: 15px;
margin-bottom: 5px;
text-align: left;
}
.form-section {
margin-bottom: 15px;
padding-bottom: 10px;
border-bottom: 1px solid #eee;
}
.form-section:last-child {
border-bottom: none;
margin-bottom: 0;
padding-bottom: 0;
}


input,
select {
width: 100%;
padding: 10px;
margin-bottom: 10px;
border: 1px solid #ccc;
border-radius: 4px;
font-size: 16px;
box-sizing: border-box;
}
input[type="number"] {
-moz-appearance: textfield;
}
input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button {
-webkit-appearance: none;
margin: 0;
}

input[readonly] {
background-color: #e9ecef;
cursor: not-allowed;
}

label {
font-size: 14px;
display: block;
margin-bottom: 3px;
color: #555;
}

button {
width: 100%;
padding: 10px 15px;
color: white;
border: none;
border-radius: 4px;
font-size: 16px;
cursor: pointer;
transition: background-color 0.3s;
margin-top: 10px;
}
#prepare-preview-button { background-color: #28a745; }
#prepare-preview-button:hover { background-color: #218838; }
#execute-print-button { background-color: #007bff; margin-top: 5px; }
#execute-print-button:hover { background-color: #0056b3; }
#execute-print-button:disabled { background-color: #555; cursor: not-allowed;}


.label-container {
width: 60mm;
height: 40mm;
background-color: white;
display: flex;
border: 1px solid black;
box-sizing: border-box;
overflow: hidden;
margin-bottom: 10px;
}

.paper-a4-fixed {
width: 210mm; height: 297mm; border: 1px solid #ccc; padding: 0; /* Screen preview için padding, printte @page marginleri kullanılacak */
}
.paper-100x100 { width: 100mm; height: 100mm; }

.multi-label-container-custom, #multi-label-container-fixed-a4 {
display: flex;
flex-wrap: wrap;
justify-content: flex-start;
align-items: flex-start;
width: 100%; height: 100%;
box-sizing: border-box;
overflow: auto; /* Screen preview için scroll */
}
#multi-label-container-fixed-a4 { display: grid; }

.label-item {
border: 0.2mm solid #ddd;
background-color: white;
box-sizing: border-box;
display: flex;
flex-direction: row; /* Ensures label-item-fixed-a4-content is handled in a row, though it usually fills the item */
align-items: center;
overflow: hidden;
}

/* Single Label Preview - Main Structure for QR left, Info Right */
#single-label-content-wrapper {
display: flex; /* Arranges children (QR area, Text area) in a row by default */
flex-direction: row; /* Explicitly set: QR+Barcode left, Product Info right */
align-items: center; /* Vertically aligns the left and right blocks if they have different natural heights */
width: 100%; height: 100%; padding: 1.5mm; box-sizing: border-box;
}
/* QR Code and its Barcode Text Area (Left Block in Single Preview) */
#single-label-content-wrapper .qr-and-barcode-area {
display: flex; /* Arranges children (QR image, Barcode text) vertically */
flex-direction: column; /* Stacks QR image on top of its text */
align-items: center; /* Centers QR image and its text horizontally within this block */
justify-content: center; /* Centers QR image and its text vertically within this block */
flex-shrink: 0; /* Prevents this block from shrinking if space is tight */
margin-right: 3mm; /* Space between QR block and Text Area */
}
#single-label-content-wrapper .qr-area {
display: flex; justify-content: center; align-items: center; margin-bottom: 1mm; /* Space between QR image and its text */
}
#single-label-content-wrapper .qr-area img {
max-width: 100%; max-height: 100%; object-fit: contain;
}
#single-label-content-wrapper .barcode-text-under-qr {
text-align: center; word-break: break-all; max-width: 100%;
overflow: hidden; font-weight: bold;
}
/* Product Info Text Area (Right Block in Single Preview) */
#single-label-content-wrapper .text-area {
flex-grow: 1; /* Takes up remaining space next to the QR block */
height: 100%; display: flex; flex-direction: column;
justify-content: center; /* Vertically centers the product info lines */
text-align: left; /* Aligns product info text to the left */
overflow: hidden; padding-right: 1.5mm;
}
#single-label-content-wrapper .product-info div { margin-bottom: 2mm; line-height: 1.2; }
#single-label-content-wrapper .product-info .label { font-weight: bold; margin-right: 1mm; }
#single-label-content-wrapper .product-info .value { font-weight: normal; }

/* Multi-Label Item - Main Structure for QR left, Info Right (inside each label-item) */
.label-item-fixed-a4-content {
display: flex; /* Arranges children (.left, .right) in a row by default */
flex-direction: row; /* Explicitly set: .left (QR) and .right (Info) side-by-side */
width: 100%; height: 100%; padding: 1mm; box-sizing: border-box;
}
/* Left part of the multi-label item (QR and its barcode text) */
.label-item-fixed-a4-content .left {
/* width is set dynamically in JS (e.g., 40% or 50%) */
display: flex; flex-direction: column; align-items: center; justify-content: center;
box-sizing: border-box;
}
/* Right part of the multi-label item (Product Info) */
.label-item-fixed-a4-content .right {
/* width is set dynamically in JS (e.g., 60% or 50%) */
display: flex; flex-direction: column; justify-content: center;
text-align: left; /* Product info text aligned to the left */
box-sizing: border-box;
}
.label-item-fixed-a4-content img.qr-code-clone {
/* max-width: 18mm; max-height: 18mm; */ /* Boyut getLabelHTML'de dinamik */
margin-bottom: 1mm; object-fit: contain;
}
.label-item-fixed-a4-content .barcode-text-clone {
text-align: center; font-weight: bold; word-break: break-all; line-height: 1.2;
}
.label-item-fixed-a4-content .info-clone {
margin-bottom: 1.5mm; font-weight: 600; line-height: 1.2; text-align: left;
}
.label-item-fixed-a4-content .info-clone .label { font-weight: bold; }
.label-item-fixed-a4-content .info-clone .value { font-weight: normal; }

.nav-buttons { display: flex; justify-content: center; width: 100%; margin-top: 20px; gap:15px; }
.nav-buttons a { text-decoration: none; color: white; background-color: #007bff; padding: 10px 15px; border-radius: 4px; font-size: 16px; text-align: center; transition: background-color 0.3s; }
.nav-buttons a:hover { background-color: #0056b3; }

.no-print { /* Yazdırmada gizlenecek elemanlar için genel sınıf */ }
</style>
</head>

<body>

<div class="form-container no-print">
<div class="form-section">
<h2>Etiket Bilgileri</h2>
<div style="display: flex; align-items: center; margin-bottom: 10px;">
<input type="text" id="model-input" placeholder="Model Kodu" required style="flex: 1; margin-bottom: 0;">
<button type="button" id="search-model-btn" style="width: auto; margin: 0 0 0 10px; padding: 10px; background-color: #28a745;">Model Ara</button>
</div>

<select id="color-select" style="display: none; margin-bottom: 10px;">
<option value="">-- Renk Seçiniz --</option>
</select>

<div id="sizes-container" style="display: none; margin-bottom: 15px;">
<div style="font-weight: bold; margin-bottom: 8px;">Bedenler</div>
<div id="size-boxes" style="display: flex; flex-wrap: wrap; gap: 10px;">
</div>
</div>

<div style="display: flex; align-items: center; margin-top: 10px;">
<input type="text" id="barcode-input" placeholder="Barkod" readonly style="flex: 1; margin-bottom: 0;">
<input type="number" id="quantity-input" placeholder="Adet" value="1" min="1" style="width: 80px; margin: 0 0 0 10px;">
</div>

<button type="button" id="preview-all-btn" style="display: none; background-color: #007bff; margin-top: 10px;">QR Kodları Oluştur ve Önizle</button>

<div id="barcode-list" style="margin-top: 15px; max-height: 150px; overflow-y: auto; display: none;">
<h4>Yazdırılacak Barkodlar</h4>
<table style="width: 100%; border-collapse: collapse;">
<thead>
<tr style="border-bottom: 1px solid #ddd;">
<th style="text-align: left; padding: 5px;">Barkod</th>
<th style="text-align: left; padding: 5px;">Model</th>
<th style="text-align: left; padding: 5px;">Renk</th>
<th style="text-align: left; padding: 5px;">Beden</th>
<th style="text-align: center; padding: 5px;">Adet</th>
<th style="text-align: center; padding: 5px;">İşlem</th>
</tr>
</thead>
<tbody id="barcode-list-body">
</tbody>
</table>
</div>
</div>
<div class="form-section">
<label for="label-count" style="font-weight:bold; font-size:16px;">Toplam Etiket Sayısı:</label>
<input type="number" id="label-count" value="0" min="0" max="500" readonly>
</div>

<div class="form-section">
<h3>Kağıt/Etiket Ayarları</h3>
<select id="paper-type" onchange="updateCustomFields()">
<option value="custom">Özel Boyut (Tek Etiket)</option>
<option value="60x40" selected>Etiket - 60x40mm (Tek)</option>
<option value="100x100">Etiket - 100x100mm (Tek)</option>
<option value="a4_fixed">A4 Standart (3x7 Etiket)</option>
<option value="custom_multi">Özel Sayfa (Çoklu Etiket)</option>
</select>

<div id="custom-size-fields-single" style="display: none;">
<h4>Tek Etiket Boyutları (mm)</h4>
<input type="number" id="single-label-width-input" placeholder="Genişlik" value="60" onchange="updateSingleLabelSize()">
<input type="number" id="single-label-height-input" placeholder="Yükseklik" value="40" onchange="updateSingleLabelSize()">
</div>

<div id="custom-page-size-fields-multi" style="display: none;">
<h4>Sayfa Boyutları (mm)</h4>
<input type="number" id="multi-page-width-input" placeholder="Sayfa Genişliği" value="210" onchange="handleMultiPageDimensionChange()">
<input type="number" id="multi-page-height-input" placeholder="Sayfa Yüksekliği" value="297" onchange="handleMultiPageDimensionChange()">
</div>

<div id="multi-label-layout-settings" style="display: none; margin-top: 10px;">
<h4>Çoklu Etiket Yerleşim Ayarları (mm)</h4>
<div style="display: flex; gap: 10px;">
<div style="flex: 1;">
<label for="multi-label-width">Etiket Genişliği:</label>
<input type="number" id="multi-label-width" value="60" onchange="calculateCustomMultiLabelLayout()">
</div>
<div style="flex: 1;">
<label for="multi-label-height">Etiket Yüksekliği:</label>
<input type="number" id="multi-label-height" value="40" onchange="calculateCustomMultiLabelLayout()">
</div>
</div>
<h4 style="margin-top: 15px; margin-bottom: 5px;">Sayfa Kenar Boşlukları (mm)</h4>
<div style="display: flex; gap: 10px;">
<div style="flex: 1;"><label for="margin-top">Üst:</label><input type="number" id="margin-top" value="10" min="0" onchange="calculateCustomMultiLabelLayout()"></div>
<div style="flex: 1;"><label for="margin-bottom">Alt:</label><input type="number" id="margin-bottom" value="10" min="0" onchange="calculateCustomMultiLabelLayout()"></div>
</div>
<div style="display: flex; gap: 10px; margin-top: 5px;">
<div style="flex: 1;"><label for="margin-left">Sol:</label><input type="number" id="margin-left" value="10" min="0" onchange="calculateCustomMultiLabelLayout()"></div>
<div style="flex: 1;"><label for="margin-right">Sağ:</label><input type="number" id="margin-right" value="10" min="0" onchange="calculateCustomMultiLabelLayout()"></div>
</div>
<h4 style="margin-top: 15px; margin-bottom: 5px;">Etiketler Arası Boşluklar (mm)</h4>
<div style="display: flex; gap: 10px;">
<div style="flex: 1;"><label for="horizontal-gap">Yatay:</label><input type="number" id="horizontal-gap" value="5" min="0" onchange="calculateCustomMultiLabelLayout()"></div>
<div style="flex: 1;"><label for="vertical-gap">Dikey:</label><input type="number" id="vertical-gap" value="5" min="0" onchange="calculateCustomMultiLabelLayout()"></div>
</div>
</div>
<div id="a4-fixed-info" style="display:none; padding:10px; background-color:#eef; border-radius:4px; margin-top:10px; font-size:14px;">
{/* A4_INFO_PLACEHOLDER */}
</div>
</div>
<div class="form-section">
<h4>Görsel & Yazı Ayarları</h4>
<div>
<label for="qr-code-size-input">QR Kodu Boyutu (mm): <small>(A4 Standart hariç)</small></label>
<input type="number" id="qr-code-size-input" value="25" min="10" max="100" onchange="updateVisualSettings()">
</div>
<div>
<label for="barcode-font-size-input">QR Altı Barkod Fontu (pt):</label>
<input type="number" id="barcode-font-size-input" value="10" min="4" max="36" onchange="updateVisualSettings()">
</div>
<div>
<label for="info-font-size-input">Ürün Bilgisi Fontu (pt):</label>
<input type="number" id="info-font-size-input" value="11" min="4" max="36" onchange="updateVisualSettings()">
</div>
</div>

<button type="button" id="prepare-preview-button" onclick="generateAndPreparePreview()">Etiketi Hazırla & Önizle</button>
</div>

<div class="label-container" id="main-label-preview-area">
<div id="single-label-container" style="display:flex; width:100%; height:100%;">
<div id="single-label-content-wrapper">
<div class="qr-and-barcode-area">
<div class="qr-area">
<img id="qr-code-image-main" src="https://via.placeholder.com/100x100?text=QR" alt="QR Kod Placeholder">
</div>
<div class="barcode-text-under-qr" id="barcode-text-main">BARKOD</div>
</div>
<div class="text-area">
<div class="product-info">
<div><span class="label">Model:</span> <span class="value" id="model-value-main">MODEL</span></div>
<div><span class="label">Renk:</span> <span class="value" id="color-value-main">RENK</span></div>
<div><span class="label">Beden:</span> <span class="value" id="size-value-main">BEDEN</span></div>
</div>
</div>
</div>
</div>
<div id="multi-label-container-custom" style="display: none; width:100%; height:100%;"></div>
<div id="multi-label-container-fixed-a4" style="display: none; width:100%; height:100%;"></div>
</div>
<button type="button" id="execute-print-button" class="no-print" onclick="executePrint()" style="margin-top: 10px; width:210mm; max-width: 90%; display:none;">Önizlemeyi Yazdır</button>


<div class="nav-buttons no-print" style="width:210mm; max-width: 90%;">
<a href="/">Ana Sayfa</a>
<a href="/product_list">Ürün Listesi</a>
</div>

<script>
const A4_FIXED_CONFIG = {
PAGE_WIDTH: 210,
MARGIN_LEFT: 8,
MARGIN_RIGHT: 8,
COLUMN_GAP: 2,
COLUMNS: 3,
PAGE_HEIGHT: 297,
MARGIN_TOP: 15,
MARGIN_BOTTOM: 15,
ROW_GAP: 1,
ROWS: 7,
LABELS_PER_PAGE: 21,
QR_SIZE_MM: 18,
LABEL_WIDTH_APPROX: ((210 - 8 - 8 - (2 * 2)) / 3),
// Taşma sorununu azaltmak için etiket yüksekliğinden 0.08mm çalıyoruz.
LABEL_HEIGHT_APPROX: (Math.floor(((297 - 15 - 15 - (7 - 1) * 1) / 7) * 100) / 100) - 0.08
};

let currentQrSize = 25;
let currentBarcodeFont = 10;
let currentInfoFont = 13; // Default 13pt olarak kalmış, formda 11pt idi. Tutarlılık için formdaki değerle eşleşebilir.
let barcodeList = [];
let productData = {};
let selectedModel = '';
let selectedColor = '';
let selectedSize = '';

window.onload = function() {
currentQrSize = parseFloat(document.getElementById('qr-code-size-input').value) || 25;
currentBarcodeFont = parseFloat(document.getElementById('barcode-font-size-input').value) || 10;
currentInfoFont = parseFloat(document.getElementById('info-font-size-input').value) || 11; // Formdaki varsayılan değerle eşleştirildi.
updateCustomFields();
document.getElementById('search-model-btn').addEventListener('click', searchModel);
document.getElementById('color-select').addEventListener('change', handleColorSelect);

const urlParams = new URLSearchParams(window.location.search);
const paper = urlParams.get('paper');
if (paper) {
document.getElementById('paper-type').value = paper;
updateCustomFields();
}
updateTotalLabelCount();
updateBarcodeList();
const a4InfoDiv = document.getElementById('a4-fixed-info');
if (a4InfoDiv) {
a4InfoDiv.innerHTML = `A4 Standart Modu: Sayfada ${A4_FIXED_CONFIG.COLUMNS}x${A4_FIXED_CONFIG.ROWS} (${A4_FIXED_CONFIG.LABELS_PER_PAGE} adet) etiket basılır.<br>
Etiket Boyutu: ~${A4_FIXED_CONFIG.LABEL_WIDTH_APPROX.toFixed(2)}mm x ~${A4_FIXED_CONFIG.LABEL_HEIGHT_APPROX.toFixed(2)}mm.<br>
Sayfa Kenar Boşlukları (Üst/Alt/Sol/Sağ): ${A4_FIXED_CONFIG.MARGIN_TOP}mm / ${A4_FIXED_CONFIG.MARGIN_BOTTOM}mm / ${A4_FIXED_CONFIG.MARGIN_LEFT}mm / ${A4_FIXED_CONFIG.MARGIN_RIGHT}mm.<br>
Bu ayarlar sabittir. "Toplam Etiket Sayısı" genel listedeki tüm etiketlerin sayısını gösterir.`;
}
};

function searchModel() {
const modelCode = document.getElementById('model-input').value.trim();
if (!modelCode) { alert('Lütfen bir model kodu giriniz.'); return; }
selectedModel = modelCode;
fetch(`/product_label/get_product_details/${modelCode}`)
.then(response => response.json())
.then(data => {
if (!data.success) { alert(data.message || 'Ürün bulunamadı.'); return; }
productData = data.data || {};
if (productData && typeof productData === 'object') {
updateColorOptions(Object.keys(productData));
} else {
console.error('Geçersiz ürün verisi:', productData);
alert('Ürün verisi alınamadı.');
document.getElementById('color-select').innerHTML = '<option value="">-- Renk Seçiniz --</option>';
}
document.getElementById('color-select').style.display = 'block';
document.getElementById('color-select').value = "";
document.getElementById('sizes-container').style.display = 'none';
document.getElementById('preview-all-btn').style.display = 'none';
})
.catch(error => { console.error('Model arama hatası:', error); alert('Model aranırken bir hata oluştu.'); });
}

function updateColorOptions(colors) {
const colorSelect = document.getElementById('color-select');
while (colorSelect.options.length > 1) { colorSelect.remove(1); }
colors.forEach(color => {
const option = document.createElement('option');
option.value = color; option.textContent = color;
colorSelect.appendChild(option);
});
}

function handleColorSelect() {
const selectedColorValue = document.getElementById('color-select').value;
const sizesContainer = document.getElementById('sizes-container');
const previewAllBtn = document.getElementById('preview-all-btn');
if (!selectedColorValue) {
sizesContainer.style.display = 'none'; previewAllBtn.style.display = 'none';
document.getElementById('barcode-input').value = ''; selectedColor = '';
return;
}
selectedColor = selectedColorValue;
if (productData && productData[selectedColorValue]) {
createSizeBoxes(Object.keys(productData[selectedColorValue]));
sizesContainer.style.display = 'block'; previewAllBtn.style.display = 'block';
} else {
console.warn(`'${selectedColorValue}' için ürün verisi bulunamadı veya productData tanımsız.`);
sizesContainer.style.display = 'none'; previewAllBtn.style.display = 'none';
}
document.getElementById('barcode-input').value = '';
}

function createSizeBoxes(sizes) {
const sizeBoxesContainer = document.getElementById('size-boxes');
sizeBoxesContainer.innerHTML = '';
sizes.sort((a, b) => (parseFloat(a) || a) - (parseFloat(b) || b));
sizes.forEach(size => {
const barcode = productData[selectedColor][size];
const sizeBox = document.createElement('div');
sizeBox.style.cssText = 'border: 1px solid #ccc; border-radius: 4px; padding: 8px; min-width: 80px; text-align:center;';
const sizeInfo = document.createElement('div');
sizeInfo.textContent = size; sizeInfo.style.cssText = 'font-weight: bold; margin-bottom: 5px;';
const quantityInput = document.createElement('input');
quantityInput.type = 'number'; quantityInput.min = '0'; quantityInput.value = '0';
quantityInput.style.cssText = 'width: 100%; padding: 4px; box-sizing: border-box;';
quantityInput.dataset.barcode = barcode; quantityInput.dataset.size = size;
quantityInput.addEventListener('focus', function() {
document.getElementById('barcode-input').value = this.dataset.barcode;
selectedSize = this.dataset.size;
});
sizeBox.appendChild(sizeInfo); sizeBox.appendChild(quantityInput);
sizeBoxesContainer.appendChild(sizeBox);
});
}

window.addEventListener('DOMContentLoaded', function() {
document.getElementById('preview-all-btn').addEventListener('click', function() {
let newItemsAdded = false;
document.querySelectorAll('#size-boxes input[type="number"]').forEach(input => {
const quantity = parseInt(input.value);
if (quantity > 0) {
barcodeList.push({
barcode: input.dataset.barcode, model: selectedModel,
color: selectedColor, size: input.dataset.size, quantity: quantity
});
newItemsAdded = true;
}
});
if (!newItemsAdded && barcodeList.length === 0) { alert('Lütfen en az bir beden için miktar giriniz.'); return; }
if (newItemsAdded || barcodeList.length > 0) {
updateBarcodeList(); updateTotalLabelCount(); generateAndPreparePreview();
}
});
});

function updateBarcodeList() {
const listBody = document.getElementById('barcode-list-body');
listBody.innerHTML = '';
barcodeList.forEach((item, index) => {
const row = document.createElement('tr');
row.style.borderBottom = '1px solid #eee';
row.innerHTML = `
<td style="padding: 5px;">${item.barcode}</td> <td style="padding: 5px;">${item.model}</td>
<td style="padding: 5px;">${item.color}</td> <td style="padding: 5px;">${item.size}</td>
<td style="padding: 5px; text-align: center;">${item.quantity}</td>
<td style="padding: 5px; text-align: center;">
<button onclick="removeBarcode(${index})" style="background-color: #dc3545; padding: 2px 5px; font-size: 12px;">Sil</button>
</td>`;
listBody.appendChild(row);
});
document.getElementById('barcode-list').style.display = barcodeList.length > 0 ? 'block' : 'none';
}

function removeBarcode(index) {
if (index >= 0 && index < barcodeList.length) {
barcodeList.splice(index, 1);
updateBarcodeList(); updateTotalLabelCount();
if (barcodeList.length === 0) {
populateMainLabelPreview(null, null, null, null);
document.getElementById('multi-label-container-fixed-a4').innerHTML = '';
document.getElementById('multi-label-container-custom').innerHTML = '';
document.getElementById('execute-print-button').style.display = 'none';
} else { generateAndPreparePreview(); }
}
}

function updateTotalLabelCount() {
document.getElementById('label-count').value = barcodeList.reduce((total, item) => total + item.quantity, 0);
}

function updateVisualSettings() {
currentQrSize = parseFloat(document.getElementById('qr-code-size-input').value) || 25;
currentBarcodeFont = parseFloat(document.getElementById('barcode-font-size-input').value) || 10;
currentInfoFont = parseFloat(document.getElementById('info-font-size-input').value) || 11;
applyVisualsToSingleLabelPreview();
if (barcodeList.length > 0) { generateAndPreparePreview(); }
}

function applyVisualsToSingleLabelPreview() {
const qrArea = document.querySelector('#single-label-content-wrapper .qr-area');
const qrAndBarcodeArea = document.querySelector('#single-label-content-wrapper .qr-and-barcode-area');
const barcodeTextElem = document.getElementById('barcode-text-main');
const textArea = document.querySelector('#single-label-content-wrapper .text-area');
if(qrArea && qrAndBarcodeArea) {
const paperType = document.getElementById('paper-type').value;
let effectiveQrSize = (paperType === 'a4_fixed') ? A4_FIXED_CONFIG.QR_SIZE_MM : currentQrSize;
qrArea.style.width = effectiveQrSize + 'mm'; qrArea.style.height = effectiveQrSize + 'mm';
qrAndBarcodeArea.style.width = (effectiveQrSize + 5) + 'mm';
}
if(barcodeTextElem) barcodeTextElem.style.fontSize = currentBarcodeFont + 'pt';
if(textArea) textArea.style.fontSize = currentInfoFont + 'pt';
}

function populateMainLabelPreview(barcode, model, color, size) {
document.getElementById('barcode-text-main').textContent = barcode || "BARKOD";
document.getElementById('model-value-main').textContent = model || "MODEL";
document.getElementById('color-value-main').textContent = color || "RENK";
document.getElementById('size-value-main').textContent = size || "BEDEN";
const qrImgMain = document.getElementById('qr-code-image-main');
if (barcode) {
qrImgMain.src = `/product_label/generate_qr?data=${encodeURIComponent(barcode)}&t=${new Date().getTime()}`;
} else {
qrImgMain.src = "https://via.placeholder.com/100x100?text=QR";
}
applyVisualsToSingleLabelPreview();
}

function updateCustomFields() {
const paperType = document.getElementById('paper-type').value;
const mainPreviewArea = document.getElementById('main-label-preview-area');
document.getElementById('single-label-container').style.display = 'none';
document.getElementById('multi-label-container-custom').style.display = 'none';
document.getElementById('multi-label-container-fixed-a4').style.display = 'none';
document.getElementById('custom-size-fields-single').style.display = 'none';
document.getElementById('custom-page-size-fields-multi').style.display = 'none';
document.getElementById('multi-label-layout-settings').style.display = 'none';
document.getElementById('a4-fixed-info').style.display = 'none';
mainPreviewArea.classList.remove('paper-a4-fixed', 'paper-100x100');
mainPreviewArea.style.width = ''; mainPreviewArea.style.height = '';
mainPreviewArea.style.alignItems = 'center';
const qrSizeInput = document.getElementById('qr-code-size-input');

if (paperType === 'custom') {
document.getElementById('custom-size-fields-single').style.display = 'block';
document.getElementById('single-label-container').style.display = 'flex';
qrSizeInput.disabled = false; updateSingleLabelSize();
} else if (paperType === '60x40') {
document.getElementById('single-label-container').style.display = 'flex';
mainPreviewArea.style.width = '60mm'; mainPreviewArea.style.height = '40mm';
document.getElementById('single-label-width-input').value = '60';
document.getElementById('single-label-height-input').value = '40';
qrSizeInput.disabled = false;
} else if (paperType === '100x100') {
document.getElementById('single-label-container').style.display = 'flex';
mainPreviewArea.classList.add('paper-100x100');
document.getElementById('single-label-width-input').value = '100';
document.getElementById('single-label-height-input').value = '100';
qrSizeInput.disabled = false;
} else if (paperType === 'a4_fixed') {
document.getElementById('multi-label-container-fixed-a4').style.display = 'grid';
mainPreviewArea.classList.add('paper-a4-fixed');
document.getElementById('a4-fixed-info').style.display = 'block';
mainPreviewArea.style.alignItems = 'flex-start';
qrSizeInput.disabled = true;
} else if (paperType === 'custom_multi') {
document.getElementById('custom-page-size-fields-multi').style.display = 'block';
document.getElementById('multi-label-layout-settings').style.display = 'block';
document.getElementById('multi-label-container-custom').style.display = 'flex';
qrSizeInput.disabled = false; handleMultiPageDimensionChange(false);
}
applyVisualsToSingleLabelPreview();
if (barcodeList.length > 0) generateAndPreparePreview();
else updatePrintStyles();
}

function updateSingleLabelSize() {
if (document.getElementById('paper-type').value === 'custom') {
const width = document.getElementById('single-label-width-input').value;
const height = document.getElementById('single-label-height-input').value;
const previewArea = document.getElementById('main-label-preview-area');
if (width > 0) previewArea.style.width = width + 'mm';
if (height > 0) previewArea.style.height = height + 'mm';
if (barcodeList.length > 0) generateAndPreparePreview(); else updatePrintStyles();
}
}
function handleMultiPageDimensionChange(doLayout = true) {
if (document.getElementById('paper-type').value === 'custom_multi') {
const previewArea = document.getElementById('main-label-preview-area');
const pageWidth = document.getElementById('multi-page-width-input').value;
const pageHeight = document.getElementById('multi-page-height-input').value;
if (pageWidth > 0) previewArea.style.width = pageWidth + 'mm';
if (pageHeight > 0) previewArea.style.height = pageHeight + 'mm';
if (barcodeList.length > 0 && doLayout) generateAndPreparePreview();
else if (doLayout) calculateCustomMultiLabelLayout();
else updatePrintStyles();
}
}
function calculateCustomMultiLabelLayout() {
if (barcodeList.length > 0) generateAndPreparePreview();
else {
const container = document.getElementById('multi-label-container-custom');
container.innerHTML = '';
container.style.padding = `${document.getElementById('margin-top').value || 0}mm ${document.getElementById('margin-right').value || 0}mm ${document.getElementById('margin-bottom').value || 0}mm ${document.getElementById('margin-left').value || 0}mm`;
container.style.gap = `${document.getElementById('vertical-gap').value || 0}mm ${document.getElementById('horizontal-gap').value || 0}mm`;
updatePrintStyles();
}
}

function getLabelHTML(barcode, model, color, size, qrSrc, isA4Fixed = false) {
let qrSizeStyle = '';
let effectiveQrSize = isA4Fixed ? A4_FIXED_CONFIG.QR_SIZE_MM : currentQrSize;
let labelWidthForCalc = 60, labelHeightForCalc = 40;
const currentPaperType = document.getElementById('paper-type').value;

if (currentPaperType === 'custom_multi' && !isA4Fixed) {
labelWidthForCalc = parseFloat(document.getElementById('multi-label-width')?.value) || 60;
labelHeightForCalc = parseFloat(document.getElementById('multi-label-height')?.value) || 40;
} else if ( (currentPaperType === 'custom' || currentPaperType === '60x40' || currentPaperType === '100x100') && !isA4Fixed) {
labelWidthForCalc = parseFloat(document.getElementById('single-label-width-input')?.value) ||
(currentPaperType === '60x40' ? 60 : (currentPaperType === '100x100' ? 100 : 60));
labelHeightForCalc = parseFloat(document.getElementById('single-label-height-input')?.value) ||
(currentPaperType === '60x40' ? 40 : (currentPaperType === '100x100' ? 100 : 40));
}

if (!isA4Fixed) {
let maxQrBasedOnLabel = Math.min(labelWidthForCalc * 0.45, labelHeightForCalc * 0.7);
effectiveQrSize = Math.min(currentQrSize, maxQrBasedOnLabel);
}

qrSizeStyle = `width:${effectiveQrSize}mm; height:${effectiveQrSize}mm; max-width:95%; max-height:95%;`;
const marginBottom = isA4Fixed ? '1mm' : Math.min(2, labelHeightForCalc * 0.05) + 'mm';
const infoFontSizeToUse = isA4Fixed ? '9pt' : currentInfoFont + 'pt';
const barcodeFontSizeToUse = isA4Fixed ? '8pt' : currentBarcodeFont + 'pt';

// Conditional width for left and right panels
// If A4 fixed, or if QR size is relatively large for the label, use 40% for QR area, 60% for text.
// Otherwise (QR is smaller relative to label width), use 50%/50% split.
const leftPanelWidth = (isA4Fixed || (effectiveQrSize > labelWidthForCalc * 0.33)) ? '40%' : '50%';
const rightPanelWidth = (isA4Fixed || (effectiveQrSize > labelWidthForCalc * 0.33)) ? '60%' : '50%';

return `
<div class="label-item-fixed-a4-content">
<div class="left" style="width: ${leftPanelWidth}; padding-right: 1mm;">
<img class="qr-code-clone" src="${qrSrc}" alt="QR Kod ${barcode}" style="${qrSizeStyle} margin-bottom: ${marginBottom}; object-fit: contain;">
<div class="barcode-text-clone" style="font-size:${barcodeFontSizeToUse}; max-width: ${effectiveQrSize + 2}mm;">${barcode}</div>
</div>
<div class="right" style="width: ${rightPanelWidth}; padding-left: ${isA4Fixed ? '1.5mm' : '2mm'};">
<div class="info-clone" style="font-size:${infoFontSizeToUse}; margin-bottom:${marginBottom};"><span class="label">Model:</span> <span class="value model-clone">${model}</span></div>
<div class="info-clone" style="font-size:${infoFontSizeToUse}; margin-bottom:${marginBottom};"><span class="label">Renk:</span> <span class="value color-clone">${color}</span></div>
<div class="info-clone" style="font-size:${infoFontSizeToUse};"><span class="label">Beden:</span> <span class="value size-clone">${size}</span></div>
</div>
</div>`;
}

function generateAndPreparePreview() {
if (barcodeList.length === 0) {
populateMainLabelPreview(null, null, null, null);
document.getElementById('multi-label-container-fixed-a4').innerHTML = '';
document.getElementById('multi-label-container-custom').innerHTML = '';
document.getElementById('execute-print-button').style.display = 'none';
updatePrintStyles();
return;
}
const firstItemForPreview = barcodeList[0];
populateMainLabelPreview(firstItemForPreview.barcode, firstItemForPreview.model, firstItemForPreview.color, firstItemForPreview.size);
generateMultipleLabelsLayout();
updatePrintStyles();
document.getElementById('execute-print-button').style.display = 'block';
console.log("Önizleme hazırlandı/güncellendi.");
}

function generateMultipleLabelsLayout() {
const paperType = document.getElementById('paper-type').value;
document.getElementById('single-label-container').style.display = 'none';
const a4Container = document.getElementById('multi-label-container-fixed-a4');
const customMultiContainer = document.getElementById('multi-label-container-custom');
a4Container.innerHTML = ''; customMultiContainer.innerHTML = '';
a4Container.style.display = 'none'; customMultiContainer.style.display = 'none';

if (barcodeList.length === 0) {
document.getElementById('single-label-container').style.display = 'flex';
return;
}
let labelsToDisplayHtml = [];
barcodeList.forEach(item => {
for (let i = 0; i < item.quantity; i++) {
const qrSrc = `/product_label/generate_qr?data=${encodeURIComponent(item.barcode)}&t=${new Date().getTime()}`;
labelsToDisplayHtml.push(getLabelHTML(item.barcode, item.model, item.color, item.size, qrSrc, paperType === 'a4_fixed'));
}
});

if (paperType === 'a4_fixed') {
a4Container.style.display = 'grid';
a4Container.style.padding = `${A4_FIXED_CONFIG.MARGIN_TOP}mm ${A4_FIXED_CONFIG.MARGIN_RIGHT}mm ${A4_FIXED_CONFIG.MARGIN_BOTTOM}mm ${A4_FIXED_CONFIG.MARGIN_LEFT}mm`;
a4Container.style.gap = `${A4_FIXED_CONFIG.ROW_GAP}mm ${A4_FIXED_CONFIG.COLUMN_GAP}mm`;
a4Container.style.gridTemplateColumns = `repeat(${A4_FIXED_CONFIG.COLUMNS}, 1fr)`;

const displayCount = Math.min(labelsToDisplayHtml.length, A4_FIXED_CONFIG.LABELS_PER_PAGE * 2);
for (let i = 0; i < displayCount; i++) {
if (!labelsToDisplayHtml[i]) break;
const labelItem = document.createElement('div');
labelItem.className = 'label-item';
labelItem.style.height = A4_FIXED_CONFIG.LABEL_HEIGHT_APPROX.toFixed(2) + 'mm';
labelItem.innerHTML = labelsToDisplayHtml[i];
a4Container.appendChild(labelItem);
}
} else if (paperType === 'custom_multi') {
customMultiContainer.style.display = 'flex';
customMultiContainer.style.padding = `${document.getElementById('margin-top').value || 0}mm ${document.getElementById('margin-right').value || 0}mm ${document.getElementById('margin-bottom').value || 0}mm ${document.getElementById('margin-left').value || 0}mm`;
customMultiContainer.style.gap = `${document.getElementById('vertical-gap').value || 0}mm ${document.getElementById('horizontal-gap').value || 0}mm`;
const labelWidth = parseFloat(document.getElementById('multi-label-width').value) || 60;
const labelHeight = parseFloat(document.getElementById('multi-label-height').value) || 40;
labelsToDisplayHtml.forEach(labelHtml => {
const labelItem = document.createElement('div'); labelItem.className = 'label-item';
labelItem.style.width = labelWidth + 'mm'; labelItem.style.height = labelHeight + 'mm';
labelItem.innerHTML = labelHtml; customMultiContainer.appendChild(labelItem);
});
} else {
document.getElementById('single-label-container').style.display = 'flex';
}
}

function updatePrintStyles() {
let existingStyle = document.getElementById('dynamic-print-styles');
if (existingStyle) existingStyle.remove();
const style = document.createElement('style');
style.id = 'dynamic-print-styles'; document.head.appendChild(style);
const paperType = document.getElementById('paper-type').value;
let pageWidth, pageHeight, printSpecificCSS = "";
let marginTop, marginRight, marginBottom, marginLeft;

if (paperType === 'custom' || paperType === '60x40' || paperType === '100x100') {
pageWidth = (paperType === 'custom') ? (document.getElementById('single-label-width-input').value || 60) : (paperType === '60x40' ? 60 : 100);
pageHeight = (paperType === 'custom') ? (document.getElementById('single-label-height-input').value || 40) : (paperType === '60x40' ? 40 : 100);
marginTop = marginRight = marginBottom = marginLeft = "0mm";
printSpecificCSS = `
body > *:not(#main-label-preview-area):not(style):not(script) { display: none !important; }
#main-label-preview-area { display: block !important; }
#main-label-preview-area > #multi-label-container-custom,
#main-label-preview-area > #multi-label-container-fixed-a4 { display: none !important; }
#main-label-preview-area > #single-label-container { display: flex !important; }
#main-label-preview-area, #main-label-preview-area > #single-label-container {
width: ${pageWidth}mm !important; height: ${pageHeight}mm !important;
border: none !important; padding: 0 !important; margin: 0 !important;
box-sizing: border-box !important; overflow: hidden !important;
}`;
} else if (paperType === 'a4_fixed') {
pageWidth = A4_FIXED_CONFIG.PAGE_WIDTH;
pageHeight = A4_FIXED_CONFIG.PAGE_HEIGHT;
marginTop = A4_FIXED_CONFIG.MARGIN_TOP + "mm";
marginRight = A4_FIXED_CONFIG.MARGIN_RIGHT + "mm";
marginBottom = A4_FIXED_CONFIG.MARGIN_BOTTOM + "mm";
marginLeft = A4_FIXED_CONFIG.MARGIN_LEFT + "mm";

printSpecificCSS = `
body > *:not(#main-label-preview-area):not(style):not(script) { display: none !important; }
#main-label-preview-area {
display: block !important;
width: 100% !important;
height: auto !important;
overflow: visible !important;
box-sizing: border-box !important;
padding: 0 !important;
margin: 0 !important;
}
#main-label-preview-area > #single-label-container,
#main-label-preview-area > #multi-label-container-custom { display: none !important; }
#main-label-preview-area > #multi-label-container-fixed-a4 {
display: grid !important;
width: 100% !important;
height: auto !important;
overflow: visible !important;
padding: 0 !important;
box-sizing: border-box !important;
grid-template-columns: repeat(${A4_FIXED_CONFIG.COLUMNS}, 1fr) !important;
grid-auto-rows: ${A4_FIXED_CONFIG.LABEL_HEIGHT_APPROX.toFixed(2)}mm !important;
gap: ${A4_FIXED_CONFIG.ROW_GAP}mm ${A4_FIXED_CONFIG.COLUMN_GAP}mm !important;
border: none !important;
}
#main-label-preview-area > #multi-label-container-fixed-a4 .label-item {
page-break-inside: avoid !important;
border: 0.1mm solid #eee !important;
background-color: white !important;
overflow: hidden !important;
height: ${A4_FIXED_CONFIG.LABEL_HEIGHT_APPROX.toFixed(2)}mm !important;
box-sizing: border-box !important;
}`;
} else if (paperType === 'custom_multi') {
pageWidth = document.getElementById('multi-page-width-input').value || A4_FIXED_CONFIG.PAGE_WIDTH;
pageHeight = document.getElementById('multi-page-height-input').value || A4_FIXED_CONFIG.PAGE_HEIGHT;
marginTop = (document.getElementById('margin-top').value || 0) + "mm";
marginRight = (document.getElementById('margin-right').value || 0) + "mm";
marginBottom = (document.getElementById('margin-bottom').value || 0) + "mm";
marginLeft = (document.getElementById('margin-left').value || 0) + "mm";

printSpecificCSS = `
body > *:not(#main-label-preview-area):not(style):not(script) { display: none !important; }
#main-label-preview-area {
display: block !important;
width: 100% !important;
height: auto !important;
overflow: visible !important;
padding:0 !important;
margin:0 !important;
box-sizing: border-box !important;
}
#main-label-preview-area > #single-label-container,
#main-label-preview-area > #multi-label-container-fixed-a4 { display: none !important; }
#main-label-preview-area > #multi-label-container-custom {
display: flex !important;
flex-wrap: wrap !important;
width: 100% !important;
height: auto !important;
overflow: visible !important;
padding: 0 !important;
gap: ${document.getElementById('vertical-gap').value || 0}mm ${document.getElementById('horizontal-gap').value || 0}mm !important;
border: none !important;
box-sizing: border-box !important;
}
#main-label-preview-area > #multi-label-container-custom .label-item {
page-break-inside: avoid !important;
border: 0.1mm solid #eee !important;
background-color: white !important;
overflow: hidden !important;
box-sizing: border-box !important;
}`;
} else { return; }

const pageRuleMargin = `${marginTop} ${marginRight} ${marginBottom} ${marginLeft}`;

style.textContent = `
@media print {
@page {
size: ${pageWidth}mm ${pageHeight}mm;
margin: ${pageRuleMargin};
}
html, body {
width: 100% !important;
height: auto !important;
margin: 0 !important;
padding: 0 !important;
box-sizing: border-box !important;
background-color: white !important;
-webkit-print-color-adjust: exact !important;
color-adjust: exact !important;
overflow: visible !important;
}
.no-print { display: none !important; }
#execute-print-button { display: none !important; }
${printSpecificCSS}
}`;
}

async function executePrint() {
const paperType = document.getElementById('paper-type').value;
const printButton = document.getElementById('execute-print-button');

if (barcodeList.length === 0) {
alert("Yazdırılacak etiket bulunmuyor. Lütfen önce etiket ekleyin.");
return;
}

printButton.disabled = true;
printButton.textContent = 'Yazdırılıyor...';

async function getQrDataURL(barcode) {
try {
const response = await fetch(`/product_label/generate_qr?data=${encodeURIComponent(barcode)}&t=${new Date().getTime()}`);
if (!response.ok) throw new Error(`QR üretme hatası (${response.status}): ${response.statusText}`);
const blob = await response.blob();
if (!blob.type.startsWith("image/")) {
console.warn("Beklenmedik QR blob tipi:", blob.type, "Barcode:", barcode);
const errorText = await blob.text();
console.error("Sunucudan dönen QR hata metni:", errorText);
throw new Error(`QR resim formatı hatalı. Sunucu: ${errorText.substring(0,100)}`);
}
return new Promise((resolve, reject) => {
const reader = new FileReader();
reader.onloadend = () => resolve(reader.result);
reader.onerror = (err) => { console.error("FileReader hatası:", err); reject(err);};
reader.readAsDataURL(blob);
});
} catch (error) {
console.error("QR Data URL çevirme hatası (barcode: "+barcode+"):", error);
return "https://via.placeholder.com/100x100?text=QR+Hata";
}
}

try {
if (paperType === 'a4_fixed' || paperType === 'custom_multi') {
const labelPromises = [];
barcodeList.forEach(item => {
for (let i = 0; i < item.quantity; i++) {
labelPromises.push(
getQrDataURL(item.barcode).then(qrDataUrl => {
return getLabelHTML(item.barcode, item.model, item.color, item.size, qrDataUrl, paperType === 'a4_fixed');
})
);
}
});
const resolvedLabelHTMLs = await Promise.all(labelPromises);

let targetContainer;
if (paperType === 'a4_fixed') {
targetContainer = document.getElementById('multi-label-container-fixed-a4');
targetContainer.innerHTML = '';
resolvedLabelHTMLs.forEach(html => {
const labelDiv = document.createElement('div');
labelDiv.className = 'label-item';
labelDiv.innerHTML = html;
targetContainer.appendChild(labelDiv);
});
} else {
targetContainer = document.getElementById('multi-label-container-custom');
targetContainer.innerHTML = '';
const labelWidth = document.getElementById('multi-label-width').value || 60;
const labelHeight = document.getElementById('multi-label-height').value || 40;
resolvedLabelHTMLs.forEach(html => {
const labelDiv = document.createElement('div');
labelDiv.className = 'label-item';
labelDiv.style.width = labelWidth + 'mm';
labelDiv.style.height = labelHeight + 'mm';
labelDiv.innerHTML = html;
targetContainer.appendChild(labelDiv);
});
}
updatePrintStyles();
setTimeout(() => window.print(), 500);

} else if (paperType === 'custom' || paperType === '60x40' || paperType === '100x100') {
let labelWidthForPrint = (paperType === 'custom') ? (document.getElementById('single-label-width-input').value || 60) : (paperType === '60x40' ? 60 : 100);
let labelHeightForPrint = (paperType === 'custom') ? (document.getElementById('single-label-height-input').value || 40) : (paperType === '60x40' ? 40 : 100);
let allLabelsForPrintHTML_single = "";
const printPromises_single = [];

barcodeList.forEach(item => {
for (let i = 0; i < item.quantity; i++) {
printPromises_single.push(
getQrDataURL(item.barcode).then(qrDataUrl => {
const singleLabelHTMLContent = getLabelHTML(item.barcode, item.model, item.color, item.size, qrDataUrl, false);
return `<div class="label-instance-print" style="width: ${labelWidthForPrint}mm; height: ${labelHeightForPrint}mm; display: flex; align-items: center; box-sizing: border-box; page-break-after: always; overflow:hidden;">${singleLabelHTMLContent}</div>`;
})
);
}
});

const resolvedSingleLabelInstances = await Promise.all(printPromises_single);
allLabelsForPrintHTML_single = resolvedSingleLabelInstances.join('');

if (allLabelsForPrintHTML_single.length > 0) {
const lastBreak = allLabelsForPrintHTML_single.lastIndexOf('page-break-after: always;');
if (lastBreak !== -1) {
allLabelsForPrintHTML_single = allLabelsForPrintHTML_single.substring(0, lastBreak) +
allLabelsForPrintHTML_single.substring(lastBreak).replace('page-break-after: always;', 'page-break-after: auto;');
}
}

const printWindow = window.open('', '_blank');
printWindow.document.write(`
<!DOCTYPE html><html><head><title>Etiketler</title>
<style>
@page { size: ${labelWidthForPrint}mm ${labelHeightForPrint}mm; margin: 0; }
body { margin: 0; font-family: Arial, sans-serif; -webkit-print-color-adjust: exact !important; color-adjust: exact !important;}
/* Styles for label-item-fixed-a4-content when printed individually */
.label-item-fixed-a4-content { display: flex; flex-direction: row; width: 100%; height: 100%; padding: 1.5mm; box-sizing: border-box; align-items: center;}
.label-item-fixed-a4-content .left { display: flex; flex-direction: column; align-items: center; justify-content: center; padding-right: 1mm; box-sizing: border-box;}
.label-item-fixed-a4-content .right { display: flex; flex-direction: column; justify-content: center; text-align: left; padding-left: 2mm; box-sizing: border-box; flex-grow: 1;}
.label-item-fixed-a4-content img.qr-code-clone { object-fit: contain; }
.label-item-fixed-a4-content .barcode-text-clone { text-align: center; font-weight: bold; word-break: break-all; line-height: 1.2; font-size: ${currentBarcodeFont}pt;}
.label-item-fixed-a4-content .info-clone { margin-bottom: 1.5mm; font-weight: 600; line-height: 1.2; text-align: left; font-size: ${currentInfoFont}pt;}
.label-item-fixed-a4-content .info-clone .label { font-weight: bold; }
.label-item-fixed-a4-content .info-clone .value { font-weight: normal; }

/* Adjusting widths for .left and .right within the print window for single labels */
/* Using the same logic as getLabelHTML for consistency */
.label-instance-print .left {
    /* Calculate width based on currentQrSize and labelWidthForPrint, e.g. 40% or 50% */
    width: ${( (currentQrSize / parseFloat(labelWidthForPrint)) > 0.33 && parseFloat(labelWidthForPrint) > 0 ) ? '40%' : '50%'};
}
.label-instance-print .right {
    width: ${( (currentQrSize / parseFloat(labelWidthForPrint)) > 0.33 && parseFloat(labelWidthForPrint) > 0 ) ? '60%' : '50%'};
}

</style></head><body>${allLabelsForPrintHTML_single}
<script> window.onload = function() { setTimeout(function() { window.print(); setTimeout(function() { window.close(); }, 300); }, 500); }; <\/script></body></html>`);
printWindow.document.close();
}
} catch (error) {
console.error("Yazdırma sırasında hata:", error);
alert("Etiketler yazdırılırken bir hata oluştu: " + error.message);
} finally {
setTimeout(() => {
printButton.disabled = false;
printButton.textContent = 'Önizlemeyi Yazdır';
if (paperType === 'a4_fixed' || paperType === 'custom_multi') {
generateAndPreparePreview();
} else {
if(barcodeList.length > 0) {
populateMainLabelPreview(barcodeList[0].barcode, barcodeList[0].model, barcodeList[0].color, barcodeList[0].size);
} else {
populateMainLabelPreview(null, null, null, null);
}
}
}, 1000);
}
}
</script>
</body>
</html>